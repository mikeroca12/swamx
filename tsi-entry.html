<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TSI Manage Entries | MOC Toolbox</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #1b2a45;
  --frame: #223352;
  --frame-border: #2e4368;
  --surface: #e2e7ef;
  --surface2: #d9dee8;
  --surface3: #cdd3df;
  --border: #c8ceda;
  --border-strong: #b4bcc9;
  --text: #1e293b;
  --green: #16a34a;
  --green-bg: #dcfce7;
  --green-border: #86efac;
  --green-text: #15803d;
  --yellow: #d97706;
  --yellow-bg: #fef3c7;
  --yellow-border: #fcd34d;
  --yellow-text: #b45309;
  --red: #dc2626;
  --red-bg: #fee2e2;
  --red-border: #fca5a5;
  --red-text: #b91c1c;
  --blue: #2563eb;
  --blue-bg: #dbeafe;
  --blue-border: #93c5fd;
  --blue-text: #1d4ed8;
  --accent: #2563eb;
  --card-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'DM Sans',sans-serif;color:var(--text);min-height:100vh;opacity:0;transition:opacity 0.08s;}

/* Nav */
.nav-bar{background:var(--frame);border-bottom:1px solid var(--frame-border);padding:10px 24px;display:flex;align-items:center;gap:14px;font-size:14px;}
.nav-bar a{color:#ffffff;text-decoration:none;}
.nav-bar .nav-title{font-weight:700;color:#ffffff;}
.nav-bar .nav-title span{color:#3b82f6;}
.nav-bar .nav-sep{color:var(--frame-border);}
.nav-bar img{height:28px;}
.nav-logo{display:flex;align-items:center;gap:8px;}

/* Header */
.header{background:var(--frame);border-bottom:1px solid var(--frame-border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.header h1{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700;letter-spacing:-0.5px;color:#ffffff;}
.header-actions{display:flex;gap:8px;}
.hdr-btn{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;padding:6px 14px;border-radius:6px;border:1px solid var(--frame-border);background:rgba(255,255,255,0.08);color:#ffffff;cursor:pointer;transition:all 0.15s;letter-spacing:0.5px;}
.hdr-btn:hover{background:rgba(255,255,255,0.15);}
.hdr-btn.primary{background:var(--accent);border-color:var(--accent);}
.hdr-btn.primary:hover{background:#1d4ed8;}

.container{max-width:900px;margin:0 auto;padding:24px 24px 80px;}

/* Filter bar */
.fbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px;align-items:center;}
.fc{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;padding:6px 12px;border-radius:6px;border:1px solid var(--frame-border);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.8);cursor:pointer;transition:all 0.15s;}
.fc:hover{background:rgba(255,255,255,0.1);color:#fff;}
.fc.on{background:var(--accent);color:#fff;border-color:var(--accent);}
.sc{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;padding:4px 10px;border-radius:4px;cursor:pointer;transition:all 0.15s;letter-spacing:0.5px;}
.sc.sa{border:1px solid var(--frame-border);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.8);}
.sc.sa.on{background:rgba(255,255,255,0.15);color:#fff;}
.sc.sw{border:1px solid var(--yellow-border);background:rgba(217,119,6,0.1);color:var(--yellow);}
.sc.sw.on{background:var(--yellow);color:#fff;}
.sc.scl{border:1px solid var(--green-border);background:rgba(22,163,74,0.1);color:var(--green);}
.sc.scl.on{background:var(--green);color:#fff;}
.fcount{font-family:'JetBrains Mono',monospace;font-size:11px;color:rgba(255,255,255,0.8);margin-left:auto;}

/* TSI Card */
.tc{background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden;box-shadow:var(--card-shadow);}
.tc-top{padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.badge{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;padding:3px 8px;border-radius:4px;letter-spacing:0.5px;flex-shrink:0;}
.badge-iw{background:var(--yellow-bg);color:var(--yellow-text);border:1px solid var(--yellow-border);}
.badge-ce{background:var(--green-bg);color:var(--green-text);border:1px solid var(--green-border);}
.badge-ci{background:var(--red-bg);color:var(--red-text);border:1px solid var(--red-border);}
.tc-tail{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--accent);}
.tc-fleet{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;background:rgba(22,163,74,0.1);color:#15803d;border:1px solid #86efac;}
.tc-fc{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:var(--text);}
.tc-effect{font-size:12px;color:var(--text);flex:1;line-height:1.4;min-width:120px;}
.tc-date{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:var(--text);flex-shrink:0;}

.tc-body{padding:12px 16px;}
.tc-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:8px;}
.tc-fld{flex:1;min-width:100px;}
.tc-lbl{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:var(--text);letter-spacing:0.5px;margin-bottom:2px;}
.tc-val{font-size:12px;color:var(--text);font-weight:500;}
.tc-notes{font-size:12px;color:var(--text);line-height:1.5;margin-top:4px;padding:8px 10px;background:#fff;border:1px solid var(--border);border-radius:6px;}
.tc-by{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:var(--text);margin-top:6px;}

/* Attempts */
.att-sec{margin-top:10px;border-top:1px solid var(--border);padding-top:10px;}
.att-lbl{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:var(--text);letter-spacing:1px;margin-bottom:8px;}
.att{padding:8px 10px;background:#fff;border:1px solid var(--border);border-radius:6px;margin-bottom:4px;}
.att-hdr{display:flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap;}
.att-num{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:#fff;padding:2px 6px;border-radius:3px;background:var(--accent);}
.att-num.ineff{background:var(--red);}
.att-num.eff{background:var(--green);}
.att-dt{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:var(--text);}
.att-wo{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:var(--accent);}
.att-act{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;background:var(--surface);border:1px solid var(--border);color:var(--text);}
.att-res{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;}
.att-res.r-ineff{background:var(--red-bg);color:var(--red-text);border:1px solid var(--red-border);}
.att-res.r-open{background:var(--yellow-bg);color:var(--yellow-text);border:1px solid var(--yellow-border);}
.att-res.r-closed{background:var(--green-bg);color:var(--green-text);border:1px solid var(--green-border);}
.att-notes{font-size:11px;color:var(--text);line-height:1.5;}

/* Action bar */
.tc-acts{padding:10px 16px;border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;background:var(--surface2);}
.tb{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;padding:6px 14px;border-radius:5px;border:1px solid var(--border);background:#fff;color:var(--text);cursor:pointer;transition:all 0.15s;letter-spacing:0.3px;}
.tb:hover{border-color:var(--accent);color:var(--accent);}
.tb-upd{color:var(--blue-text);border-color:var(--blue-border);background:var(--blue-bg);}
.tb-upd:hover{background:#bfdbfe;}
.tb-cls{color:var(--green-text);border-color:var(--green-border);background:var(--green-bg);}
.tb-cls:hover{background:#bbf7d0;}
.tb-reo{color:var(--yellow-text);border-color:var(--yellow-border);background:var(--yellow-bg);}
.tb-reo:hover{background:#fde68a;}
.tb-del{color:var(--red-text);border-color:var(--red-border);margin-left:auto;}
.tb-del:hover{background:var(--red-bg);}

/* 3-sec confirm states */
.tb.arm-cls{background:var(--green);color:#fff;border-color:var(--green);animation:pg 0.5s ease;}
.tb.arm-del{background:var(--red);color:#fff;border-color:var(--red);animation:pr 0.5s ease;margin-left:auto;}
.tb.arm-reo{background:var(--yellow);color:#fff;border-color:var(--yellow);animation:py 0.5s ease;}
@keyframes pg{0%{box-shadow:0 0 0 0 rgba(22,163,74,0.4);}100%{box-shadow:0 0 0 8px rgba(22,163,74,0);}}
@keyframes pr{0%{box-shadow:0 0 0 0 rgba(220,38,38,0.4);}100%{box-shadow:0 0 0 8px rgba(220,38,38,0);}}
@keyframes py{0%{box-shadow:0 0 0 0 rgba(217,119,6,0.4);}100%{box-shadow:0 0 0 8px rgba(217,119,6,0);}}

/* Empty */
.empty{text-align:center;padding:60px 24px;color:rgba(255,255,255,0.7);}
.empty p{font-size:15px;margin-bottom:4px;}
.empty .hint{font-size:12px;}

/* Modal overlay */
.mo{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px;}
.mo.open{display:flex;}
.mdl{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
.mdl-hdr{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.mdl-hdr h2{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--text);}
.mdl-x{background:none;border:none;font-size:20px;color:var(--text);cursor:pointer;padding:4px;}
.mdl-x:hover{color:var(--red);}
.mdl-body{padding:20px;}
.mdl-foot{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;}

/* Form */
.fg{margin-bottom:16px;}
.fl{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text);margin-bottom:6px;display:block;}
.fl .rq{color:var(--red);}
.fi,.fsl,.fta{width:100%;padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);background:#fff;border:1px solid var(--border);border-radius:8px;outline:none;transition:border-color 0.15s;}
.fi:focus,.fsl:focus,.fta:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,0.1);}
.fta{min-height:80px;resize:vertical;line-height:1.5;}
.fsl{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231e293b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;}
.fr{display:flex;gap:12px;}
.fr .fg{flex:1;}

/* Dropdown helpers */
.dd-wrap{position:relative;}
.dd{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:50;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.12);}
.dd.open{display:block;}
.dd-opt{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;transition:background 0.1s;}
.dd-opt:hover,.dd-opt.hl{background:var(--blue-bg);}
.dd-code{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--text);}
.dd-name{color:var(--text);}
.dd-fleet{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text);}

/* Action chips */
.achips{display:flex;flex-wrap:wrap;gap:6px;}
.ach{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;padding:5px 10px;border-radius:5px;border:1px solid var(--border);background:#fff;color:var(--text);cursor:pointer;transition:all 0.15s;}
.ach:hover{border-color:var(--accent);color:var(--accent);}
.ach.sel{background:var(--accent);color:#fff;border-color:var(--accent);}

/* Close modal action chips */
.cach{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;padding:6px 12px;border-radius:5px;border:1px solid var(--border);background:#fff;color:var(--text);cursor:pointer;transition:all 0.15s;}
.cach:hover{border-color:var(--green);color:var(--green-text);}
.cach.sel{background:var(--green);color:#fff;border-color:var(--green);}

/* Confirm delete modal */
.del-icon{width:48px;height:48px;background:var(--red-bg);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px;color:var(--red);}
.del-msg{text-align:center;margin-bottom:16px;}
.del-msg p{font-size:13px;color:var(--text);line-height:1.5;}
.del-msg .del-warn{font-size:12px;color:var(--red-text);font-weight:600;margin-top:6px;}
.del-ids{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--text);}
.mdl-foot .btn-cancel{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;padding:8px 20px;border-radius:6px;border:1px solid var(--border);background:#fff;color:var(--text);cursor:pointer;}
.mdl-foot .btn-cancel:hover{background:var(--surface2);}
.mdl-foot .btn-del{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;padding:8px 20px;border-radius:6px;border:1px solid var(--red);background:var(--red);color:#fff;cursor:pointer;}
.mdl-foot .btn-del:hover{background:#b91c1c;}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:10px 20px;border-radius:8px;font-size:13px;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:opacity 0.3s;}

@media(max-width:640px){
  .container{padding:16px 14px 60px;}
  .tc-top{flex-wrap:wrap;}
  .fr{flex-direction:column;gap:0;}
  .tc-effect{display:none;}
  .header{padding:12px 16px;}
  .header h1{font-size:13px;}
}
</style>
</head>
<body>

<div class="nav-bar">
  <a href="index.html" class="nav-logo">
    <img src="logo.webp" alt="Logo">
    <span class="nav-title">MOC <span>Toolbox</span></span>
  </a>
  <span class="nav-sep">|</span>
  <a href="index.html">Back to Toolbox</a>
</div>

<div class="header">
  <h1>TSI Fix Rate - Manage Entries</h1>
  <div class="header-actions">
    <button class="hdr-btn" onclick="exportData()">EXPORT</button>
    <button class="hdr-btn primary" id="newBtn" onclick="openNewModal()" style="display:none;">+ NEW TSI</button>
  </div>
</div>

<div class="container">
  <div class="fbar">
    <button class="fc on" data-f="ALL" onclick="setFleet(this)">ALL</button>
    <button class="fc" data-f="MAX 8" onclick="setFleet(this)">MAX 8</button>
    <button class="fc" data-f="MAX 7" onclick="setFleet(this)">MAX 7</button>
    <button class="fc" data-f="NG 800" onclick="setFleet(this)">NG 800</button>
    <button class="fc" data-f="NG 700" onclick="setFleet(this)">NG 700</button>
    <span style="color:var(--frame-border);margin:0 4px;">|</span>
    <button class="sc sa on" data-s="ALL" onclick="setStatus(this)">ALL</button>
    <button class="sc sw" data-s="IN_WORK" onclick="setStatus(this)">IN WORK</button>
    <button class="sc scl" data-s="CLOSED" onclick="setStatus(this)">CLOSED</button>
    <span class="fcount" id="cnt"></span>
  </div>
  <div id="list"></div>
</div>

<!-- New/Edit Modal -->
<div class="mo" id="entryModal">
  <div class="mdl">
    <div class="mdl-hdr">
      <h2 id="mTitle">New TSI Entry</h2>
      <button class="mdl-x" onclick="closeModal()">&times;</button>
    </div>
    <div class="mdl-body">
      <div class="fg dd-wrap">
        <label class="fl">TAIL NUMBER <span class="rq">*</span></label>
        <input type="text" class="fi" id="fTail" placeholder="Start typing tail..." autocomplete="off">
        <div class="dd" id="ddTail"></div>
      </div>
      <div class="fr">
        <div class="fg">
          <label class="fl">FLEET</label>
          <input type="text" class="fi" id="fFleet" readonly tabindex="-1" style="background:var(--surface);color:var(--text);">
        </div>
        <div class="fg dd-wrap">
          <label class="fl">ATA</label>
          <input type="text" class="fi" id="fAta" placeholder="e.g. 36" autocomplete="off">
          <div class="dd" id="ddAta"></div>
        </div>
      </div>
      <div class="fg">
        <label class="fl">FAULT CODE <span class="rq">*</span></label>
        <input type="text" class="fi" id="fFC" placeholder="e.g. 36-12030">
      </div>
      <div class="fg">
        <label class="fl">FLIGHT DECK EFFECT / DESCRIPTION <span class="rq">*</span></label>
        <input type="text" class="fi" id="fEffect" placeholder="e.g. BLEED FAMV RVDT L - Status Message">
      </div>
      <div class="fg">
        <label class="fl">FIM/AMM REFERENCE</label>
        <input type="text" class="fi" id="fRef" placeholder="e.g. 36-12-00-810-801">
      </div>
      <div class="fg">
        <label class="fl">WORK ORDER / BARCODE</label>
        <input type="text" class="fi" id="fWO" placeholder="e.g. TTG8Q01AL9VS">
      </div>
      <div class="fg">
        <label class="fl">ACTION TAKEN</label>
        <div class="achips" id="actChips">
          <span class="ach" onclick="pickAct(this)">IFIM/FIM TASK</span>
          <span class="ach" onclick="pickAct(this)">REMOVE/REPLACE</span>
          <span class="ach" onclick="pickAct(this)">REPAIR</span>
          <span class="ach" onclick="pickAct(this)">RESET</span>
          <span class="ach" onclick="pickAct(this)">NO FAULTS FOUND</span>
          <span class="ach" onclick="pickAct(this)">TEST/OPS CK</span>
        </div>
      </div>
      <div class="fg">
        <label class="fl">NOTES</label>
        <textarea class="fta" id="fNotes" placeholder="Describe the issue, write-up, actions taken..."></textarea>
      </div>
    </div>
    <div class="mdl-foot">
      <button class="btn-cancel" onclick="closeModal()">CANCEL</button>
      <button class="btn-del" style="background:var(--accent);border-color:var(--accent);" onclick="saveEntry()" id="saveBtn">SAVE ENTRY</button>
    </div>
  </div>
</div>

<!-- Close Modal (action taken on close) -->
<div class="mo" id="closeModal">
  <div class="mdl" style="max-width:440px;">
    <div class="mdl-hdr">
      <h2>Close TSI</h2>
      <button class="mdl-x" onclick="cancelClose()">&times;</button>
    </div>
    <div class="mdl-body">
      <div class="fg">
        <label class="fl">ACTION TAKEN ON CLOSE <span class="rq">*</span></label>
        <div class="achips" id="closeActChips">
          <span class="cach" onclick="pickCloseAct(this)">REMOVE/REPLACE</span>
          <span class="cach" onclick="pickCloseAct(this)">REPAIR</span>
          <span class="cach" onclick="pickCloseAct(this)">RESET</span>
          <span class="cach" onclick="pickCloseAct(this)">NO FAULTS FOUND</span>
          <span class="cach" onclick="pickCloseAct(this)">IFIM/FIM TASK</span>
          <span class="cach" onclick="pickCloseAct(this)">TEST/OPS CK</span>
        </div>
      </div>
      <div class="fg">
        <label class="fl">CLOSE NOTES (OPTIONAL)</label>
        <textarea class="fta" id="closeNotes" placeholder="Final sign-off notes..." style="min-height:60px;"></textarea>
      </div>
    </div>
    <div class="mdl-foot">
      <button class="btn-cancel" onclick="cancelClose()">CANCEL</button>
      <button class="btn-del" style="background:var(--green);border-color:var(--green);" onclick="confirmClose()" id="closeSaveBtn">CLOSE TSI</button>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="mo" id="delModal">
  <div class="mdl" style="max-width:400px;">
    <div class="mdl-hdr">
      <h2>Delete Entry</h2>
      <button class="mdl-x" onclick="cancelDel()">&times;</button>
    </div>
    <div class="mdl-body">
      <div class="del-icon">X</div>
      <div class="del-msg">
        <p>Delete TSI for <span class="del-ids" id="delIds"></span>?</p>
        <p class="del-warn">This action cannot be undone</p>
      </div>
    </div>
    <div class="mdl-foot">
      <button class="btn-cancel" onclick="cancelDel()">CANCEL</button>
      <button class="btn-del" onclick="confirmDel()">DELETE ENTRY</button>
    </div>
  </div>
</div>

<!-- Reopen Modal -->
<div class="mo" id="reopenModal">
  <div class="mdl" style="max-width:480px;">
    <div class="mdl-hdr">
      <h2>Reopen TSI</h2>
      <button class="mdl-x" onclick="cancelReopen()">&times;</button>
    </div>
    <div class="mdl-body">
      <p style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">This will mark the previous close as <strong style="color:var(--red);">INEFFECTIVE</strong> and start a new attempt.</p>
      <div class="fg">
        <label class="fl">NEW WORK ORDER / BARCODE</label>
        <input type="text" class="fi" id="reopenWO" placeholder="New MXI barcode...">
      </div>
      <div class="fg">
        <label class="fl">NOTES</label>
        <textarea class="fta" id="reopenNotes" placeholder="Why is it being reopened?" style="min-height:60px;"></textarea>
      </div>
    </div>
    <div class="mdl-foot">
      <button class="btn-cancel" onclick="cancelReopen()">CANCEL</button>
      <button class="btn-del" style="background:var(--yellow);border-color:var(--yellow);" onclick="confirmReopen()">REOPEN TSI</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="auth.js"></script>
<script>
// tsi-entry.js - all logic for manage entries page

// ---- ATA CODES (standard 737 chapters) ----
var ATA_CODES = [
  {code:'05',name:'Time Limits/Maint Checks'},{code:'06',name:'Dimensions and Areas'},
  {code:'07',name:'Lifting and Shoring'},{code:'08',name:'Leveling and Weighing'},
  {code:'09',name:'Towing and Taxiing'},{code:'10',name:'Parking and Mooring'},
  {code:'11',name:'Placards and Markings'},{code:'12',name:'Servicing'},
  {code:'20',name:'Standard Practices'},{code:'21',name:'Air Conditioning'},
  {code:'22',name:'Autoflight'},{code:'23',name:'Communications'},
  {code:'24',name:'Electrical Power'},{code:'25',name:'Equipment/Furnishings'},
  {code:'26',name:'Fire Protection'},{code:'27',name:'Flight Controls'},
  {code:'28',name:'Fuel'},{code:'29',name:'Hydraulic Power'},
  {code:'30',name:'Ice and Rain Protection'},{code:'31',name:'Indicating/Recording'},
  {code:'32',name:'Landing Gear'},{code:'33',name:'Lights'},
  {code:'34',name:'Navigation'},{code:'35',name:'Oxygen'},
  {code:'36',name:'Pneumatic'},{code:'38',name:'Water/Waste'},
  {code:'47',name:'Inert Gas System'},{code:'49',name:'APU'},
  {code:'51',name:'Structures'},{code:'52',name:'Doors'},
  {code:'53',name:'Fuselage'},{code:'54',name:'Nacelles/Pylons'},
  {code:'55',name:'Stabilizers'},{code:'56',name:'Windows'},
  {code:'57',name:'Wings'},{code:'70',name:'Standard Practices - Engine'},
  {code:'71',name:'Power Plant'},{code:'72',name:'Engine'},
  {code:'73',name:'Engine Fuel and Control'},{code:'74',name:'Ignition'},
  {code:'75',name:'Air - Engine'},{code:'76',name:'Engine Controls'},
  {code:'77',name:'Engine Indication'},{code:'78',name:'Exhaust/Thrust Reverser'},
  {code:'79',name:'Oil'},{code:'80',name:'Starting'}
];

// ---- STATE ----
var db = null;
var entries = [];
var curFleet = 'ALL';
var curStatus = 'ALL';
var editId = null; // null = new entry
var closeId = null;
var deleteId = null;
var reopenId = null;
var tailHighlight = -1;
var ataHighlight = -1;

// ---- TAIL NUMBERS ----
// Loaded from Firestore controllers collection (fleet field) or hardcoded fallback
var TAILS = [];

// ---- INIT ----
window.addEventListener('moc-auth-ready', function() {
  db = window.MOC_DB;
  applyPerms();
  loadTails();
  loadEntries();
});

// 2-sec safety timeout
setTimeout(function() { document.body.style.opacity = '1'; }, 2000);

function applyPerms() {
  if (window.mocCanEdit && window.mocCanEdit()) {
    document.getElementById('newBtn').style.display = '';
  }
}

function loadTails() {
  // Try to load from Firestore, fall back to empty
  if (!db) return;
  db.collection('aircraft').orderBy('tail').get().then(function(snap) {
    TAILS = [];
    snap.forEach(function(doc) {
      var d = doc.data();
      TAILS.push({tail: d.tail, fleet: d.fleet || ''});
    });
  }).catch(function() {
    // No aircraft collection yet - tails typed manually, fleet typed manually
  });
}

// ---- LOAD ENTRIES FROM FIRESTORE ----
function loadEntries() {
  if (!db) { renderList(); return; }
  db.collection('tsi_entries').orderBy('createdAt','desc').get().then(function(snap) {
    entries = [];
    snap.forEach(function(doc) {
      var d = doc.data();
      d.id = doc.id;
      entries.push(d);
    });
    renderList();
  }).catch(function(err) {
    toast('Error loading: ' + err.message);
    renderList();
  });
}

// ---- FILTERS ----
function setFleet(el) {
  document.querySelectorAll('.fc').forEach(function(c){c.classList.remove('on');});
  el.classList.add('on');
  curFleet = el.getAttribute('data-f');
  renderList();
}

function setStatus(el) {
  document.querySelectorAll('.sc').forEach(function(c){c.classList.remove('on');});
  el.classList.add('on');
  curStatus = el.getAttribute('data-s');
  renderList();
}

// ---- RENDER LIST ----
function renderList() {
  var filtered = entries.filter(function(e) {
    if (curFleet !== 'ALL' && e.fleet !== curFleet) return false;
    if (curStatus === 'IN_WORK' && e.status !== 'in_work') return false;
    if (curStatus === 'CLOSED' && e.status !== 'closed') return false;
    return true;
  });

  document.getElementById('cnt').textContent = filtered.length + ' entr' + (filtered.length === 1 ? 'y' : 'ies');
  var el = document.getElementById('list');

  if (filtered.length === 0) {
    el.innerHTML = '<div class="empty"><p>No entries found</p><p class="hint">Create a new TSI or adjust filters</p></div>';
    return;
  }

  var html = '';
  filtered.forEach(function(e) {
    var isClosed = e.status === 'closed';
    var attempts = e.attempts || [];
    var lastAttempt = attempts.length > 0 ? attempts[attempts.length - 1] : null;
    var canAct = window.mocCanEdit && window.mocCanEdit();

    // Status badge
    var statusBadge = '';
    if (isClosed) {
      statusBadge = '<span class="badge badge-ce">CLOSED</span>';
    } else {
      statusBadge = '<span class="badge badge-iw">IN WORK</span>';
    }

    // Attempts HTML
    var attHtml = '';
    if (attempts.length > 0) {
      attHtml = '<div class="att-sec"><div class="att-lbl">ATTEMPTS (' + attempts.length + ')</div>';
      attempts.forEach(function(a, idx) {
        var numClass = '';
        var resHtml = '';
        if (a.resolution === 'ineffective') {
          numClass = ' ineff';
          resHtml = '<span class="att-res r-ineff">INEFFECTIVE</span>';
        } else if (a.resolution === 'closed') {
          numClass = ' eff';
          resHtml = '<span class="att-res r-closed">CLOSED</span>';
        } else {
          resHtml = '<span class="att-res r-open">IN WORK</span>';
        }
        attHtml += '<div class="att">';
        attHtml += '<div class="att-hdr">';
        attHtml += '<span class="att-num' + numClass + '">#' + (idx + 1) + '</span>';
        attHtml += '<span class="att-dt">' + fmtDate(a.openedAt) + '</span>';
        if (a.workOrder) attHtml += '<span class="att-wo">' + esc(a.workOrder) + '</span>';
        if (a.action) attHtml += '<span class="att-act">' + esc(a.action) + '</span>';
        attHtml += resHtml;
        attHtml += '</div>';
        if (a.notes) attHtml += '<div class="att-notes">' + esc(a.notes) + '</div>';
        if (a.closeNotes) attHtml += '<div class="att-notes" style="margin-top:4px;font-style:italic;">Close: ' + esc(a.closeNotes) + '</div>';
        if (a.closedAt) attHtml += '<div class="att-dt" style="margin-top:4px;font-size:9px;">Closed: ' + fmtDate(a.closedAt) + '</div>';
        attHtml += '</div>';
      });
      attHtml += '</div>';
    }

    // Action buttons
    var actHtml = '';
    if (canAct) {
      actHtml = '<div class="tc-acts">';
      actHtml += '<button class="tb tb-upd" onclick="openEditModal(\'' + e.id + '\')">UPDATE</button>';
      if (isClosed) {
        actHtml += '<button class="tb tb-reo" onclick="startReopen(\'' + e.id + '\')">REOPEN</button>';
      } else {
        actHtml += '<button class="tb tb-cls" onclick="startClose(\'' + e.id + '\')">CLOSE</button>';
      }
      actHtml += '<button class="tb tb-del" onclick="startDel(\'' + e.id + '\')">DELETE</button>';
      actHtml += '</div>';
    }

    html += '<div class="tc" id="card-' + e.id + '">';
    html += '<div class="tc-top">';
    html += statusBadge;
    html += '<span class="tc-tail">' + esc(e.tail || '') + '</span>';
    if (e.fleet) html += '<span class="tc-fleet">' + esc(e.fleet) + '</span>';
    html += '<span class="tc-fc">' + esc(e.faultCode || '') + '</span>';
    html += '<span class="tc-effect">' + esc(e.effect || '') + '</span>';
    html += '<span class="tc-date">' + fmtDate(e.createdAt) + '</span>';
    html += '</div>';

    html += '<div class="tc-body">';
    var row1 = '';
    if (e.ata) row1 += '<div class="tc-fld"><div class="tc-lbl">ATA</div><div class="tc-val">' + esc(e.ata) + '</div></div>';
    if (e.ref) row1 += '<div class="tc-fld"><div class="tc-lbl">FIM/AMM REF</div><div class="tc-val">' + esc(e.ref) + '</div></div>';
    if (lastAttempt && lastAttempt.workOrder) row1 += '<div class="tc-fld"><div class="tc-lbl">WORK ORDER</div><div class="tc-val">' + esc(lastAttempt.workOrder) + '</div></div>';
    if (lastAttempt && lastAttempt.action) row1 += '<div class="tc-fld"><div class="tc-lbl">ACTION</div><div class="tc-val">' + esc(lastAttempt.action) + '</div></div>';
    if (row1) html += '<div class="tc-row">' + row1 + '</div>';

    if (lastAttempt && lastAttempt.notes) {
      html += '<div class="tc-notes">' + esc(lastAttempt.notes) + '</div>';
    }

    if (e.createdBy) html += '<div class="tc-by">Created by: ' + esc(e.createdBy) + '</div>';

    html += attHtml;
    html += '</div>';
    html += actHtml;
    html += '</div>';
  });

  el.innerHTML = html;
}

// ---- NEW/EDIT MODAL ----
function openNewModal() {
  editId = null;
  document.getElementById('mTitle').textContent = 'New TSI Entry';
  document.getElementById('saveBtn').textContent = 'SAVE ENTRY';
  clearForm();
  document.getElementById('entryModal').classList.add('open');
  document.getElementById('fTail').focus();
}

function openEditModal(id) {
  var e = entries.find(function(x) { return x.id === id; });
  if (!e) return;
  editId = id;
  document.getElementById('mTitle').textContent = 'Update TSI';
  document.getElementById('saveBtn').textContent = 'UPDATE ENTRY';
  var last = (e.attempts && e.attempts.length > 0) ? e.attempts[e.attempts.length - 1] : {};
  document.getElementById('fTail').value = e.tail || '';
  document.getElementById('fFleet').value = e.fleet || '';
  document.getElementById('fAta').value = e.ata || '';
  document.getElementById('fFC').value = e.faultCode || '';
  document.getElementById('fEffect').value = e.effect || '';
  document.getElementById('fRef').value = e.ref || '';
  document.getElementById('fWO').value = last.workOrder || '';
  document.getElementById('fNotes').value = last.notes || '';
  // Set action chip
  document.querySelectorAll('#actChips .ach').forEach(function(c) {
    c.classList.toggle('sel', c.textContent === (last.action || ''));
  });
  document.getElementById('entryModal').classList.add('open');
}

function closeModal() {
  document.getElementById('entryModal').classList.remove('open');
  editId = null;
}

function clearForm() {
  ['fTail','fFleet','fAta','fFC','fEffect','fRef','fWO','fNotes'].forEach(function(id) {
    document.getElementById(id).value = '';
  });
  document.querySelectorAll('#actChips .ach').forEach(function(c) { c.classList.remove('sel'); });
}

// ---- SAVE (CREATE / UPDATE) ----
function saveEntry() {
  var tail = document.getElementById('fTail').value.trim().toUpperCase();
  var fc = document.getElementById('fFC').value.trim();
  var effect = document.getElementById('fEffect').value.trim();
  if (!tail || !fc || !effect) {
    toast('Tail, Fault Code, and Effect are required');
    return;
  }

  var fleet = document.getElementById('fFleet').value.trim();
  var ata = document.getElementById('fAta').value.trim();
  var ref = document.getElementById('fRef').value.trim();
  var wo = document.getElementById('fWO').value.trim();
  var notes = document.getElementById('fNotes').value.trim();
  var action = '';
  var selAct = document.querySelector('#actChips .ach.sel');
  if (selAct) action = selAct.textContent;

  if (editId) {
    // UPDATE existing
    var existing = entries.find(function(x) { return x.id === editId; });
    if (!existing) return;
    var updateData = { tail: tail, fleet: fleet, ata: ata, faultCode: fc, effect: effect, ref: ref };
    // Update the current (last) attempt
    var attempts = existing.attempts ? existing.attempts.slice() : [];
    if (attempts.length > 0) {
      var last = Object.assign({}, attempts[attempts.length - 1]);
      last.workOrder = wo;
      last.notes = notes;
      last.action = action;
      attempts[attempts.length - 1] = last;
    }
    updateData.attempts = attempts;
    db.collection('tsi_entries').doc(editId).update(updateData).then(function() {
      closeModal();
      loadEntries();
      toast('Entry updated');
    }).catch(function(err) { toast('Error: ' + err.message); });
  } else {
    // CREATE new
    var now = new Date().toISOString();
    var user = window.CURRENT_USER ? window.CURRENT_USER.name : 'Unknown';
    var newEntry = {
      tail: tail,
      fleet: fleet,
      ata: ata,
      faultCode: fc,
      effect: effect,
      ref: ref,
      status: 'in_work',
      createdAt: now,
      createdBy: user,
      attempts: [{
        openedAt: now,
        workOrder: wo,
        action: action,
        notes: notes,
        resolution: 'open',
        closedAt: null,
        closeAction: null,
        closeNotes: null
      }]
    };
    db.collection('tsi_entries').add(newEntry).then(function() {
      closeModal();
      loadEntries();
      toast('TSI created for ' + tail + ' / ' + fc);
    }).catch(function(err) { toast('Error: ' + err.message); });
  }
}

// ---- CLOSE FLOW ----
function startClose(id) {
  closeId = id;
  document.querySelectorAll('#closeActChips .cach').forEach(function(c) { c.classList.remove('sel'); });
  document.getElementById('closeNotes').value = '';
  document.getElementById('closeModal').classList.add('open');
}

function cancelClose() {
  closeId = null;
  document.getElementById('closeModal').classList.remove('open');
}

function pickCloseAct(el) {
  document.querySelectorAll('#closeActChips .cach').forEach(function(c) { c.classList.remove('sel'); });
  el.classList.add('sel');
}

function confirmClose() {
  if (!closeId) return;
  var selAct = document.querySelector('#closeActChips .cach.sel');
  if (!selAct) { toast('Select an action taken'); return; }
  var closeAction = selAct.textContent;
  var closeNotes = document.getElementById('closeNotes').value.trim();
  var now = new Date().toISOString();

  var entry = entries.find(function(x) { return x.id === closeId; });
  if (!entry) return;

  var attempts = entry.attempts ? entry.attempts.slice() : [];
  if (attempts.length > 0) {
    var last = Object.assign({}, attempts[attempts.length - 1]);
    last.resolution = 'closed';
    last.closedAt = now;
    last.closeAction = closeAction;
    last.closeNotes = closeNotes;
    attempts[attempts.length - 1] = last;
  }

  db.collection('tsi_entries').doc(closeId).update({
    status: 'closed',
    closedDate: now,
    attempts: attempts
  }).then(function() {
    cancelClose();
    loadEntries();
    toast('TSI closed');
  }).catch(function(err) { toast('Error: ' + err.message); });
}

// ---- REOPEN FLOW ----
function startReopen(id) {
  reopenId = id;
  document.getElementById('reopenWO').value = '';
  document.getElementById('reopenNotes').value = '';
  document.getElementById('reopenModal').classList.add('open');
}

function cancelReopen() {
  reopenId = null;
  document.getElementById('reopenModal').classList.remove('open');
}

function confirmReopen() {
  if (!reopenId) return;
  var wo = document.getElementById('reopenWO').value.trim();
  var notes = document.getElementById('reopenNotes').value.trim();
  var now = new Date().toISOString();

  var entry = entries.find(function(x) { return x.id === reopenId; });
  if (!entry) return;

  var attempts = entry.attempts ? entry.attempts.slice() : [];
  // Mark last attempt as ineffective
  if (attempts.length > 0) {
    var last = Object.assign({}, attempts[attempts.length - 1]);
    last.resolution = 'ineffective';
    attempts[attempts.length - 1] = last;
  }
  // Add new attempt
  attempts.push({
    openedAt: now,
    workOrder: wo,
    action: '',
    notes: notes,
    resolution: 'open',
    closedAt: null,
    closeAction: null,
    closeNotes: null
  });

  db.collection('tsi_entries').doc(reopenId).update({
    status: 'in_work',
    closedDate: null,
    attempts: attempts
  }).then(function() {
    cancelReopen();
    loadEntries();
    toast('Reopened - previous attempt marked ineffective');
  }).catch(function(err) { toast('Error: ' + err.message); });
}

// ---- DELETE FLOW (modal confirm) ----
function startDel(id) {
  deleteId = id;
  var entry = entries.find(function(x) { return x.id === id; });
  if (!entry) return;
  document.getElementById('delIds').textContent = (entry.tail || '') + ' / ' + (entry.faultCode || '');
  document.getElementById('delModal').classList.add('open');
}

function cancelDel() {
  deleteId = null;
  document.getElementById('delModal').classList.remove('open');
}

function confirmDel() {
  if (!deleteId) return;
  var id = deleteId;
  deleteId = null;
  document.getElementById('delModal').classList.remove('open');
  db.collection('tsi_entries').doc(id).delete().then(function() {
    loadEntries();
    toast('Entry deleted');
  }).catch(function(err) { toast('Error: ' + err.message); });
}

// ---- ACTION CHIPS (create/edit modal) ----
function pickAct(el) {
  document.querySelectorAll('#actChips .ach').forEach(function(c) { c.classList.remove('sel'); });
  el.classList.add('sel');
}

// ---- TAIL AUTOCOMPLETE ----
document.getElementById('fTail').addEventListener('input', function() { filterTails(); });
document.getElementById('fTail').addEventListener('focus', function() { filterTails(); });
document.getElementById('fTail').addEventListener('keydown', function(e) { tailKeyNav(e); });

function filterTails() {
  var val = document.getElementById('fTail').value.trim().toUpperCase();
  var dd = document.getElementById('ddTail');
  if (!val || TAILS.length === 0) { dd.classList.remove('open'); return; }
  var matches = TAILS.filter(function(t) { return t.tail.indexOf(val) === 0; }).slice(0, 15);
  if (matches.length === 0) { dd.classList.remove('open'); return; }
  tailHighlight = -1;
  var html = '';
  matches.forEach(function(t, i) {
    html += '<div class="dd-opt" data-i="' + i + '" onmousedown="selectTail(\'' + esc(t.tail) + '\',\'' + esc(t.fleet) + '\')">';
    html += '<span class="dd-code">' + esc(t.tail) + '</span>';
    html += '<span class="dd-fleet">' + esc(t.fleet) + '</span>';
    html += '</div>';
  });
  dd.innerHTML = html;
  dd.classList.add('open');
}

function selectTail(tail, fleet) {
  document.getElementById('fTail').value = tail;
  document.getElementById('fFleet').value = fleet;
  document.getElementById('ddTail').classList.remove('open');
}

function tailKeyNav(e) {
  var dd = document.getElementById('ddTail');
  var opts = dd.querySelectorAll('.dd-opt');
  if (!dd.classList.contains('open') || opts.length === 0) return;
  if (e.key === 'ArrowDown') { e.preventDefault(); tailHighlight = Math.min(tailHighlight + 1, opts.length - 1); hlTails(opts); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); tailHighlight = Math.max(tailHighlight - 1, 0); hlTails(opts); }
  else if (e.key === 'Enter' && tailHighlight >= 0) { e.preventDefault(); opts[tailHighlight].dispatchEvent(new Event('mousedown')); }
  else if (e.key === 'Escape') { dd.classList.remove('open'); }
}
function hlTails(opts) {
  opts.forEach(function(o, i) { o.classList.toggle('hl', i === tailHighlight); });
  if (tailHighlight >= 0 && opts[tailHighlight]) opts[tailHighlight].scrollIntoView({block:'nearest'});
}

// ---- ATA AUTOCOMPLETE ----
document.getElementById('fAta').addEventListener('input', function() { filterAta(); });
document.getElementById('fAta').addEventListener('focus', function() { filterAta(); });
document.getElementById('fAta').addEventListener('keydown', function(e) { ataKeyNav(e); });

function filterAta() {
  var val = document.getElementById('fAta').value.trim().toLowerCase();
  var dd = document.getElementById('ddAta');
  var matches = ATA_CODES.filter(function(a) {
    return a.code.indexOf(val) === 0 || a.name.toLowerCase().indexOf(val) >= 0;
  }).slice(0, 15);
  if (val === '' || matches.length === 0) { dd.classList.remove('open'); return; }
  ataHighlight = -1;
  var html = '';
  matches.forEach(function(a, i) {
    html += '<div class="dd-opt" data-i="' + i + '" onmousedown="selectAta(\'' + a.code + '\')">';
    html += '<span class="dd-code" style="min-width:30px;">' + a.code + '</span>';
    html += '<span class="dd-name">' + esc(a.name) + '</span>';
    html += '</div>';
  });
  dd.innerHTML = html;
  dd.classList.add('open');
}

function selectAta(code) {
  document.getElementById('fAta').value = code;
  document.getElementById('ddAta').classList.remove('open');
}

function ataKeyNav(e) {
  var dd = document.getElementById('ddAta');
  var opts = dd.querySelectorAll('.dd-opt');
  if (!dd.classList.contains('open') || opts.length === 0) return;
  if (e.key === 'ArrowDown') { e.preventDefault(); ataHighlight = Math.min(ataHighlight + 1, opts.length - 1); hlAta(opts); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); ataHighlight = Math.max(ataHighlight - 1, 0); hlAta(opts); }
  else if (e.key === 'Enter' && ataHighlight >= 0) { e.preventDefault(); opts[ataHighlight].dispatchEvent(new Event('mousedown')); }
  else if (e.key === 'Escape') { dd.classList.remove('open'); }
}
function hlAta(opts) {
  opts.forEach(function(o, i) { o.classList.toggle('hl', i === ataHighlight); });
  if (ataHighlight >= 0 && opts[ataHighlight]) opts[ataHighlight].scrollIntoView({block:'nearest'});
}

// Close dropdowns on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.dd-wrap')) {
    document.querySelectorAll('.dd').forEach(function(d) { d.classList.remove('open'); });
  }
});

// ---- EXPORT ----
function exportData() {
  var blob = new Blob([JSON.stringify(entries, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'tsi-fixrate-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('Exported ' + entries.length + ' entries');
}

// ---- HELPERS ----
function esc(s) {
  if (!s) return '';
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function fmtDate(iso) {
  if (!iso) return '';
  try {
    var d = new Date(iso);
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return ('0' + d.getDate()).slice(-2) + '-' + months[d.getMonth()] + '-' + d.getFullYear();
  } catch(e) { return iso; }
}

function toast(msg) {
  var existing = document.querySelector('.toast');
  if (existing) existing.remove();
  var t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(function() { t.style.opacity = '0'; }, 2500);
  setTimeout(function() { t.remove(); }, 3000);
}

</script>
</body>
</html>
