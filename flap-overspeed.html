<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>737-8 Flap/Slat Overspeed Decision Tool</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #232736;
  --border: #2e3346;
  --text: #e2e4ed;
  --text-dim: #8b90a5;
  --green: #22c55e;
  --green-bg: #0d3320;
  --green-border: #166534;
  --yellow: #eab308;
  --yellow-bg: #3d2f04;
  --yellow-border: #854d0e;
  --red: #ef4444;
  --red-bg: #3b1111;
  --red-border: #991b1b;
  --blue: #3b82f6;
  --blue-bg: #0c1e3d;
  --blue-border: #1e40af;
  --accent: #6366f1;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  line-height: 1.5;
}

.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}
.header h1 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 16px;
  font-weight: 700;
  letter-spacing: -0.5px;
}
.header-ref {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-dim);
  background: var(--surface2);
  padding: 4px 10px;
  border-radius: 4px;
  border: 1px solid var(--border);
}
.reset-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-dim);
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
}
.reset-btn:hover { background: var(--border); color: var(--text); }

.container {
  max-width: 720px;
  margin: 0 auto;
  padding: 32px 24px 80px;
}

.progress-bar {
  display: flex;
  gap: 4px;
  margin-bottom: 32px;
}
.progress-bar .step {
  flex: 1;
  height: 4px;
  background: var(--surface2);
  border-radius: 2px;
  transition: background 0.3s;
}
.progress-bar .step.active { background: var(--accent); }
.progress-bar .step.done { background: var(--green); }

.step-section {
  display: none;
  animation: fadeIn 0.25s ease;
}
.step-section.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.step-top-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.step-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1.5px;
}
.back-btn {
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  color: var(--text-dim);
  background: var(--surface2);
  border: 1px solid var(--border);
  padding: 4px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
}
.back-btn:hover { color: var(--text); border-color: var(--accent); }

.step-question {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 8px;
  line-height: 1.3;
}
.step-hint {
  font-size: 13px;
  color: var(--text-dim);
  margin-bottom: 24px;
  line-height: 1.6;
}

.options {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.option-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  font-weight: 500;
  padding: 16px 20px;
  border-radius: 10px;
  cursor: pointer;
  text-align: left;
  transition: all 0.15s;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}
.option-btn:hover {
  background: var(--surface2);
  border-color: var(--accent);
}
.option-btn .key {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  background: var(--surface2);
  border: 1px solid var(--border);
  padding: 2px 8px;
  border-radius: 4px;
  color: var(--text-dim);
  flex-shrink: 0;
  margin-top: 2px;
}
.option-btn .option-content {
  display: flex;
  flex-direction: column;
}
.option-btn .option-sub {
  font-size: 12px;
  color: var(--text-dim);
  font-weight: 400;
  margin-top: 2px;
}

.input-group { margin-bottom: 20px; }
.input-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-dim);
  margin-bottom: 6px;
}
.input-row {
  display: flex;
  gap: 8px;
  align-items: center;
}
.input-group input {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 600;
  padding: 14px 16px;
  border-radius: 10px;
  width: 100%;
  outline: none;
  transition: border-color 0.15s;
}
.input-group input:focus { border-color: var(--accent); }
.input-group .unit {
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  color: var(--text-dim);
  flex-shrink: 0;
}

.next-btn {
  background: var(--accent);
  border: none;
  color: white;
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  font-weight: 600;
  padding: 14px 28px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.15s;
  margin-top: 16px;
  width: 100%;
}
.next-btn:hover { opacity: 0.9; }
.next-btn:disabled { opacity: 0.3; cursor: not-allowed; }

.summary-strip {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 20px;
  margin-bottom: 24px;
  display: none;
}
.summary-strip.visible { display: block; }
.summary-strip .summary-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 8px;
}
.summary-items {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 16px;
}
.summary-item {
  font-size: 13px;
  color: var(--text-dim);
}
.summary-item span {
  color: var(--text);
  font-weight: 600;
}

/* ============ RESULT STYLES ============ */
.result-answer {
  border-radius: 12px;
  padding: 28px;
  margin-bottom: 20px;
  border: 2px solid;
}
.result-answer.fly { background: var(--green-bg); border-color: var(--green-border); }
.result-answer.defer { background: var(--yellow-bg); border-color: var(--yellow-border); }
.result-answer.ground { background: var(--red-bg); border-color: var(--red-border); }

.result-answer .ra-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: 12px;
}
.result-answer.fly .ra-badge { color: var(--green); }
.result-answer.defer .ra-badge { color: var(--yellow); }
.result-answer.ground .ra-badge { color: var(--red); }

.result-answer .ra-action {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 16px;
  line-height: 1.4;
}

.result-answer .ra-line {
  font-size: 14px;
  line-height: 1.7;
  padding: 4px 0;
}
.result-answer .ra-line strong {
  color: var(--text);
}
.result-answer.fly .ra-line { color: #a3e4b8; }
.result-answer.defer .ra-line { color: #d4c06a; }
.result-answer.ground .ra-line { color: #e8a0a0; }

.ra-divider {
  border: none;
  border-top: 1px solid rgba(255,255,255,0.1);
  margin: 14px 0;
}

.ra-tasks {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--text-dim);
  margin-top: 12px;
}

/* Details accordion */
.details-toggle {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.15s;
  margin-bottom: 4px;
  width: 100%;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
}
.details-toggle:hover { background: var(--surface2); }
.details-toggle .arrow {
  transition: transform 0.2s;
  font-size: 12px;
  color: var(--text-dim);
}
.details-toggle.open .arrow { transform: rotate(180deg); }

.details-content {
  display: none;
  background: var(--surface);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 10px 10px;
  padding: 20px;
  margin-top: -4px;
  margin-bottom: 12px;
}
.details-content.open { display: block; }

.detail-device {
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.detail-device:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}
.detail-device-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 6px;
}
.detail-device-label.fly-label { color: var(--green); }
.detail-device-label.defer-label { color: var(--yellow); }
.detail-device-label.ground-label { color: var(--red); }

.detail-text {
  font-size: 13px;
  color: var(--text-dim);
  line-height: 1.7;
}
.detail-text strong { color: var(--text); }

/* Speed tables */
.speed-ref {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 12px;
}
.speed-ref-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 12px 16px;
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
}
.speed-ref table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.speed-ref th {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-dim);
  text-align: left;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
}
.speed-ref td {
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
}
.speed-ref tr:last-child td { border-bottom: none; }
.speed-ref tr.highlight { background: rgba(99, 102, 241, 0.1); }
.speed-ref tr.highlight td { color: var(--accent); font-weight: 600; }

.amm-note {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 12px;
  padding: 10px 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  line-height: 1.6;
}

.flap-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}
.flap-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 700;
  padding: 16px;
  border-radius: 10px;
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
}
.flap-btn:hover { background: var(--surface2); border-color: var(--accent); }
.flap-btn.selected {
  background: rgba(99, 102, 241, 0.15);
  border-color: var(--accent);
  color: var(--accent);
}

@media print {
  body { background: white; color: black; }
  .header, .reset-btn, .back-btn, .progress-bar { display: none; }
  .details-content { display: block !important; }
}
@media (max-width: 600px) {
  .header { flex-direction: column; gap: 8px; align-items: flex-start; }
  .header h1 { font-size: 14px; }
  .step-question { font-size: 18px; }
}
/* MOC Toolbox nav bar */
.moc-nav {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 10px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.moc-nav a {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  color: var(--text-dim);
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 500;
  transition: color 0.15s;
}
.moc-nav a:hover { color: var(--text); }
.moc-nav img {
  height: 28px;
  width: auto;
  object-fit: contain;
}
.moc-nav .nav-title {
  font-weight: 700;
  color: var(--text);
  font-size: 14px;
}
.moc-nav .nav-title span { color: #3b82f6; }
.moc-nav .nav-sep {
  color: var(--border);
  font-size: 16px;
}
</style>
</head>
<body>
<div class="moc-nav">
  <a href="index.html">
    <img src="logo.webp" alt="MOC">
    <span class="nav-title">MOC <span>Toolbox</span></span>
  </a>
  <span class="nav-sep">|</span>
  <a href="index.html">Back to Apps</a>
</div>

<div class="header">
  <div class="header-left">
    <h1>737-8 FLAP/SLAT OVERSPEED</h1>
    <span class="header-ref">AMM PGBLK 05-51-08-201 | Rev 26 | TR: 05-1033</span>
  </div>
  <button class="reset-btn" onclick="resetAll()">Start Over</button>
</div>

<div class="container">
  <div class="progress-bar" id="progressBar">
    <div class="step" data-step="1"></div>
    <div class="step" data-step="2"></div>
    <div class="step" data-step="3"></div>
    <div class="step" data-step="4"></div>
    <div class="step" data-step="5"></div>
  </div>

  <div class="summary-strip" id="summaryStrip">
    <div class="summary-title">Your Inputs</div>
    <div class="summary-items" id="summaryItems"></div>
  </div>

  <!-- STEP 1: Altitude -->
  <div class="step-section active" id="step1">
    <div class="step-top-row">
      <div class="step-label">Step 1 of 5</div>
    </div>
    <div class="step-question">What was the altitude?</div>
    <div class="step-hint">Above 20,000 ft uses Section B. Below 20,000 ft uses Sections C/D with speed-limit tables.</div>
    <div class="options">
      <button class="option-btn" onclick="setAltitude('above')">
        <span class="key">A</span>
        <span class="option-content">Above 20,000 ft (6.10 km)</span>
      </button>
      <button class="option-btn" onclick="setAltitude('below')">
        <span class="key">B</span>
        <span class="option-content">Below 20,000 ft (6.10 km)</span>
      </button>
    </div>
  </div>

  <!-- STEP 2: Flap system -->
  <div class="step-section" id="step2">
    <div class="step-top-row">
      <div class="step-label">Step 2 of 5</div>
      <button class="back-btn" onclick="goBack(2)">Back</button>
    </div>
    <div class="step-question">How were flaps extended?</div>
    <div class="step-hint">Normal system extends both trailing edge flaps AND leading edge devices automatically. Standby/alternate system extends trailing edge flaps ONLY.</div>
    <div class="options">
      <button class="option-btn" onclick="setSystem('normal')">
        <span class="key">A</span>
        <span class="option-content">
          Normal flap system
          <span class="option-sub">Assesses both trailing edge + leading edge (99% of cases)</span>
        </span>
      </button>
      <button class="option-btn" onclick="setSystem('standby')">
        <span class="key">B</span>
        <span class="option-content">
          Standby / Alternate system
          <span class="option-sub">Trailing edge only -- different speed limits for flap 1/2/5</span>
        </span>
      </button>
    </div>
  </div>

  <!-- STEP 3: Flap position -->
  <div class="step-section" id="step3">
    <div class="step-top-row">
      <div class="step-label">Step 3 of 5</div>
      <button class="back-btn" onclick="goBack(3)">Back</button>
    </div>
    <div class="step-question">What was the flap position?</div>
    <div class="step-hint">Use the detent position if flaps were stable. If flaps were in transition, use the next higher setting per AMM Section B.(3)(b).</div>
    <div class="flap-grid">
      <button class="flap-btn" onclick="setFlap(1)">1</button>
      <button class="flap-btn" onclick="setFlap(2)">2</button>
      <button class="flap-btn" onclick="setFlap(5)">5</button>
      <button class="flap-btn" onclick="setFlap(10)">10</button>
      <button class="flap-btn" onclick="setFlap(15)">15</button>
      <button class="flap-btn" onclick="setFlap(25)">25</button>
      <button class="flap-btn" onclick="setFlap(30)">30</button>
      <button class="flap-btn" onclick="setFlap(40)">40</button>
    </div>
  </div>

  <!-- STEP 4: Speed -->
  <div class="step-section" id="step4">
    <div class="step-top-row">
      <div class="step-label">Step 4 of 5</div>
      <button class="back-btn" onclick="goBack(4)">Back</button>
    </div>
    <div class="step-question">What was the max speed during overspeed?</div>
    <div class="step-hint">Use FDR data if available, otherwise use flight crew notes. Actual flap position reported by airplane data systems may differ slightly from detent due to indication tolerances.</div>
    <div class="input-group">
      <label>Overspeed (KIAS)</label>
      <div class="input-row">
        <input type="number" id="speedInput" placeholder="e.g. 215" min="100" max="400" oninput="validateSpeed()">
        <span class="unit">KIAS</span>
      </div>
    </div>
    <div id="speedPreview" style="margin-top:12px"></div>
    <button class="next-btn" id="speedNextBtn" onclick="confirmSpeed()" disabled>Continue</button>
  </div>

  <!-- STEP 5: Nz -->
  <div class="step-section" id="step5">
    <div class="step-top-row">
      <div class="step-label">Step 5 of 5</div>
      <button class="back-btn" onclick="goBack(5)">Back</button>
    </div>
    <div class="step-question">What is the vertical acceleration (Nz)?</div>
    <div class="step-hint">From FDR data or equivalent. If FDR data is not available, select "Unknown." This determines which speed-limit table applies and may require FDR review within 5 flight cycles.</div>
    <div class="options">
      <button class="option-btn" onclick="setNz('known_normal')">
        <span class="key">A</span>
        <span class="option-content">
          Known: 0.7 to 1.3 G
          <span class="option-sub">Normal range -- uses Tables 202/204, wider speed margins</span>
        </span>
      </button>
      <button class="option-btn" onclick="setNz('unknown_or_marginal')">
        <span class="key">B</span>
        <span class="option-content">
          Unknown (no FDR data), OR known between 0.5-0.7 G or 1.3-1.6 G
          <span class="option-sub">Marginal/no data -- uses Tables 203/205, tighter limits, may need FDR review</span>
        </span>
      </button>
      <button class="option-btn" onclick="setNz('known_outside')">
        <span class="key">C</span>
        <span class="option-content">
          Known: OUTSIDE 0.5 to 1.6 G
          <span class="option-sub">Extreme -- contact Boeing or ground for Phase I + II before next flight</span>
        </span>
      </button>
    </div>
  </div>

  <!-- STEP 6: Result -->
  <div class="step-section" id="step6">
    <div class="step-top-row">
      <div class="step-label">Result</div>
      <button class="back-btn" onclick="goBack(6)">Back</button>
    </div>
    <div id="resultContainer"></div>
  </div>
</div>

<script>
// ========================================
// SPEED TABLES - 737-7/8/8200
// ========================================
const TABLE_202 = {
  1:{phaseI:250,phaseII:265}, 2:{phaseI:250,phaseII:265}, 5:{phaseI:250,phaseII:265},
  10:{phaseI:210,phaseII:231}, 15:{phaseI:200,phaseII:229}, 25:{phaseI:190,phaseII:227},
  30:{phaseI:175,phaseII:191}, 40:{phaseI:166,phaseII:182}
};
const TABLE_202_SBY = {
  1:{phaseI:230,phaseII:245}, 2:{phaseI:230,phaseII:245}, 5:{phaseI:230,phaseII:245}
};
const TABLE_203 = {
  1:{phaseI:250,deferral:255}, 2:{phaseI:250,deferral:255}, 5:{phaseI:250,deferral:255},
  10:{phaseI:210,deferral:221}, 15:{phaseI:200,deferral:219}, 25:{phaseI:190,deferral:217},
  30:{phaseI:175,deferral:181}, 40:{phaseI:166,deferral:172}
};
const TABLE_203_SBY = {
  1:{phaseI:230,deferral:235}, 2:{phaseI:230,deferral:235}, 5:{phaseI:230,deferral:235}
};
const TABLE_204 = {
  1:{phaseI:250,phaseII:265}, 2:{phaseI:250,phaseII:265}, 5:{phaseI:250,phaseII:265},
  10:{phaseI:230,phaseII:245}, 15:{phaseI:230,phaseII:245}, 25:{phaseI:230,phaseII:245},
  30:{phaseI:230,phaseII:245}, 40:{phaseI:230,phaseII:245}
};
const TABLE_205 = {
  1:{phaseI:250,deferral:253}, 2:{phaseI:250,deferral:253}, 5:{phaseI:250,deferral:253},
  10:{phaseI:230,deferral:235}, 15:{phaseI:230,deferral:235}, 25:{phaseI:230,deferral:235},
  30:{phaseI:230,deferral:235}, 40:{phaseI:230,deferral:235}
};

let state = { altitude:null, system:null, flapPos:null, speed:null, nz:null };
let currentStep = 1;

function getTE202(f) { return (state.system==='standby' && [1,2,5].includes(f)) ? TABLE_202_SBY[f] : TABLE_202[f]; }
function getTE203(f) { return (state.system==='standby' && [1,2,5].includes(f)) ? TABLE_203_SBY[f] : TABLE_203[f]; }

function goToStep(n) {
  document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
  document.getElementById('step'+n).classList.add('active');
  currentStep = n;
  updateProgress(); updateSummary();
  window.scrollTo({top:0,behavior:'smooth'});
}
function goBack(from) {
  if (from===6) { state.nz=null; goToStep(5); }
  else if (from===5) { state.nz=null; goToStep(4); }
  else if (from===4) { state.speed=null; document.getElementById('speedInput').value=''; document.getElementById('speedNextBtn').disabled=true; document.getElementById('speedPreview').innerHTML=''; goToStep(3); }
  else if (from===3) { state.flapPos=null; document.querySelectorAll('.flap-btn').forEach(b=>b.classList.remove('selected')); goToStep(2); }
  else if (from===2) { state.system=null; goToStep(1); }
}
function updateProgress() {
  document.querySelectorAll('.progress-bar .step').forEach(el => {
    const s=parseInt(el.dataset.step); el.classList.remove('active','done');
    if (currentStep===6) el.classList.add('done');
    else if (s<currentStep) el.classList.add('done');
    else if (s===currentStep) el.classList.add('active');
  });
}
function updateSummary() {
  const strip=document.getElementById('summaryStrip'), items=document.getElementById('summaryItems');
  if (currentStep<=1) { strip.classList.remove('visible'); return; }
  strip.classList.add('visible');
  let h='';
  if (state.altitude) h+=`<div class="summary-item">Alt: <span>${state.altitude==='above'?'>20k ft':'<20k ft'}</span></div>`;
  if (state.system) h+=`<div class="summary-item">System: <span>${state.system==='normal'?'Normal (TE+LE)':'Standby (TE only)'}</span></div>`;
  if (state.flapPos!==null) h+=`<div class="summary-item">Flap: <span>${state.flapPos}</span></div>`;
  if (state.speed!==null) h+=`<div class="summary-item">Speed: <span>${state.speed} KIAS</span></div>`;
  if (state.nz) { const l={known_normal:'0.7-1.3G',unknown_or_marginal:'Unknown/Marginal',known_outside:'Outside 0.5-1.6G'}; h+=`<div class="summary-item">Nz: <span>${l[state.nz]}</span></div>`; }
  items.innerHTML=h;
}

function setAltitude(v) { state.altitude=v; goToStep(2); }
function setSystem(v) { state.system=v; goToStep(3); }
function setFlap(p) { state.flapPos=p; document.querySelectorAll('.flap-btn').forEach(b=>b.classList.remove('selected')); event.target.closest('.flap-btn').classList.add('selected'); goToStep(4); }
function validateSpeed() {
  const v=document.getElementById('speedInput').value, ok=v&&parseInt(v)>=50;
  document.getElementById('speedNextBtn').disabled=!ok;
  if (ok && state.flapPos) showSpeedPreview(parseInt(v)); else document.getElementById('speedPreview').innerHTML='';
}
function showSpeedPreview(s) {
  const f=state.flapPos, te202=getTE202(f), te203=getTE203(f);
  let h='<div style="font-size:12px;color:var(--text-dim);font-family:JetBrains Mono,monospace;line-height:1.8">';
  h+=`<div>TE: Phase I=${te202.phaseI} | Phase II=${te202.phaseII} | Deferral(203)=${te203.deferral}</div>`;
  if (state.system==='normal') { const le=TABLE_204[f], le5=TABLE_205[f]; h+=`<div>LE: Phase I=${le.phaseI} | Phase II=${le.phaseII} | Deferral(205)=${le5.deferral}</div>`; }
  h+='</div>'; document.getElementById('speedPreview').innerHTML=h;
}
function confirmSpeed() { state.speed=parseInt(document.getElementById('speedInput').value); goToStep(5); }
function setNz(v) { state.nz=v; computeResult(); }

// ========================================
// COMPUTE
// ========================================
function computeResult() {
  const s=state.speed, f=state.flapPos, nz=state.nz;
  let teResult = computeDevice('te', s, f, nz);
  let leResult = (state.system==='normal') ? computeDevice('le', s, f, nz) : null;
  renderCombinedResult(teResult, leResult);
}

function computeDevice(device, speed, flap, nz) {
  // Returns: { level: 'fly'|'defer'|'ground', action: string, detail: string, deferWindow: string|null, amm: string }
  const isAbove = state.altitude==='above';

  if (nz==='known_outside') {
    const sec = device==='te' ? 'C.(5)' : 'D.(5)';
    const secAbove = 'Table 201 / Section B';
    return {
      level:'ground',
      action: `Contact Boeing or do Phase I + II before next flight`,
      detail: `Nz outside 0.5-1.6 G. AMM Ref: ${isAbove ? secAbove : sec}.`,
      deferWindow: null,
      tasks: 'TASK 05-51-08-210-801 + 802',
      needsFDR: false
    };
  }

  let phaseI, phaseII, deferral, tableName, tableNameAlt;

  if (device==='te') {
    const t202=getTE202(flap), t203=getTE203(flap);
    if (nz==='known_normal') { phaseI=t202.phaseI; phaseII=t202.phaseII; deferral=null; tableName='Table 202'; }
    else { phaseI=t203.phaseI; deferral=t203.deferral; phaseII=null; tableName='Table 203'; }
  } else {
    const t204=TABLE_204[flap], t205=TABLE_205[flap];
    if (nz==='known_normal') { phaseI=t204.phaseI; phaseII=t204.phaseII; deferral=null; tableName='Table 204'; }
    else { phaseI=t205.phaseI; deferral=t205.deferral; phaseII=null; tableName='Table 205'; }
  }

  const devLabel = device==='te' ? 'trailing edge' : 'leading edge';
  const secC = device==='te' ? 'C' : 'D';

  if (nz==='known_normal') {
    if (speed > phaseII) {
      return {
        level:'ground',
        action: `Phase I + II on ${devLabel} before next flight`,
        detail: `${speed} KIAS exceeds Phase II limit (${phaseII}). ${tableName}, Flap ${flap}. AMM Ref: ${isAbove ? 'Table 201' : 'Section '+secC+'.(2)'}.`,
        deferWindow: null, tasks:'TASK 05-51-08-210-801 + 802', needsFDR:false
      };
    } else if (speed <= phaseI) {
      return {
        level:'fly',
        action: `${devLabel} within limits -- no inspection required`,
        detail: `${speed} KIAS <= Phase I limit ${phaseI}. ${tableName}, Flap ${flap}.`,
        deferWindow: null, tasks:null, needsFDR:false
      };
    } else if (speed <= phaseI + 5) {
      return {
        level:'defer',
        action: `Phase I on ${devLabel}`,
        detail: `${speed} KIAS is <= 5 kts above Phase I limit (${phaseI}). ${tableName}, Flap ${flap}. AMM Ref: ${isAbove ? 'Table 201' : 'Section '+secC+'.(3)(a)'}.`,
        deferWindow: '100 FH or 25 flight cycles', tasks:'TASK 05-51-08-210-801', needsFDR:false
      };
    } else {
      return {
        level:'defer',
        action: `Phase I on ${devLabel}`,
        detail: `${speed} KIAS is >5 kts above Phase I (${phaseI}) but <= Phase II (${phaseII}). ${tableName}, Flap ${flap}. AMM Ref: ${isAbove ? 'Table 201' : 'Section '+secC+'.(3)(b)'}.`,
        deferWindow: '100 FH or 5 flight cycles', tasks:'TASK 05-51-08-210-801', needsFDR:false
      };
    }
  }

  // nz === unknown_or_marginal
  if (speed <= phaseI) {
    return {
      level:'fly',
      action: `${devLabel} within limits -- no inspection required`,
      detail: `${speed} KIAS <= Phase I limit ${phaseI}. ${tableName}, Flap ${flap}.`,
      deferWindow: null, tasks:null, needsFDR:false
    };
  } else if (speed <= deferral) {
    return {
      level:'defer',
      action: `Phase I on ${devLabel}`,
      detail: `${speed} KIAS is above Phase I (${phaseI}) but <= Data Review Deferral limit (${deferral}). ${tableName}, Flap ${flap}. AMM Ref: ${isAbove ? 'Table 201' : 'Section '+secC+'.(4)(b)'}.`,
      deferWindow: '100 FH or 5 flight cycles', tasks:'TASK 05-51-08-210-801', needsFDR:true
    };
  } else {
    return {
      level:'ground',
      action: `Contact Boeing or Phase I + II on ${devLabel} before next flight`,
      detail: `${speed} KIAS exceeds Data Review Deferral limit (${deferral}). ${tableName}, Flap ${flap}. AMM Ref: ${isAbove ? 'Table 201' : 'Section '+secC+'.(4)(a)'}. Having FDR data when contacting Boeing can decrease response time.`,
      deferWindow: null, tasks:'TASK 05-51-08-210-801 + 802', needsFDR:false
    };
  }
}

// ========================================
// RENDER COMBINED RESULT
// ========================================
function renderCombinedResult(te, le) {
  goToStep(6);
  const c = document.getElementById('resultContainer');

  // Determine overall level (most restrictive)
  const levels = [te, le].filter(Boolean).map(r=>r.level);
  let overall = 'fly';
  if (levels.includes('ground')) overall = 'ground';
  else if (levels.includes('defer')) overall = 'defer';

  // Collect all needed actions into combined answer
  let actionLines = [];
  let allTasks = new Set();
  let needsFDR = false;
  let deferWindows = [];

  [te, le].filter(Boolean).forEach(r => {
    if (r.level !== 'fly') {
      actionLines.push(r.action.charAt(0).toUpperCase() + r.action.slice(1));
    }
    if (r.tasks) r.tasks.split(' + ').forEach(t => allTasks.add(t.trim()));
    if (r.needsFDR) needsFDR = true;
    if (r.deferWindow) deferWindows.push(r.deferWindow);
  });

  // Deduplicate action lines
  actionLines = [...new Set(actionLines)];

  // Find most restrictive deferral window
  let deferWindow = null;
  if (deferWindows.length) {
    if (deferWindows.some(w => w.includes('5 flight cycles'))) deferWindow = '100 flight hours or 5 flight cycles of discovery, whichever occurs later';
    else if (deferWindows.some(w => w.includes('25 flight cycles'))) deferWindow = '100 flight hours or 25 flight cycles of discovery, whichever occurs later';
  }

  // Build the ONE answer card
  let html = '';
  html += `<div class="result-answer ${overall}">`;

  if (overall === 'fly') {
    html += `<div class="ra-badge">NO INSPECTION REQUIRED</div>`;
    html += `<div class="ra-action">Aircraft is within limits. No overspeed inspection action needed.</div>`;
    html += `<div class="ra-line">Speed ${state.speed} KIAS at Flap ${state.flapPos} is within all applicable Phase I limits for both trailing edge and leading edge devices.</div>`;
  } else if (overall === 'defer') {
    html += `<div class="ra-badge">DEFERRABLE -- AIRCRAFT CAN FLY</div>`;
    html += `<div class="ra-action">Phase I Inspection required within ${deferWindow}.</div>`;
    html += `<hr class="ra-divider">`;
    actionLines.forEach(a => { html += `<div class="ra-line"><strong>&bull;</strong> ${a}</div>`; });
    if (needsFDR) {
      html += `<hr class="ra-divider">`;
      html += `<div class="ra-line"><strong>FDR DATA REVIEW:</strong> If Nz is unknown, review FDR data within 5 flight cycles of the overspeed event. If Nz is found outside 0.5-1.6 G, contact Boeing. If within 0.7-1.3 G, extended deferral (25 FC) may apply -- re-run this tool with updated Nz. If FDR data cannot be obtained, do Phase II before next flight.</div>`;
    }
    html += `<div class="ra-tasks">${[...allTasks].join(' | ')}</div>`;
  } else {
    html += `<div class="ra-badge">DO NOT DISPATCH</div>`;
    html += `<div class="ra-action">Inspections required before next flight.</div>`;
    html += `<hr class="ra-divider">`;
    actionLines.forEach(a => { html += `<div class="ra-line"><strong>&bull;</strong> ${a}</div>`; });
    // If one device is deferrable but the other grounds, note that
    const flyOrDefer = [te,le].filter(Boolean).filter(r=>r.level!=='ground');
    if (flyOrDefer.length > 0 && levels.includes('ground')) {
      html += `<hr class="ra-divider">`;
      flyOrDefer.forEach(r => {
        if (r.level==='fly') html += `<div class="ra-line" style="opacity:0.7"><strong>Note:</strong> ${r.action} (but aircraft grounded by other device).</div>`;
        else if (r.level==='defer') html += `<div class="ra-line" style="opacity:0.7"><strong>Note:</strong> ${r.action} would be deferrable on its own, but aircraft is grounded by the more restrictive result above.</div>`;
      });
    }
    if (needsFDR) {
      html += `<hr class="ra-divider">`;
      html += `<div class="ra-line"><strong>FDR DATA REVIEW:</strong> If Nz is unknown, review FDR data within 5 flight cycles. If Nz is found within 0.7-1.3 G, re-run with updated Nz for revised requirements.</div>`;
    }
    html += `<div class="ra-tasks">${[...allTasks].join(' | ')}</div>`;
  }

  html += `</div>`; // close result-answer

  // Section E reminder for any non-fly result
  if (overall !== 'fly') {
    html += `<div class="amm-note">
      <strong>SECTION E REMINDERS:</strong><br>
      - Phase II is still required even if Phase I has zero findings.<br>
      - If overload damage found during Phase I, do Phase II before next flight.<br>
      - If overload damage on one wing, do Phase II on BOTH wings.<br>
      - All damage must be evaluated for repairs/replacements.<br>
      - Load relief system does NOT eliminate inspection requirements.
    </div>`;
  }

  // Standby note
  if (state.system==='standby' && [1,2,5].includes(state.flapPos)) {
    html += `<div class="amm-note" style="margin-top:8px">
      <strong>STANDBY SYSTEM:</strong> Flap ${state.flapPos} extended via standby/alternate. TE limits adjusted per AMM footnotes (*[1] 230 KIAS, *[2] 245 KIAS). Leading edge not assessed (not deployed via standby).
    </div>`;
  }

  // DETAILS accordion
  html += `<button class="details-toggle" onclick="toggleDetails()" id="detailsToggle">
    <span>Details &amp; Speed Tables</span>
    <span class="arrow">&#9660;</span>
  </button>`;
  html += `<div class="details-content" id="detailsContent">`;

  // Per-device breakdown
  html += `<div class="detail-device">`;
  html += `<div class="detail-device-label ${te.level}-label">Trailing Edge Flaps -- ${te.level.toUpperCase()}</div>`;
  html += `<div class="detail-text">${te.detail}</div>`;
  if (te.deferWindow) html += `<div class="detail-text" style="margin-top:4px"><strong>Deferral:</strong> ${te.deferWindow}</div>`;
  if (te.tasks) html += `<div class="detail-text" style="margin-top:4px;font-family:JetBrains Mono,monospace;font-size:11px">${te.tasks}</div>`;
  html += `</div>`;

  if (le) {
    html += `<div class="detail-device">`;
    html += `<div class="detail-device-label ${le.level}-label">Leading Edge (Krueger/Slats) -- ${le.level.toUpperCase()}</div>`;
    html += `<div class="detail-text">${le.detail}</div>`;
    if (le.deferWindow) html += `<div class="detail-text" style="margin-top:4px"><strong>Deferral:</strong> ${le.deferWindow}</div>`;
    if (le.tasks) html += `<div class="detail-text" style="margin-top:4px;font-family:JetBrains Mono,monospace;font-size:11px">${le.tasks}</div>`;
    html += `</div>`;
  }

  // Speed tables
  html += renderSpeedTables();
  html += `</div>`; // close details-content

  c.innerHTML = html;
}

function toggleDetails() {
  const btn = document.getElementById('detailsToggle');
  const content = document.getElementById('detailsContent');
  btn.classList.toggle('open');
  content.classList.toggle('open');
}

function renderSpeedTables() {
  const f=state.flapPos, nz=state.nz;
  let html='';
  if (nz==='known_outside') return '';

  if (nz==='known_normal') {
    html+=buildTable('Table 202 -- TE Flap (Nz 0.7-1.3G) -- 737-7/8/8200',['Flap','Phase I','Phase II'],
      [1,2,5,10,15,25,30,40].map(p=>{const t=getTE202(p);const n=(state.system==='standby'&&[1,2,5].includes(p))?' SBY':([1,2,5].includes(p)?' *':'');return{highlight:p===f,cells:[p,t.phaseI+n,t.phaseII+n]};}));
    if (state.system==='normal')
      html+=buildTable('Table 204 -- LE (Nz 0.7-1.3G)',['Flap','Phase I','Phase II'],
        [1,2,5,10,15,25,30,40].map(p=>{const t=TABLE_204[p];const n=[1,2,5].includes(p)?' *':'';return{highlight:p===f,cells:[p,t.phaseI+n,t.phaseII+n]};}));
  } else {
    html+=buildTable('Table 203 -- TE Flap (Nz Unknown/Marginal) -- 737-7/8/8200',['Flap','Phase I','Deferral Limit'],
      [1,2,5,10,15,25,30,40].map(p=>{const t=getTE203(p);const n=(state.system==='standby'&&[1,2,5].includes(p))?' SBY':([1,2,5].includes(p)?' *':'');return{highlight:p===f,cells:[p,t.phaseI+n,t.deferral+n]};}));
    if (state.system==='normal')
      html+=buildTable('Table 205 -- LE (Nz Unknown/Marginal)',['Flap','Phase I','Deferral Limit'],
        [1,2,5,10,15,25,30,40].map(p=>{const t=TABLE_205[p];const n=[1,2,5].includes(p)?' *':'';return{highlight:p===f,cells:[p,t.phaseI+n,t.deferral+n]};}));
  }
  return html;
}

function buildTable(title,headers,rows) {
  let h=`<div class="speed-ref" style="margin-top:12px"><div class="speed-ref-title">${title}</div><table><tr>`;
  headers.forEach(hd=>{h+=`<th>${hd}</th>`;});
  h+='</tr>';
  rows.forEach(r=>{h+=`<tr${r.highlight?' class="highlight"':''}>`; r.cells.forEach(c=>{h+=`<td>${c}</td>`;}); h+='</tr>';});
  h+='</table></div>';
  return h;
}

function resetAll() {
  state={altitude:null,system:null,flapPos:null,speed:null,nz:null};
  document.getElementById('speedInput').value='';
  document.getElementById('speedNextBtn').disabled=true;
  document.getElementById('speedPreview').innerHTML='';
  document.querySelectorAll('.flap-btn').forEach(b=>b.classList.remove('selected'));
  goToStep(1);
}

updateProgress();
</script>
</body>
</html>
