<!DOCTYPE html>
<!-- MOC Toolbox v11.1 - 2025-02-25 faster transition -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOC Toolbox | swamx.com</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #1b2a45;
            --frame: #223352;
            --frame-border: #2e4368;
            --surface: #e2e7ef;
            --surface-hover: #d9dee8;
            --surface-alt: #dce2eb;
            --border: #e2e8f0;
            --border-strong: #cbd5e1;
            --accent: #2563eb;
            --accent-light: #3b82f6;
            --accent-dim: rgba(37, 99, 235, 0.08);
            --accent-glow: rgba(37, 99, 235, 0.15);
            --text: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-dim: #94a3b8;
            --text-on-dark: #e2e8f0;
            --text-on-dark-muted: #94a7c8;
            --text-on-dark-dim: #ffffff;
            --green: #16a34a;
            --amber: #d97706;
            --red: #dc2626;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --card-shadow-hover: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
            --cat-ata: #2563eb;
            --cat-aom: #16a34a;
            --cat-mpm: #d97706;
            --cat-fom: #7c3aed;
            --cat-mel: #dc2626;
            --cat-mxi: #0891b2;
            --cat-ifom: #db2777;
            --cat-frm: #ea580c;
            --cat-gom: #0d9488;
            --cat-misc: #6b7280;
            --cat-fam: #7c3aed;
            --cat-default: #64748b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: #1b2a45;
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            opacity: 0;
            transition: opacity 0.08s;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 24px;
            position: relative;
            z-index: 1;
        }

        /* ---- CLOCK ---- */
        .clock-area { display: flex; align-items: center; gap: 20px; margin-left: auto; }
        .cst-block { font-family: 'JetBrains Mono', monospace; }
        .cst-time { font-size: 18px; font-weight: 700; color: #ffffff; }
        .cst-time .cst-lbl { font-size: 11px; font-weight: 600; color: #34d399; letter-spacing: 1px; }
        .cst-date { font-size: 11px; font-weight: 600; color: #ffffff; margin-top: 3px; letter-spacing: 0.5px; }
        .cst-date .cst-day { color: #34d399; }
        .utc-block {
          font-family: 'JetBrains Mono', monospace;
          cursor: pointer; position: relative; user-select: none;
        }
        .utc-block:hover .utc-hint { opacity: 1; }
        .utc-digital .utc-time { font-size: 18px; font-weight: 700; color: #f9b612; }
        .utc-digital .utc-time .utc-lbl { font-size: 11px; font-weight: 600; color: #f9b612; letter-spacing: 1px; }
        .utc-analog { display: none; text-align: center; }
        .utc-analog canvas { display: block; margin: 0 auto; }
        .utc-analog-readout {
          font-family: 'JetBrains Mono', monospace;
          font-size: 13px; font-weight: 700; color: #f9b612;
          letter-spacing: 1px; margin-top: 4px;
        }
        .utc-hint {
          font-size: 8px; color: rgba(255,255,255,0.4); text-align: center;
          margin-top: 2px; opacity: 0; transition: opacity 0.2s; letter-spacing: 0.5px;
        }
        .utc-block.analog-mode .utc-digital { display: none; }
        .utc-block.analog-mode .utc-analog { display: block; }

        /* ---- UTILITY BAR (user info top-right) ---- */
        .utility-bar {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            padding: 8px 0 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
        }
        .utility-bar .ub-name { color: #ffffff; font-weight: 600; }
        .utility-bar .ub-role { font-size: 8px; padding: 2px 5px; border-radius: 3px; letter-spacing: 0.5px; text-transform: uppercase; font-weight: 600; }
        .utility-bar .ub-btn {
            color: rgba(255,255,255,0.5); cursor: pointer; font-family: 'JetBrains Mono', monospace;
            font-size: 9px; font-weight: 600; padding: 3px 8px;
            border: 1px solid rgba(255,255,255,0.15); border-radius: 4px;
            transition: all 0.15s; background: none;
        }
        .utility-bar .ub-btn:hover { color: #fff; border-color: rgba(255,255,255,0.4); }

        /* ---- HEADER ---- */
        header {
            padding: 0 0 0;
            border-bottom: 1px solid var(--frame-border);
        }

        .header-row {
            display: flex;
            align-items: center;
            gap: 20px;
            padding-top: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            width: auto;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-icon img {
            height: 100%;
            width: auto;
            object-fit: contain;
        }

        .logo h1 {
            font-size: 26px;
            font-weight: 900;
            letter-spacing: -0.5px;
            color: var(--text-on-dark);
        }

        .logo h1 span { color: var(--accent-light); }
        .ref-only {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 1.5px;
            color: #ef4444;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .domain-tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-on-dark-muted);
            background: var(--frame);
            border: 1px solid var(--frame-border);
            padding: 5px 10px;
            border-radius: 6px;
        }

        /* ---- NAV TABS ---- */
        .nav-tabs {
            display: flex;
            gap: 4px;
            padding: 20px 0 0;
        }

        .nav-tab {
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-on-dark-muted);
            background: none;
            border: none;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.15s ease;
            border-bottom: 2px solid transparent;
        }

        .nav-tab:hover { color: var(--text-on-dark); background: rgba(255,255,255,0.06); }

        .nav-tab.active {
            color: #ffffff;
            background: rgba(255,255,255,0.1);
            border-bottom: 2px solid var(--accent-light);
            font-weight: 600;
        }

        /* ---- SECTIONS ---- */
        .section { display: none; padding: 32px 0 48px; }
        .section.active { display: block; }

        /* ---- APPS SECTION ---- */
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 700px;
        }
        .app-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            text-decoration: none;
            color: var(--text);
            transition: all 0.15s;
            display: block;
            box-shadow: var(--card-shadow);
        }
        .app-card:hover {
            background: #fff;
            border-color: var(--accent);
            transform: translateY(-1px);
            box-shadow: var(--card-shadow-hover);
        }
        .app-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .app-korry {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px; font-weight: 700; letter-spacing: 0.5px;
            padding: 3px 5px; background: #1a1a1a; border-radius: 2px;
            border: 1px solid #444; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
            line-height: 1; flex-shrink: 0;
        }
        .ak-flap{color:#fca5a5;text-shadow:0 0 6px rgba(252,165,165,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(252,165,165,0.25);}
        .ak-rto{color:#fdba74;text-shadow:0 0 6px rgba(253,186,116,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(253,186,116,0.25);}
        .ak-leap{color:#67e8f9;text-shadow:0 0 6px rgba(103,232,249,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(103,232,249,0.25);}
        .app-card h3 { font-size: 12px; font-weight: 700; line-height: 1.3; color: var(--text); }
        .app-card p { color: var(--text); font-size: 11px; font-weight: 400; line-height: 1.4; }

        /* ---- QUICK REF SECTION ---- */
        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 400;
            color: var(--text);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: var(--card-shadow);
        }

        .search-input::placeholder { color: var(--text); }

        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* Unified search bar - shared across all tabs */
        .uni-search {
            position: relative;
            display: flex;
            align-items: center;
        }
        .uni-search .us-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-dim);
        }
        .uni-search .us-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .uni-search input {
            width: 100%;
            padding: 14px 16px 14px 46px;
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 400;
            color: var(--text);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: var(--card-shadow);
        }
        .uni-search input::placeholder { color: var(--text-dim); }
        .uni-search input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow, rgba(37,99,235,0.08));
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 24px;
        }

        /* Migration banner - temporary, not a card */
        .qrh-migrate-banner {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #92400e;
            padding: 8px 14px;
            margin-bottom: 12px;
            border-left: 4px solid #f59e0b;
            border-radius: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
            background-size: 200% 100%;
            animation: migratePulse 3s ease-in-out infinite;
        }
        .qrh-migrate-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #f59e0b;
            flex-shrink: 0;
            animation: migrateBlink 1.5s ease-in-out infinite;
        }
        @keyframes migratePulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes migrateBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .filter-chip {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        .filter-chip:hover { border-color: var(--accent-light); color: var(--text); }

        .filter-chip.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #ffffff;
        }

        .filter-chip .badge {
            font-size: 9px;
            font-weight: 700;
            background: rgba(0,0,0,0.06);
            padding: 1px 5px;
            border-radius: 8px;
            margin-left: 4px;
        }

        .filter-chip.active .badge {
            background: rgba(255, 255, 255, 0.25);
        }

        .results-area { min-height: 200px; }

        .results-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .results-empty p { font-size: 15px; font-weight: 400; line-height: 1.6; color: var(--text-on-dark-muted); }

        .results-empty .hint {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-on-dark-dim);
            margin-top: 8px;
        }

        .result-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-on-dark-muted);
            margin-bottom: 12px;
        }

        .result-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 8px;
            transition: all 0.15s ease;
            box-shadow: var(--card-shadow);
        }

        .result-card:hover {
            border-color: var(--accent-light);
            background: var(--surface);
            box-shadow: var(--card-shadow-hover);
        }

        .result-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 700;
            padding: 3px 5px;
            border-radius: 2px;
            white-space: nowrap;
            flex-shrink: 0;
            background: #1a1a1a;
            border: 1px solid #444;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
            line-height: 1;
        }

        .result-title {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            color: var(--text);
        }

        mark {
            background: rgba(250, 204, 21, 0.4);
            color: inherit;
            border-radius: 2px;
            padding: 0 2px;
        }

        .copy-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            margin-left: auto;
            flex-shrink: 0;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .copy-btn:hover {
            color: var(--text);
            background: var(--surface2);
        }

        .copy-btn.copied {
            color: var(--green);
            border-color: rgba(22, 163, 74, 0.3);
        }

        .scroll-top {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            z-index: 100;
            transition: all 0.2s;
        }

        .scroll-top:hover {
            transform: scale(1.1);
        }

        .scroll-top.visible {
            display: flex;
        }

        /* QRH tagline - SWA orange */
        .qrh-tagline {
            font-size: 16px;
            font-weight: 700;
            color: #e8600a;
            letter-spacing: -0.3px;
        }

        .stats-line {
            text-align: center;
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 8px;
            letter-spacing: 0.3px;
        }

        .stats-line span {
            color: #e8600a;
            font-weight: 700;
        }

        .search-hint {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-dim);
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 6px;
            pointer-events: none;
            opacity: 0.6;
        }

        .search-container {
            position: relative;
        }

        .result-refs {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .result-ref {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 5px;
            background: #fff;
            border: 1px solid var(--border);
            font-weight: 500;
        }

        .result-ref-link {
            cursor: pointer;
            color: #2563eb;
            border-color: rgba(37, 99, 235, 0.3);
            background: #fff;
            transition: all 0.15s;
            font-weight: 600;
        }

        .result-ref-link:hover {
            background: #dbeafe;
            border-color: rgba(37, 99, 235, 0.4);
            color: #1d4ed8;
        }

        .result-title-link {
            cursor: pointer;
            color: var(--accent) !important;
            transition: color 0.15s;
        }

        .result-title-link:hover {
            color: #1d4ed8 !important;
            text-decoration: underline;
        }

        .manual-choice-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .manual-choice-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 240px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .manual-choice-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--text);
        }

        .manual-choice-box button {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface-alt);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .manual-choice-box button:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: #ffffff;
        }

        .manual-choice-cancel {
            background: transparent !important;
            border-color: transparent !important;
            color: var(--text-muted) !important;
            font-weight: 400 !important;
        }

        .manual-choice-cancel:hover {
            color: var(--text) !important;
            background: transparent !important;
        }

        /* ---- APP RESULT CARD ---- */
        .app-result-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 10px;
            border-left: 3px solid #ea580c;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: var(--card-shadow);
        }

        .app-result-card:hover {
            background: var(--surface);
            border-color: rgba(234, 88, 12, 0.3);
            box-shadow: var(--card-shadow-hover);
        }

        .app-result-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-result-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .app-result-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
            line-height: 1.4;
        }

        .app-result-launch {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 700;
            color: #ea580c;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        /* ---- FLEET HEALTH ---- */
        .fh-top-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }
        .fh-chip-row {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .fh-chips-left {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            flex: 1;
        }
        .fh-chip-sep {
            width: 1px;
            height: 20px;
            background: var(--border);
            margin: 0 4px;
        }
        .fh-count {
            font-size: 9px;
            font-weight: 700;
            background: rgba(0,0,0,0.06);
            padding: 1px 5px;
            border-radius: 8px;
            margin-left: 4px;
        }
        .fix-chip.active .fh-count {
            background: rgba(255,255,255,0.25);
        }
        .fh-bulk-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        .fh-expand-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-dim);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            padding: 3px 8px;
            transition: all 0.15s;
        }
        .fh-expand-btn:hover { border-color: var(--accent); color: var(--text); }
        .fh-bulk-sep { color: var(--border); font-size: 10px; }

        /* Fleet/status chip row handled by .fh-chip-row */
        .fix-chip {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .fix-chip:hover { border-color: var(--accent); }
        .fix-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }

        .fix-results-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 12px;
        }

        .fix-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        .fix-card-header {
            padding: 14px 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }
        .fix-card-meta { flex: 1; }
        .fix-fault-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 2px;
        }
        .fix-effect {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }
        .fix-tags { display: flex; gap: 6px; flex-wrap: wrap; }
        .fix-tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 3px;
            letter-spacing: 0.5px;
        }
        .fix-tag-ata { background: rgba(37,99,235,0.1); color: #1d4ed8; border: 1px solid #93c5fd; }
        .fix-tag-fleet { background: rgba(22,163,74,0.1); color: #15803d; border: 1px solid #86efac; }

        .fix-card-body { padding: 14px 16px; }
        .fix-section { margin-bottom: 12px; }
        .fix-section:last-child { margin-bottom: 0; }
        .fix-section-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .fix-description {
            font-size: 13px;
            color: var(--text);
            line-height: 1.6;
        }

        .fix-actions { display: flex; flex-direction: column; gap: 6px; }
        .fix-action {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
        }
        .fix-action-name { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; }
        .fix-action-bar-wrap {
            width: 120px;
            height: 8px;
            background: #e2e7ef;
            border-radius: 4px;
            overflow: hidden;
        }
        .fix-action-bar { height: 100%; border-radius: 4px; }
        .bar-high { background: #16a34a; }
        .bar-med { background: #d97706; }
        .bar-low { background: #dc2626; }
        .fix-action-pct {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 700;
            width: 40px;
            text-align: right;
        }
        .pct-high { color: #15803d; }
        .pct-med { color: #b45309; }
        .pct-low { color: #b91c1c; }

        .fix-tsi {
            padding: 8px 12px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 4px;
        }
        .fix-tsi-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .fix-tsi-tail {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 700;
            color: var(--accent);
        }
        .fix-tsi-date {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
        }
        .fix-tsi-text { font-size: 12px; color: var(--text); line-height: 1.5; }
        .fix-tsi-result {
            font-size: 11px;
            color: #15803d;
            font-weight: 600;
            margin-top: 4px;
        }
        .fix-tsi-result.ineffective { color: #b91c1c; }

        .fix-empty-state {
            text-align: center;
            padding: 60px 24px;
            color: rgba(255,255,255,0.7);
        }
        .fix-empty-state p { font-size: 15px; margin-bottom: 4px; }
        .fix-empty-state .hint { font-size: 12px; }

        /* Fix Rate action buttons */
        .fix-action-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .fix-action-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 700;
            padding: 0 20px;
            height: 48px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            letter-spacing: 0.5px;
            white-space: nowrap;
            transition: all 0.15s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .fix-action-btn.primary { background: var(--accent); color: #fff; }
        .fix-action-btn.primary:hover { background: #1d4ed8; }
        .fix-action-btn.secondary { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid var(--frame-border); }
        .fix-action-btn.secondary:hover { background: rgba(255,255,255,0.14); }
        /* Status counts now in chips */

        /* Entry cards - 2-line collapsed */
        .fix-entry-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
            margin-bottom: 8px; box-shadow: var(--card-shadow); overflow: hidden; cursor: pointer;
            transition: border-color 0.15s;
        }
        .fix-entry-card:hover { border-color: var(--accent); }
        .fec-collapsed {
            padding: 10px 16px;
        }
        .fec-line1 {
            display: flex; align-items: center; gap: 0; font-size: 13px; font-weight: 600; color: var(--text);
        }
        .fec-line1 .fec-status {
            font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700;
            padding: 3px 7px; border-radius: 4px; letter-spacing: 0.5px; margin-right: 10px; flex-shrink: 0;
        }
        .fec-line1 .fec-sep { color: var(--text-dim); margin: 0 6px; font-weight: 400; }
        .fec-line1 .fec-tail { font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        .fec-line1 .fec-fleet { font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .fec-line1 .fec-fc { font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .fec-line1 .fec-due { font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-left: auto; flex-shrink: 0; }
        .fec-due-normal { color: var(--text); }
        .fec-due-today { color: #d97706; font-weight: 700; }
        .fec-due-overdue { color: #dc2626; font-weight: 700; }
        .fec-line2 {
            font-size: 12px; color: var(--text-secondary); margin-top: 3px; padding-left: 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .fts-work { background: #fbbf24; color: #1e293b; }
        .fts-closed { background: #4ade80; color: #1e293b; }
        .fts-repeat { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); }
        .fec-expanded {
            display: none;
            border-top: 1px solid var(--border);
        }
        .fix-entry-card.open .fec-expanded { display: block; }
        .fec-effect-full {
            padding: 12px 16px;
            font-size: 13px; font-weight: 700; color: var(--text); line-height: 1.5;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }
        .fec-details {
            padding: 10px 16px; display: flex; gap: 20px; flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
        }
        .fec-field { display: flex; flex-direction: column; gap: 1px; }
        .fec-label {
            font-family: 'JetBrains Mono', monospace; font-size: 9px; font-weight: 500;
            letter-spacing: 0.5px; color: var(--text); text-transform: uppercase;
        }
        .fec-val {
            font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 700; color: var(--text);
        }
        .fec-notes {
            margin: 10px 16px; padding: 10px 14px; font-size: 12px; color: var(--text); line-height: 1.5;
            background: #fff; border: 1px solid var(--border); border-radius: 6px;
        }
        .fec-corrective {
            margin: 0 16px 10px; padding: 10px 14px; font-size: 12px; color: var(--green-text); line-height: 1.5;
            background: var(--green-bg); border: 1px solid var(--green-border); border-radius: 6px;
        }
        .fec-actions {
            padding: 10px 16px; display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
            border-top: 1px solid var(--border);
        }
        .fec-updated {
            font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-dim);
            margin-left: 12px;
        }
        .fec-btn {
            font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700;
            padding: 6px 12px; border-radius: 5px; border: 1px solid; cursor: pointer;
            letter-spacing: 0.3px; transition: all 0.15s;
        }
        .fec-btn-update { background: var(--blue-bg); color: var(--blue-text); border-color: var(--blue-border); }
        .fec-btn-update:hover { background: #93c5fd; color: #1e3a5f; }
        .fec-btn-close { background: var(--green-bg); color: var(--green-text); border-color: var(--green-border); }
        .fec-btn-close:hover { background: #86efac; color: #14532d; }
        .fec-btn-reopen { background: var(--blue-bg); color: var(--blue-text); border-color: var(--blue-border); }
        .fec-btn-reopen:hover { background: #93c5fd; color: #1e3a5f; }
        .fec-btn-del { background: none; color: var(--text-dim); border-color: var(--border); margin-left: auto; }
        .fec-btn-del:hover { background: var(--red-bg); color: var(--red-text); border-color: var(--red-border); }
        .fec-audit {
            padding: 8px 16px;
            font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-dim);
            line-height: 1.8;
            border-top: 1px solid var(--border);
        }

        /* Status filter chips */
        .fix-status-chip.active { background: rgba(255,255,255,0.15); color: #fff; border-color: rgba(255,255,255,0.3); }

        /* Closeout action chips */
        .fco-chip {
            font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700;
            padding: 8px 14px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--surface); color: var(--text); cursor: pointer; transition: all 0.15s;
        }
        .fco-chip:hover { border-color: var(--accent); background: var(--blue-bg); }
        .fco-chip.selected { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* TSI Modal */
        .tsi-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px;}
        .tsi-modal-overlay.open{display:flex;}
        .tsi-modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
        .tsi-modal-header{padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
        .tsi-modal-header h2{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--text);}
        .tsi-modal-close{background:none;border:none;font-size:20px;color:var(--text-dim);cursor:pointer;padding:4px;}
        .tsi-modal-close:hover{color:var(--text);}
        .tsi-modal-body{padding:14px 20px 8px;}
        .tsi-modal-footer{padding:10px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;}
        .tsi-form-group{margin-bottom:12px;}
        .tsi-form-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text);margin-bottom:6px;display:block;}
        .tsi-form-label .req{color:var(--red);}
        .tsi-form-input,.tsi-form-textarea{width:100%;padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);background:#fff;border:1px solid var(--border);border-radius:8px;outline:none;transition:border-color 0.15s;box-sizing:border-box;text-transform:uppercase;}
        .tsi-form-input:focus,.tsi-form-textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,0.1);}
        .tsi-form-textarea{min-height:80px;resize:vertical;line-height:1.5;}
        .tsi-form-row{display:flex;gap:12px;}
        .tsi-form-row .tsi-form-group{flex:1;}
        .tsi-tail-wrap{position:relative;}
        .tsi-tail-dd{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:50;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.12);}
        .tsi-tail-dd.open{display:block;}
        .tsi-tail-opt{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;transition:background 0.1s;}
        .tsi-tail-opt:hover,.tsi-tail-opt.highlighted{background:var(--blue-bg);}
        .tsi-tail-opt .tt-tail{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--text);}
        .tsi-tail-opt .tt-fleet{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);}
        .tsi-fc-wrap{position:relative;}
        .tsi-fc-dd{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;max-height:340px;overflow-y:auto;z-index:50;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.12);}
        .tsi-fc-dd.open{display:block;}
        .tsi-fc-opt{padding:8px 12px;cursor:pointer;display:flex;flex-direction:column;gap:2px;transition:background 0.1s;border-bottom:1px solid var(--surface2);}
        .tsi-fc-opt:last-child{border-bottom:none;}
        .tsi-fc-opt:hover,.tsi-fc-opt.highlighted{background:var(--blue-bg);}
        .tsi-fc-opt .tfc-code{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:12px;color:var(--text);}
        .tsi-fc-opt .tfc-msg{font-size:11px;color:var(--text-secondary);line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .tsi-fc-opt .tfc-task{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);}
        .tsi-action-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
        .tsi-action-chip{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;padding:5px 10px;border-radius:5px;border:1px solid var(--border);background:#fff;color:var(--text-secondary);cursor:pointer;transition:all 0.15s;}
        .tsi-action-chip:hover{border-color:var(--accent);color:var(--accent);}
        .tsi-action-chip.selected{background:var(--accent);color:#fff;border-color:var(--accent);}
        .tsi-form-display{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--text);padding:10px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;min-height:42px;display:flex;align-items:center;}
        .tsi-save-btn{padding:8px 20px;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--text);}
        .tsi-save-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
        .tsi-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:10px 20px;border-radius:8px;font-size:13px;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:opacity 0.3s;}
        @media(max-width:640px){ .tsi-form-row{flex-direction:column;gap:0;} }

        /* ---- QUICK LINKS ---- */
        /* ---- QUICK LINKS v2: Masonry + Korry ---- */
        .ql-search input{padding-right:220px;}
        .ql-search .qs-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;display:none;padding:0 4px;}
        .ql-search .qs-clear.show{display:block;}
        .ql-search .qs-hint{position:absolute;right:34px;top:50%;transform:translateY(-50%);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;color:#ffffff;background:var(--accent);padding:3px 8px;border-radius:4px;border:none;flex-shrink:0;display:none;letter-spacing:0.3px;}
        .ql-search .qs-hint.show{display:block;}

        .ql-fav-sec{margin-bottom:10px;border-bottom:1px solid var(--frame-border);padding:6px 0;display:flex;align-items:flex-start;gap:8px;min-height:28px;}
        .ql-fav-star{font-size:14px;color:#facc15;flex-shrink:0;line-height:1;padding-top:2px;}
        .ql-fav-row{display:flex;flex-wrap:wrap;gap:5px;align-items:center;flex:1;}
        .ql-fav-empty{display:none;}
        .ql-fav-chip{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:4px 9px;display:inline-flex;align-items:center;gap:5px;text-decoration:none;cursor:pointer;transition:all 0.15s;box-shadow:0 1px 2px rgba(0,0,0,0.04);}
        .ql-fav-chip:hover{border-color:var(--accent);box-shadow:var(--card-shadow-hover);}
        .ql-fav-chip .qfc-n{font-size:11px;font-weight:700;color:var(--text);white-space:nowrap;}
        .ql-fav-chip .qfc-x{font-size:9px;color:var(--text-dim);cursor:pointer;transition:color 0.15s;}
        .ql-fav-chip .qfc-x:hover{color:var(--red);}

        .ql-masonry{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;overflow:hidden;margin:0 -24px;}
        .ql-masonry .ql-col{width:190px;flex-shrink:0;flex-grow:0;display:flex;flex-direction:column;gap:10px;}
        .ql-sec-card{background:rgba(0,0,0,0.15);border:1px solid var(--frame-border);border-radius:7px;overflow:hidden;}
        .ql-sec-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;cursor:pointer;user-select:none;background:rgba(0,0,0,0.2);border-bottom:1px solid var(--frame-border);}
        .ql-sec-hdr h3{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#ffffff;margin:0;}
        .ql-sec-hdr .ql-cnt{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-on-dark);background:rgba(255,255,255,0.1);padding:1px 5px;border-radius:3px;margin-left:5px;}
        .ql-sec-hdr .ql-arr{color:var(--text-on-dark-dim);font-size:9px;transition:transform 0.15s;}
        .ql-sec-hdr.collapsed .ql-arr{transform:rotate(-90deg);}
        .ql-sec-list{padding:3px;}
        .ql-sec-list.hidden{display:none;}

        .ql-tile{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:5px 8px;display:flex;align-items:center;gap:7px;margin-bottom:2px;cursor:pointer;transition:all 0.12s;text-decoration:none;box-shadow:var(--card-shadow);position:relative;}
        .ql-tile:hover{border-color:var(--accent-light,#2563eb);box-shadow:var(--card-shadow-hover);transform:translateY(-1px);background:#fff;}
        .ql-tile .ql-name{font-size:12px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
        .ql-tile .ql-star{background:none;border:none;cursor:pointer;font-size:12px;color:#8896a8;opacity:1;transition:all 0.1s;flex-shrink:0;padding:2px 4px;}
        .ql-tile:hover .ql-star{color:#6b7a8d;}
        .ql-tile .ql-star.fv{color:#facc15;opacity:1;}
        .ql-tile .ql-star:hover{opacity:1;}

        .korry{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;letter-spacing:0.5px;padding:3px 5px;background:#1a1a1a;border-radius:2px;border:1px solid #444;box-shadow:inset 0 1px 3px rgba(0,0,0,0.5);flex-shrink:0;line-height:1;}
        .k-qb{color:#c4b5fd;text-shadow:0 0 6px rgba(196,181,253,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(196,181,253,0.25);}
        .k-prg{color:#fda4af;text-shadow:0 0 6px rgba(253,164,175,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(253,164,175,0.25);}
        .k-sp{color:#93c5fd;text-shadow:0 0 6px rgba(147,197,253,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(147,197,253,0.25);}
        .k-wx{color:#5eead4;text-shadow:0 0 6px rgba(94,234,212,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(94,234,212,0.25);}
        .k-trn{color:#fcd34d;text-shadow:0 0 6px rgba(252,211,77,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(252,211,77,0.25);}
        .k-mbf{color:#67e8f9;text-shadow:0 0 6px rgba(103,232,249,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(103,232,249,0.25);}
        .k-c365{color:#fbbf24;text-shadow:0 0 6px rgba(251,191,36,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(251,191,36,0.25);}
        .k-tab{color:#f97316;text-shadow:0 0 6px rgba(249,115,22,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(249,115,22,0.25);}
        .k-aom{color:#fca5a5;text-shadow:0 0 6px rgba(252,165,165,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(252,165,165,0.25);}
        .k-fom{color:#fdba74;text-shadow:0 0 6px rgba(253,186,116,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(253,186,116,0.25);}
        .k-mpm{color:#fcd34d;text-shadow:0 0 6px rgba(252,211,77,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(252,211,77,0.25);}
        .k-dom{color:#d8b4fe;text-shadow:0 0 6px rgba(216,180,254,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(216,180,254,0.25);}
        .k-gom{color:#86efac;text-shadow:0 0 6px rgba(134,239,172,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(134,239,172,0.25);}
        .k-mel{color:#fca5a5;text-shadow:0 0 8px rgba(252,165,165,0.6);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 6px rgba(252,165,165,0.3);}
        .k-frm{color:#fdba74;text-shadow:0 0 6px rgba(253,186,116,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(253,186,116,0.25);}
        .k-ifom{color:#fca5a5;text-shadow:0 0 6px rgba(252,165,165,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(252,165,165,0.25);}
        .k-toh{color:#fdba74;text-shadow:0 0 6px rgba(253,186,116,0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(253,186,116,0.25);}

        .ql-tile.ql-sh{display:none;}
        .ql-tile.ql-sm{border-color:var(--accent-light,#2563eb);background:#fff !important;box-shadow:0 0 0 1px var(--accent-light,#2563eb);}
        .ql-tile.ql-sm .ql-name{color:#1d4ed8;}
        .ql-tile.ql-sm-first{border-color:var(--accent-light,#2563eb);background:#dbeafe !important;box-shadow:0 0 0 2px var(--accent-light,#2563eb);}
        .ql-tile.ql-sm-first .ql-name{color:#1e40af;}
        .ql-sec-card.ql-sh{display:none;}
        .ql-no-results{text-align:center;padding:30px;color:var(--text-on-dark-dim);font-size:13px;display:none;}
        .ql-no-results.show{display:block;}

        /* ---- CARD NOTES & FILES ---- */
        .card-indicator {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.15s;
            letter-spacing: 0.5px;
        }

        .note-indicator {
            background: #1a1a1a;
            color: #86efac;
            border: 1px solid #444;
            text-shadow: 0 0 6px rgba(134,239,172,0.5);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 4px rgba(134,239,172,0.25);
        }

        .note-indicator:hover {
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 8px rgba(134,239,172,0.4);
        }

        .file-indicator {
            background: #1a1a1a;
            color: #c4b5fd;
            border: 1px solid #444;
            text-shadow: 0 0 6px rgba(196,181,253,0.5);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 4px rgba(196,181,253,0.25);
        }

        .file-indicator:hover {
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 8px rgba(196,181,253,0.4);
        }

        .card-note {
            display: none;
            margin-top: 10px;
            padding: 10px 12px;
            background: rgba(217, 119, 6, 0.05);
            border: 1px solid rgba(217, 119, 6, 0.15);
            border-radius: 6px;
        }

        .card-note.visible {
            display: block;
        }

        .card-note-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 700;
            color: #d97706;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .card-note-text {
            font-size: 13px;
            color: var(--text);
            line-height: 1.5;
        }

        /* ---- AUTOCOMPLETE ---- */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 2px solid var(--accent);
            border-top: 1px solid var(--border);
            border-radius: 0 0 12px 12px;
            max-height: 260px;
            overflow-y: auto;
            z-index: 50;
            display: none;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.15), 0 12px 32px rgba(0,0,0,0.15);
            margin-top: -2px;
            clip-path: inset(0 0 0 0 round 0 0 12px 12px);
        }

        .autocomplete-dropdown::-webkit-scrollbar {
            width: 6px;
        }
        .autocomplete-dropdown::-webkit-scrollbar-track {
            background: transparent;
            margin-bottom: 12px;
        }
        .autocomplete-dropdown::-webkit-scrollbar-thumb {
            background: rgba(37,99,235,0.3);
            border-radius: 3px;
        }
        .autocomplete-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(37,99,235,0.5);
        }

        .autocomplete-dropdown.visible {
            display: block;
        }

        .search-container:has(.autocomplete-dropdown.visible) .search-input {
            border-radius: 12px 12px 0 0;
            border: 2px solid var(--accent);
            border-bottom-color: transparent;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
        }

        .ac-item {
            padding: 10px 16px 10px 48px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text);
            border-bottom: 1px solid rgba(0,0,0,0.04);
            transition: background 0.1s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ac-item:last-child {
            border-bottom: none;
        }

        .ac-item:hover {
            background: var(--surface2);
        }

        .ac-item.selected {
            background: #dbeafe;
        }

        .ac-item-tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 700;
            padding: 3px 5px;
            border-radius: 2px;
            flex-shrink: 0;
            background: #1a1a1a;
            border: 1px solid #444;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }

        .ac-type-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 700;
            padding: 3px 5px;
            border-radius: 2px;
            flex-shrink: 0;
            letter-spacing: 0.5px;
            background: #1a1a1a;
            border: 1px solid #444;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
            line-height: 1;
        }

        .ac-type-qrh {
            color: #93c5fd;
            text-shadow: 0 0 6px rgba(147,197,253,0.5);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 4px rgba(147,197,253,0.25);
        }

        .ac-type-defect {
            color: #fda4af;
            text-shadow: 0 0 6px rgba(253,164,175,0.5);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 4px rgba(253,164,175,0.25);
        }

        .ac-type-template {
            color: #86efac;
            text-shadow: 0 0 6px rgba(134,239,172,0.5);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 4px rgba(134,239,172,0.25);
        }

        .ac-type-app {
            color: #fdba74;
            text-shadow: 0 0 6px rgba(253,186,116,0.5);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 4px rgba(253,186,116,0.25);
        }

        .ac-type-link {
            color: #5eead4;
            text-shadow: 0 0 6px rgba(94,234,212,0.5);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 4px rgba(94,234,212,0.25);
        }

        .ac-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ac-item mark {
            background: rgba(250, 204, 21, 0.4);
            color: inherit;
            border-radius: 2px;
            padding: 0 2px;
        }

        /* ---- FOOTER ---- */
        footer {
            border-top: 1px solid var(--frame-border);
            padding: 28px 0;
            text-align: center;
        }

        footer p {
            color: var(--text-on-dark-dim);
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
        }

        @media (max-width: 640px) {
            header { padding: 0; }
            .header-row { flex-direction: column; align-items: flex-start; gap: 10px; padding-top: 6px; }
            .clock-area { margin-left: 0; }
            .logo h1 { font-size: 22px; }
            .clock-area { gap: 14px; flex-wrap: wrap; }
            .cst-time { font-size: 16px; }
            .utc-digital .utc-time { font-size: 16px; }
            .utc-analog canvas { width: 110px !important; height: 110px !important; }
            .apps-grid { grid-template-columns: 1fr; }
            .search-input { font-size: 15px; padding: 14px 14px 14px 44px; }
            .uni-search input { font-size: 14px; padding: 12px 14px 12px 42px; }
            .utility-bar { padding: 6px 0 0; gap: 6px; }
            .utility-bar .ub-name { font-size: 9px; }
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section.active { animation: fadeUp 0.3s ease both; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
    /* ---- LOGIN OVERLAY ---- */
    #loginOverlay {
      position: fixed; inset: 0; z-index: 99999;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    #loginOverlay::before {
      content: '';
      position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(37,99,235,0.08) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(37,99,235,0.05) 0%, transparent 50%);
      pointer-events: none;
    }
    #loginOverlay { display: none; }
    #loginOverlay.visible { display: flex; }
    .login-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
      width: 100%; max-width: 400px; padding: 40px 36px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.05);
      position: relative; z-index: 1; margin: 20px;
    }
    .login-logo { display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 8px; }
    .login-logo img { height: 52px; }
    .login-logo-text h1 { font-family: 'Outfit', sans-serif; font-size: 26px; font-weight: 900; letter-spacing: -0.5px; color: var(--text); line-height: 1; }
    .login-logo-text h1 span { color: var(--accent-light); }
    .login-ref { font-family: 'JetBrains Mono', monospace; font-size: 9px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--red); text-align: center; margin-bottom: 32px; }
    .login-label { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 6px; display: block; }
    .login-input { width: 100%; padding: 12px 14px; font-family: 'DM Sans', sans-serif; font-size: 15px; color: var(--text); background: #fff; border: 1px solid var(--border); border-radius: 8px; outline: none; transition: border-color 0.15s; margin-bottom: 20px; box-sizing: border-box; }
    .login-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .login-input::placeholder { color: #94a3b8; }
    .login-btn { width: 100%; padding: 13px; font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 700; letter-spacing: 1px; color: #fff; background: var(--accent); border: none; border-radius: 8px; cursor: pointer; transition: background 0.15s; }
    .login-btn:hover { background: #1d4ed8; }
    .login-btn:disabled { background: #64748b; cursor: not-allowed; }
    .login-error { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--red); text-align: center; margin-top: 12px; min-height: 16px; }
    .login-footer { font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-dim); text-align: center; margin-top: 20px; letter-spacing: 0.5px; }
    /* Main content hidden until auth */
    #mainApp { display: none; }
    #mainApp.authed { display: block; }
    /* User badge styles now in utility bar */
    .user-badge { display: none; }
    .ub-role-admin { background: rgba(37,99,235,0.15); color: #93c5fd; border: 1px solid rgba(37,99,235,0.3); }
    .ub-role-editor { background: rgba(22,163,74,0.15); color: #86efac; border: 1px solid rgba(22,163,74,0.3); }
    .ub-role-viewer { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
  <div class="login-card">
    <div class="login-logo">
      <img src="logo.webp" alt="MOC Toolbox">
      <div class="login-logo-text">
        <h1>MOC <span>Toolbox</span></h1>
        <div class="login-ref" style="font-style:italic;text-align:left;margin-bottom:0;">For reference use only</div>
      </div>
    </div>
    <div style="margin-bottom:32px;"></div>
    <label class="login-label">Employee Number</label>
    <input type="text" class="login-input" id="loginENum" placeholder="Enter your E#" autocomplete="off">
    <label class="login-label">Access Code</label>
    <input type="password" class="login-input" id="loginCode" placeholder="Enter 4-digit code">
    <button class="login-btn" id="loginBtn" onclick="doLogin()">SIGN IN</button>
    <div class="login-error" id="loginError"></div>
    <div class="login-footer">Maintenance Operations Center - Southwest Airlines</div>
  </div>
</div>

<script src="auth.js"></script>
<script>
// ---- INDEX.HTML: AUTH HOOKS ----
var db = window.MOC_DB;
var auth = window.MOC_AUTH;

// Listen for auth ready from shared auth.js
window.addEventListener('moc-auth-ready', function() {
  document.getElementById('loginOverlay').classList.remove('visible');
  document.getElementById('mainApp').classList.add('authed');

  // Update utility bar
  if (CURRENT_USER) {
    var nameEl = document.getElementById('ubName');
    var roleEl = document.getElementById('ubRole');
    if (nameEl) nameEl.textContent = CURRENT_USER.name || '';
    if (roleEl) {
      var role = (CURRENT_USER.role || 'viewer').toUpperCase();
      roleEl.textContent = role;
      roleEl.className = 'ub-role ub-role-' + (CURRENT_USER.role || 'viewer');
    }
  }

  // Show roster sync button for admin
  var syncBtn = document.getElementById('rosterSyncBtn');
  if (syncBtn) syncBtn.style.display = window.mocIsAdmin() ? '' : 'none';

  applyRolePermissions();
  if (typeof loadTsiEntries === 'function') loadTsiEntries();
});

function applyRolePermissions() {
  var canEdit = window.mocCanEdit();
  var addBtn = document.querySelector('.fix-action-btn.primary');
  if (addBtn) addBtn.style.display = canEdit ? '' : 'none';
}

// ---- LOGIN (calls shared auth.js) ----
function doLogin() {
  var enumVal = document.getElementById('loginENum').value;
  var code = document.getElementById('loginCode').value;
  var errEl = document.getElementById('loginError');
  var btn = document.getElementById('loginBtn');

  var result = window.mocDoLogin(enumVal, code);
  if (result && result.error) {
    errEl.textContent = result.error;
    return;
  }
  btn.disabled = true;
  btn.textContent = 'SIGNING IN...';
  errEl.textContent = '';
}

// ---- ROSTER SYNC (admin only) ----
function syncRoster() {
  var btn = document.getElementById('rosterSyncBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'SYNCING...'; }
  window.mocSyncRoster().then(function(count) {
    if (btn) { btn.disabled = false; btn.textContent = 'SYNC ROSTER'; }
    alert('Roster synced: ' + count + ' entries');
  }).catch(function(err) {
    if (btn) { btn.disabled = false; btn.textContent = 'SYNC ROSTER'; }
    alert('Sync failed: ' + err);
  });
}

// Enter key on inputs
document.getElementById('loginENum').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') document.getElementById('loginCode').focus();
});
document.getElementById('loginCode').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') doLogin();
});
</script>

<!-- MAIN APP (hidden until auth) -->
<div id="mainApp">
    <div class="container">

        <header>
            <div class="utility-bar" id="utilityBar">
                <span class="ub-name" id="ubName"></span>
                <span class="ub-role" id="ubRole"></span>
                <button class="ub-btn" id="rosterSyncBtn" style="display:none;" onclick="syncRoster()">SYNC ROSTER</button>
                <button class="ub-btn" id="ubSignOut" onclick="mocSignOut()">Sign Out</button>
            </div>
            <div class="header-row">
                <div class="logo">
                    <div class="logo-icon"><img src="logo.webp" alt="MOC Toolbox"></div>
                    <div class="logo-text-wrap">
                        <h1>MOC <span>Toolbox</span></h1>
                        <div class="ref-only" style="font-style:italic;">For reference use only</div>
                    </div>
                </div>
                <div class="clock-area" id="clockArea">
                  <div class="cst-block">
                    <div class="cst-time"><span class="cst-lbl">CST</span> <span id="cstTime">--:--</span></div>
                    <div class="cst-date"><span class="cst-day" id="cstDay">---</span> <span id="cstDate">--/--/----</span></div>
                  </div>
                  <div class="utc-block" id="utcBlock" onclick="toggleUtcClock()">
                    <div class="utc-digital">
                      <div class="utc-time"><span class="utc-lbl">UTC</span> <span id="utcDigital">--:--</span></div>
                    </div>
                    <div class="utc-analog">
                      <canvas id="utcCanvas" width="280" height="280" style="width:140px;height:140px;"></canvas>
                      <div class="utc-analog-readout" id="utcAnalog">--:--Z</div>
                    </div>
                    <div class="utc-hint">click to toggle</div>
                  </div>
                </div>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="quicklinks">Quick Links</button>
                <button class="nav-tab" data-tab="fixrate">Fleet Health</button>
                <button class="nav-tab" data-tab="quickref">Quick Reference</button>
                <button class="nav-tab" data-tab="apps">Apps</button>
            </div>
        </header>

        <!-- APPS -->
        <section id="apps" class="section">
            <div class="apps-grid">
                <a href="flap-overspeed.html" class="app-card">
                    <div class="app-card-header">
                        <span class="app-korry ak-flap">FLAP</span>
                        <h3>Flap/Slat Overspeed</h3>
                    </div>
                    <p>Phase I/II limits, Nz, deferral windows</p>
                </a>

                <a href="rto.html" class="app-card">
                    <div class="app-card-header">
                        <span class="app-korry ak-rto">RTO</span>
                        <h3>RTO / Brake Cooling</h3>
                    </div>
                    <p>High-energy stop, MQTW, reporting chain</p>
                </a>

                <a href="leap-1b.html" class="app-card">
                    <div class="app-card-header">
                        <span class="app-korry ak-leap">LEAP</span>
                        <h3>LEAP-1B Engine Ref</h3>
                    </div>
                    <p>Inlet cowl, fan module, inspection criteria</p>
                </a>

            </div>
        </section>

        <!-- QUICK LINKS -->
        <section id="quicklinks" class="section active">
            <div class="ql-search uni-search" style="margin-bottom:12px;">
                <span class="us-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
                <input type="text" id="qlSearchInput" placeholder="Search all links..." oninput="qlFilter()" onkeydown="qlKeyNav(event)">
                <span class="qs-hint" id="qlHint">TAB to cycle, ENTER to open</span>
                <button class="qs-clear" id="qlClear" onclick="qlClearSearch()">&#10005;</button>
            </div>
            <div class="ql-fav-sec" id="qlFavSec">
                <span class="ql-fav-star">&#9733;</span>
                <div class="ql-fav-row" id="qlFavRow"></div>
            </div>
            <div class="ql-masonry" id="qlMasonry"></div>
            <div class="ql-no-results" id="qlNoResults">No links match your search.</div>
        </section>

        <!-- TSI FIX RATE -->
        <section id="fixrate" class="section">
            <div class="fh-top-row">
                <button class="fix-action-btn primary" onclick="openTsiModal()">+ ADD TSI</button>
                <div class="fh-search-wrap uni-search" style="flex:1;">
                    <span class="us-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
                    <input type="text" id="fixSearchInput" placeholder="Search tail / fault / ATA..." autocomplete="off">
                </div>
            </div>
            <div class="fh-chip-row">
                <div class="fh-chips-left">
                    <button class="fix-chip active" data-fix-filter="ALL">ALL</button>
                    <button class="fix-chip" data-fix-filter="MAX 8">MAX 8</button>
                    <button class="fix-chip" data-fix-filter="MAX 7">MAX 7</button>
                    <button class="fix-chip" data-fix-filter="NG 800">NG 800</button>
                    <button class="fix-chip" data-fix-filter="NG 700">NG 700</button>
                    <span class="fh-chip-sep"></span>
                    <button class="fix-chip fix-status-chip active" data-status-filter="IN WORK">IN WORK <span class="fh-count" id="fhCountWork">0</span></button>
                    <button class="fix-chip fix-status-chip" data-status-filter="CLOSED">CLOSED <span class="fh-count" id="fhCountClosed">0</span></button>
                    <button class="fix-chip fix-status-chip" data-status-filter="REPEAT">REPEAT <span class="fh-count" id="fhCountRepeat">0</span></button>
                </div>
                <div class="fh-bulk-actions">
                    <button class="fh-expand-btn" onclick="fhExpandAll()">Expand All</button>
                    <span class="fh-bulk-sep">|</span>
                    <button class="fh-expand-btn" onclick="fhCollapseAll()">Collapse All</button>
                </div>
            </div>
            <div id="fixResults">
                <div class="fix-empty-state">
                    <p>No TSI entries yet</p>
                    <p class="hint">Click + ADD TSI to create your first entry</p>
                </div>
            </div>
        </section>

        <!-- Closeout modal -->
        <div class="tsi-modal-overlay" id="fixCoOverlay">
            <div class="tsi-modal" style="max-width:480px;">
                <div class="tsi-modal-header"><h2>Close TSI</h2><button class="tsi-modal-close" onclick="fixCoCancel()">&times;</button></div>
                <div class="tsi-modal-body">
                    <div class="tsi-form-group">
                        <label class="tsi-form-label">ACTION TAKEN <span class="req">*</span></label>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;">
                            <span class="fco-chip" onclick="fcoPickAction(this)">REMOVE/REPLACE</span>
                            <span class="fco-chip" onclick="fcoPickAction(this)">REPAIR</span>
                            <span class="fco-chip" onclick="fcoPickAction(this)">RESET/OPS CK</span>
                            <span class="fco-chip" onclick="fcoPickAction(this)">NFF</span>
                        </div>
                    </div>
                    <div class="tsi-form-group">
                        <label class="tsi-form-label">CORRECTIVE ACTION <span class="req">*</span></label>
                        <textarea id="fcoNotes" class="tsi-form-input" rows="3" placeholder="R/R #1 IASC P/N 1234, OPS CK SAT..." style="resize:vertical;min-height:70px;"></textarea>
                    </div>
                    <div class="tsi-form-group">
                        <label class="tsi-form-label">CLOSE DATE</label>
                        <input type="date" id="fcoDate" class="tsi-form-input">
                    </div>
                </div>
                <div class="tsi-modal-footer">
                    <button class="tsi-save-btn" onclick="fixCoCancel()">CANCEL</button>
                    <button class="tsi-save-btn primary" onclick="fixCoConfirm()">CLOSE ENTRY</button>
                </div>
            </div>
        </div>

        <!-- QUICK REFERENCE -->
        <section id="quickref" class="section">
            <div class="search-container uni-search">
                <span class="us-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
                <input type="text" class="search-input" id="searchInput" placeholder="Search the entire Toolbox..." autocomplete="off">
                <span class="search-hint" id="searchHint">/</span>
                <div class="autocomplete-dropdown" id="acDropdown"></div>
            </div>

            <div class="qrh-migrate-banner">
                <span class="qrh-migrate-dot"></span>
                MIGRATION IN PROGRESS - Some entries may not have linked references yet
            </div>

            <div class="filter-row" id="filterRow">
                <button class="filter-chip active" data-filter="ALL">ALL</button>
                <button class="filter-chip" data-filter="ATA">ATA</button>
                <button class="filter-chip" data-filter="AOM">AOM</button>
                <button class="filter-chip" data-filter="MPM">MPM</button>
                <button class="filter-chip" data-filter="FOM">FOM</button>
                <button class="filter-chip" data-filter="MEL">MEL</button>
                <button class="filter-chip" data-filter="MXI">MXI</button>
                <button class="filter-chip" data-filter="IFOM">IFOM</button>
                <button class="filter-chip" data-filter="FRM">FRM</button>
                <button class="filter-chip" data-filter="GOM">GOM</button>
                <button class="filter-chip" data-filter="MISC">MISC</button>
                <button class="filter-chip" data-filter="FIX">FIX</button>
                <button class="filter-chip" data-filter="APP">APP</button>
            </div>

            <div class="results-area" id="resultsArea">
                <div class="results-empty">
                    <p>Search for anything -- ATA codes, procedures, faults, tips</p>
                    <p class="hint">Type to search or select a category filter</p>
                    <div class="stats-line" id="statsLine"></div>
                </div>
            </div>
        </section>

        <footer>
            <p>MOC Toolbox | swamx.com</p>
        </footer>

    </div>

    <button class="scroll-top" id="scrollTop" onclick="window.scrollTo({top:0,behavior:'smooth'})">&#8593;</button>

    <script>
        // ---- TAB SWITCHING ----
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // ---- REFERENCE DATA ----
        // Format: { cat: "ATA 28", title: "FUEL TANK FLOAT SWITCH T/S", refs: ["REF 1", "REF 2"] }
        const DATA = [
  {cat:"MPM",title:"MPM 52.6.5 Info Only Item Defect Procedure",refs:["MPM 6.5.2 Flight Deck Crew Reset of Tripped C/B", "FOM 19.2.6.1 INFO ONLY ITEM", "AOM 3.7.1-3 CYCLE C/B"]},
  {cat:"ATA 05",title:"FLAP OVERSPEED",refs:["AOM 3.9 FLT CONTROLS (Flaps Placard Limit Speed)", "AOM 16.5.3.5 ACARS MSGS (OVRSPD Messages)", "VMO 360 & ABOVE INSP REQ", "MMO .84 & ABOVE INSP REQ"],note:"Use the Flap Overspeed app for step-by-step decision flow. Normal vs standby flap system matters for inspection scope."},
  {cat:"AOM",title:"AOM 3.8.4 MIN ENG OIL QTY",refs:[],note:"Oil qty is departure minimum, not arrival. Check consumption rate before deferring. Dispatch frequently asks about this at outstations."},
  {cat:"ATA 05",title:"HIGH WIND, HAIL OR FLEET CAMPAIGN EXCEL TRACK",refs:["HAIL STRIKE - RBD/RBF/KBF", "LIGHTNING STRIKE OCMP CBT", "FOM 19.2.6.3 COND INSP"]},
  {cat:"AOM",title:"AOM 16.12.6 (-700) Center Tank Fuel Pump LOW PRESSURE Light Illuminated on Ground",refs:[]},
  {cat:"AOM",title:"AOM 5.5.1 ABORTED ENGINE STARTS",refs:[]},
  {cat:"AOM",title:"AOM 16.7.1 Supplemental Engine Start Procedures Ground Air / Crossbleed",refs:[]},
  {cat:"AOM",title:"AOM 4.9.3.5 FLIGHT PLAN UPLINK PROCEDURE",refs:["AOM 6.8.2 PWB TAKEOFF DATA REVIEW"]},
  {cat:"AOM",title:"AOM 16.8.3 LAV SMOKE DET RESET",refs:[]},
  {cat:"AOM",title:"AOM 3.8.2 ENGINE STABILIZATION AND COOLDOWN (SHUTDOWN IDLE 3 MIN)",refs:[]},
  {cat:"AOM",title:"AOM 4.8.1 (VNAV SPEED FLAP LIMIT ISSUE) CHECK VNAV CLB PAGE 2L/3L TGT & SPD RESTRICTION",refs:["CDU VNAV TARGET SPD"]},
  {cat:"AOM",title:"NORMAL OPERATION OF SYSTEMS (AOM 16 SUPPLEMENTAL)",refs:[]},
  {cat:"AOM",title:"LANDING WEIGHT AOM 3.3.2 STRUCTURAL WEIGHT",refs:["AOM 17.6 PWB Normal Landing Planning Procedure"]},
  {cat:"AOM",title:"AOM 3.12.1 GENERAL TABLE 3.21 FUEL SYS LIM",refs:[]},
  {cat:"AOM",title:"AOM 6.1 AIRCRAFT PREFLIGHT - FMC SOFTWARE VERSION U11 OR U13",refs:["MAX FRM 11.5.2.2 Derated Thrust Climb", "YOUTUBE 49 MIN (LEAP1B REQUIRES %)"]},
  {cat:"ATA 05",title:"MISSING PAINT",refs:["MPM 52.07.01.02 DAMAGE & DENT IDENT", "KBF METAL VS COMPOSITE", "SRM 51-70-00-1A-3 - REQ ENG"]},

  {cat:"ATA 05",title:"SRM FOLLOW ONS - ENGINEERING ACTION GUIDE",refs:["SRM NICKS GOUGES SCRATCH & DAMAGE REMOVAL TIP", "MAX WINGLET DAMAGE TIP", "52.7.1.1 Damage and Dent Identification in MXI", "52.7.1.2 Damage and Dent Identification Marking"]},
  {cat:"ATA 09",title:"KBF - TOW BAR SHEAR PIN",refs:["AOM 7.1 PUSHBACK PROCEDURES"]},
  {cat:"ATA 11",title:"800 REQUIRED PLACARDS MT (ALSO REF AMM CH 11)",refs:["MAX REQUIRED PLACARDS MT (ALSO REF AMM CH 11)"]},
  {cat:"ATA 20",title:"FLT DECK GUARDED SWITHCHES LOCKWIRE AMM 20-10-44-400-801",refs:[]},
  {cat:"ATA 21",title:"PACK TRIM AIR MOD VLV & TCV",refs:["PACK STANDBY TCV", "PACK TRIM AIR PRSOV"]},
  {cat:"ATA 21",title:"RAM AIR LOCKOUT EXH ACT LINK P/N C21009-1 / INLET ACT KIT 21000001-01",refs:["RAM AIR HAT REMOVAL PANEL 192BL/BR PER AMM 05-41-01"]},
  {cat:"ATA 21",title:"RBF 25-13 (AOM 15.2.2) OPTIMUM PANEL CONFIG DURING COOLING",refs:[]},
  {cat:"ATA 21",title:"On the Radar 2025.05.01 (Pack operations)",refs:[]},
  {cat:"ATA 21",title:"NOISE/VIBRATION/HUMMING AFT GALLEY CABIN",refs:[]},
  {cat:"ATA 22",title:"MAX SPEED TRIM NUISANCE / DFCS BITE",refs:["SPEED TRIM 22-11186 IFIM", "SPEED TRIM FTD", "SPEED TRIM ADJUST TSI STEPS"]},
  {cat:"ATA 22",title:"STAB OUT TRIM LIGHT",refs:[]},
  {cat:"ATA 22",title:"POWER UP AURAL WARNING EVERY 8 SEC",refs:[]},
  {cat:"ATA 22",title:"RCAS EVENT ROLL AUTHORITY UNCOMMANDED ROLL",refs:[]},
  {cat:"ATA 23",title:"700'S WIFI COMM ISSUE",refs:[]},
  {cat:"ATA 23",title:"AOM 16.5.3.7 ACARS QUICK REF / FMC PREVIOUS CITY",refs:[]},
  {cat:"ATA 23",title:"FLIGHT INTERPHONE STATIC (JACK)",refs:[]},
  {cat:"ATA 23",title:"IDG INTERNAL LOW PRESSURE SWITCH CK (CMM)",refs:[]},
  {cat:"ATA 23",title:"RADIO TUNING INOP DISPLAYED PANEL RESET",refs:[]},
  {cat:"ATA 23",title:"SATCOM PART REPLACEMENT EMAIL SATCOM-DG VERIFY ACTIVATION",refs:[]},
  {cat:"ATA 23",title:"ACARS NO CHIME CRITICAL FLT MODE",refs:[]},
  {cat:"ATA 23",title:"ACARS OR DATA LINK MEL APPLIED CPDLC WILL NOT WORK IN FLIGHT ATC LOGS OUT",refs:[]},
  {cat:"ATA 23",title:"FLIGHT ATTENDANT PANEL SAFETY BUTTON",refs:[]},
  {cat:"ATA 23",title:"FASTEN SEAT BELT ANNOUNCEMENT WHEN SWITCHED TO AUTO OR ON",refs:[]},
  {cat:"ATA 23",title:"CVR MEL 15 MINUTES",refs:[]},
  {cat:"ATA 23",title:"RAMP HEADSET CALL OUTS POWER ON, COMMUNICATION ESTABLISHED & LOW BATTERY (RAMP HEADSET)",refs:[]},
  {cat:"ATA 24",title:"AFT GALLEY POWER CYCLES",refs:[]},
  {cat:"ATA 24",title:"ELEC LIGHT SPCU FAULT C/B CYCLE B1 & B2 FIM 24-34 TASK 802",refs:[]},
  {cat:"ATA 24",title:"MAIN/AUX BATTERY LOCATION",refs:[]},
  {cat:"ATA 24",title:"APPLYING ENGINE GENERATOR MEL W/SERIES 2 APU LUBE MODULE INSTALLED",refs:["PPE APU LUBE MODULE POWERPOINT"]},
  {cat:"ATA 25",title:"MAX B/E AFT LH RH LAV VANITY OUTER DOOR PARTS",refs:[]},
  {cat:"ATA 25",title:"FLIGHT DECK DOOR HEADER BUNDLE",refs:[]},
  {cat:"ATA 25",title:"GALLEY BALL MAT RAW STOCK",refs:[]},
  {cat:"ATA 25",title:"2.6.1 - 2.6.3 LIFE VEST, LOTO, RETURN AIR GRILLE & LIFE RAFT INSPECTION",refs:["FOM 21.1.9 LIFE VEST", "MAX TAMPER RED SECURITY SEAL DRAWING 25400009", "800 TAMPER RED SECURITY SEAL DRAWING 25400007"]},
  {cat:"ATA 25",title:"MAX LAV SINK UNCLOG/CLEAN",refs:[]},
  {cat:"ATA 25",title:"MAX AFT LAV DOOR PLACARDS",refs:[]},
  {cat:"ATA 25",title:"ISP AUGUST TROUBLESHOOTING (IN SEAT POWER USB)",refs:["ISP BOEING TROUBLESHOOTING (IN SEAT POWER USB)", "CONFIG MODULE", "AMMS", "IPPC"]},
  {cat:"ATA 25",title:"FLIGHT DECK USB CHARGING & EFB POWER KIT",refs:["KBF", "USB FLIGHT DECK", "AOM 3.16.1 EFB GENERAL", "AOM 5.20.2 5.20.2 Single EFB Failure Device or App"]},
  {cat:"ATA 25",title:"PROMISE PLACARD EO 1132-E-15040 & EO 1132-E-16752 (ELECT SPRAY)",refs:[]},
  {cat:"ATA 25",title:"MEGAPHONE SEAL",refs:[]},
  {cat:"ATA 25",title:"MAX BE AFT LAV DOOR HARD TO OPEN OR CLOSE LOCK",refs:[]},
  {cat:"ATA 25",title:"AFT GALLEY COUNTER DRAIN DOOR APPLY MEL 38-10-01A",refs:[]},
  {cat:"ATA 25",title:"CARPET CHANGE STATIONS",refs:[]},
  {cat:"ATA 25",title:"LOTO BOX CONTENTS",refs:[]},
  {cat:"ATA 26",title:"WING TO BODY OVERHEAT PARTS EXCEL",refs:["WTB ELEMENTS P/N"]},
  {cat:"ATA 27",title:"ELEVATOR PITOT LEAK CHECK PLUG P/N MS21913V6P or AN806-6",refs:[]},
  {cat:"ATA 27",title:"PITOT PROBE CONNECTOR KIT P/N 00855-1727-0001",refs:[]},
  {cat:"ATA 27",title:"SPEEED BRAKE DO NOT ARM NO DIM R&R DIODE M394 P/N 1N2976B PER WDM 33-18-21-2",refs:[]},
  {cat:"ATA 27",title:"MAX KNOWN GOOD FLAP SETTINGS",refs:["A"]},
  {cat:"ATA 27",title:"TRAILING EDGE FLAP NOT EXTENDING PROPERLY (Usually #1 & #8 Flap transmittion popped)",refs:[]},
  {cat:"ATA 27",title:"MAX ELEV FEEL LIGHT ON (SOLENOIDS)",refs:["MAX ELEVATOR FEEL SCHEMATIC", "MAX ELEVATOR FEEL DIFF LIGHT"]},
  {cat:"ATA 27",title:"STAB CHAIN GRINDING NOISE",refs:[]},
  {cat:"ATA 27",title:"MPM 53.3 Functional Check Flights",refs:["SA-M 1092 (NRFO APP QUICKBASE)"]},
  {cat:"ATA 27",title:"FLAP LOCK OUT/OVERSPEED - FLAP LOAD RELIEF",refs:[]},
  {cat:"ATA 28",title:"AOM 16.12.4 DEFUELING AND GROUND TRANSFER OF FUEL",refs:["FQM 06.05 PRESSURE DEFUELING", "AOM 16.12.2 FUEL PROCEDURE (FUEL DENSITY)"]},
  {cat:"ATA 28",title:"FUEL GREATER THAN 1000 IMBALANCE EXCEEDANCE COND INSP (QUESTIONS)",refs:[],note:"Always verify crossfeed valve position first. Common false reading on -800s with center tank below 1000 lbs."},
  {cat:"ATA 28",title:"FUEL TANK FLOAT SWITCH T/S",refs:[]},
  {cat:"ATA 28",title:"FRM 11.5.3 FUEL MONITORING (FUEL QTY SENS MESSAGE)",refs:["CDU FUEL PROGRESS/INIT REF PAGE", "FMC LANDING FUEL (USING FUEL RESERVE)"]},
  {cat:"ATA 28",title:"MAX RT TANK FUEL TUBE CRACK",refs:["NEW EA TANK DIVE"]},
  {cat:"ATA 28",title:"NG FUEL PROBE P/N PRIOR TO LINE 7741 (FOR ETOPS APPLYS TO 8300'S)",refs:[]},
  {cat:"ATA 28",title:"FUEL TEMP IND INOP MEL NOTES",refs:[]},
  {cat:"ATA 29",title:"On the Radar 2025.05.01 (Hydraulic reservior changes during flight)",refs:[]},
  {cat:"ATA 30",title:"MAX LEFT ONLY WING ANTI ICE HEALTH CHECK",refs:[]},
  {cat:"ATA 30",title:"WING ANTI ICE MEL CREW CONFUSION",refs:["PNEUMATIC SCHEMATIC"]},
  {cat:"ATA 31",title:"ACMS MENU",refs:["ACMS PROMPT BLANKING OUT (CLEAR REPORTS)", "NEW ACMS PAGES NG/MAX KBF"]},
  {cat:"ATA 31",title:"AIRSPEED FLAP UP BUG",refs:[]},
  {cat:"ATA 31",title:"FIBER OPTIC SIGN OFF",refs:[]},
  {cat:"ATA 31",title:"WATER VAPING SENSING SYSTEM (NOAA) (MAX CONFIG SLOT 31-70)",refs:["IMAGE", "PRESENTATION"]},
  {cat:"ATA 31",title:"AHM FAULT OCCURENCE -1 INDICATES WHAT CAUSED THE FAULT",refs:[]},
  {cat:"ATA 32",title:"MAX LANDING GEAR CONTROL LEVER MODULE OPS CK",refs:[]},
  {cat:"ATA 32",title:"MAX MLG BONDING JUMPER (NOT DEFERABLE MUST FIX STOCKED AT ALL STA))",refs:["NG MLG CTR DOOR UPR & LOWER JUMPERS"]},
  {cat:"ATA 32",title:"TIRE BLOWOUT BRAKE METERING VALVE CONTROL ROD SEIZED (BMV SIDE)",refs:["EA - TTG8Q00TQKPR", "3241-C-17451-NG NEW EO 180 DAY INTERVAL", "BMV ROD INSPECTION NOT SEIZED"]},
  {cat:"ATA 33",title:"ANTI COLLISION LT MODULE / DRIVER",refs:[]},
  {cat:"ATA 33",title:"FLT DECK LEFT DOME EMERG LT",refs:[]},
  {cat:"ATA 33",title:"GREEN GEAR + OVERHEAD IN DIM INOP",refs:[]},
  {cat:"ATA 33",title:"CEILING LED MAXIMUM OF 3 LTS MAY BE INOP (20% OF 15 LT ASSY)",refs:[]},
  {cat:"ATA 33",title:"ACP MAX SAFETY DEMO BUTTON MISSING (FAM 3.3.4)",refs:["Avionics Engineering Response", "TTG8Q0108L33"]},
  {cat:"ATA 33",title:"MPM",refs:[]},
  {cat:"ATA 34",title:"PM",refs:["AOM 4.10.3 IRS ALIGN LIGHTS FLASHING", "MAX ADIRU AUTO REALIGN", "ADIRU FAULT CODES FOR IFIM"]},
  {cat:"ATA 34",title:"AOM 4.9.6 EXPIRED NAV DATABASE",refs:["I"]},
  {cat:"ATA 34",title:"MAX FRM 111.12.2 FMC Alerting Messages",refs:[]},
  {cat:"ATA 34",title:"MCP A UNDERSPEED",refs:[]},
  {cat:"ATA 34",title:"OAT DISAGREE",refs:[]},
  {cat:"ATA 34",title:"AOM 4.7.1 Arming LNAV for Takeoff",refs:["MAX FRM 4.1.4 Lateral Navigation"]},
  {cat:"ATA 34",title:"ETOPS POST FLIGHT NAV CHECK ACCU CK",refs:[]},
  {cat:"ATA 34",title:"ENGAGING LNAV & VNAV ON THE GROUND",refs:[]},
  {cat:"ATA 35",title:"AOM 16.1.2 Oxygen Pressures",refs:[]},
  {cat:"ATA 36",title:"MAX DUCT PRESSURE OSCILLLATION OR LOW IFIM",refs:[]},
  {cat:"ATA 36",title:"737 MAX ATA 36  Pneumatic System Fault Code Summary",refs:[]},
  {cat:"ATA 36",title:"PRSOV SENSE LINE",refs:[]},
  {cat:"ATA 36",title:"MAX - ENG ANTI-ICE Light PI DRIFT Fault (MEL 36-11-02B)",refs:["PNEUMATIC ENG OFF HPSOV OMF TEST"]},
  {cat:"ATA 36",title:"MAX - Bleed System Status Message Wont Clear (FAMV/PRSOV/HPSOV)",refs:[]},
  {cat:"ATA 46",title:"NFS REPLACE ADHOC",refs:["NFS STAGE 2 MX MSG 46-13109 / 13110", "Remove and Replace (NFS) [TTG8Q010ARG7]"]},
  {cat:"ATA 46",title:"RBF AVIOCAST AID & DOCK (CREW USES 2WIRE NOT AVIO CAST - AVIO CURRENTLY USED FOR AHM ONLY)",refs:["AVIOCAST AID DRAWING OPS CK", "AVIO MOD FIGURES", "AVIOCAST YOUTUBE"]},
  {cat:"ATA 49",title:"APU FUEL SHUT OFF DATA PLATE",refs:[]},
  {cat:"ATA 49",title:"APU",refs:[]},
  {cat:"ATA 52",title:"FLIGHT DECK DOOR CODE 523 (OPS BINDER - COMPLY 365)",refs:[]},
  {cat:"ATA 54",title:"LEAP1B T/R LANYARD DRAWING",refs:[]},
  {cat:"ATA 56",title:"FRONT WINDOW SIGN OFF BURN SPOT",refs:[]},
  {cat:"ATA 71",title:"EGT EXCEEDANCE GUIDE",refs:["MPM 23.3.5.1 Engines EGT Exceedance Procedure"]},
  {cat:"ATA 71",title:"MAX TAIL PIPE FIRE AMM 71-00-00-200-801-G00",refs:["MAX CVTE SMOKE AFTER SHUTDOWN NORMAL"]},
  {cat:"ATA 71",title:"STA HIGH POWER RUNS W/LEAK CK (ATL, DAL, HOU, PHX & DEN)",refs:[]},
  {cat:"ATA 71",title:"FAN COWL LATCH INDICATING SYSTEM BLADE MISSING (AC 8701-8735 NOT INSTALLED)",refs:["TSR 2024002144 SHOWS BLADE EFF TO COWL ASSY", "FAN COWL P/N'S WITH & WITHOUT LATCH SYS", "FAN COWL AMM NG 71-11-02 / MAX 71-11-04", "LATCH TAPE ALL EA M-24-171-01399 CONFIG 71-11"]},
  {cat:"ATA 71",title:"LEAP1B FAN DRAIN MAST FUEL PUMP LEAK",refs:[]},
  {cat:"ATA 71",title:"FAN COWL PIN FALLS OUT OF QUICK DISCONNECT",refs:[]},
  {cat:"ATA 72",title:"LEAP1B TRF / AFT SUMP REPACK / CVT GROUND VERF",refs:[]},
  {cat:"ATA 72",title:"LEAP1B INLET COWL/FAN FRAME MODULE/FAN BLADE AMM INSPECTION",refs:["KBF FAN BLADE"]},
  {cat:"ATA 73",title:"LEAP EEC CREDENTIALS ONE TIME EA TO DEFER TTG8Q00KS8RN",refs:[]},
  {cat:"ATA 73",title:"LEAP1B DATA PLUG",refs:[]},
  {cat:"ATA 73",title:"CMF56-7B FUEL PUMP IMPELLER SHAFT INSPECTION",refs:[]},
  {cat:"ATA 73",title:"LEAP1B FUEL NOZZLE TASK CARD PS3 TUBE B-NUT LOOSE RESULT",refs:[]},
  {cat:"ATA 73",title:"LEAP1B N1 FLUCTUATING LESS THAN 1% WITH FUEL FLOW FOLLOWING CONTACT PPE MORE THAN LIKELY A BAD FMU",refs:[]},
  {cat:"ATA 74",title:"LEAP1B IGNITION LEADS/EXCITER",refs:[]},
  {cat:"ATA 78",title:"LEAP 1B EXHAUST COKING AMM",refs:[]},
  {cat:"ATA 78",title:"MAX T/R WONT CYCLE SPECIAL FUNCTIONS",refs:[]},
  {cat:"ATA 79",title:"On the Radar 2025.05.08 (Low oil qty)",refs:[]},
  {cat:"ATA 79",title:"ODMS - CHIP COUNT INCREASE ALL EA M-24-179-01799-ETOPS - CONFIG 79",refs:["3 DAY LAB RESULTS EA TLD TTG8Q00MJY8P", "ODMS PARTS", "AOS EO A/C SEARCH"]},
  {cat:"ATA 80",title:"N2 rotor seizure on brand new engines. The rotating seals can touch abradable/honeycomb",refs:[]},
  {cat:"CMM",title:"TRAY TABLE EXIT ROW LOCK SB",refs:["TTG8Q00AGK1W", "TSR 202200602 & 2022005", "EO TRAY TABLE LATCH"]},
  {cat:"FAM",title:"5.5 Preflight Cabin Equipment Checklist",refs:["FAM 5.7.2 Cabin Clean-Up Bag Biohazard Red-Bag (PROVO)", "FAM 5.6.19 Medical Blankets (PROVO)", "FAM 5.8 Over-the-Counter (OTC) Kit (PROVO)"]},
  {cat:"FAM",title:"FAM 11.20 Flight Attendant Positions",refs:[]},
  {cat:"FAM",title:"FAM 3.4.10.2 Lavatory Doors (JAMMED USED CREDIT CARD METHOD)",refs:[]},
  {cat:"FOM",title:"FOM 19.2.6.2 MX NOTE (0-3 ON RELEASE)",refs:[]},
  {cat:"FOM",title:"FOM 5.1.2 System Resets",refs:[]},
  {cat:"FOM",title:"FOM 17.7.10 Flight Numbering System",refs:[]},
  {cat:"FOM",title:"FOM 19.4 Maintenance Facilities",refs:[]},
  {cat:"FOM",title:"FOM 19.2.4 Correcting Errors and/or Voiding Pages or Sections (LOG PAGE)",refs:[]},
  {cat:"FOM",title:"FOM 15.3.2 Turbulence Intensity",refs:["FOM 15.3.8 Turbulence Action Table"]},
  {cat:"FOM",title:"FOM 17.1 General (NO REVENUE IF ALL LAVS INOP)",refs:[]},
  {cat:"FOM",title:"FOM 21.5.5 Emergency Medical Kit (EMK)",refs:["KBF NEW ENHANCED EMK"]},
  {cat:"FOM",title:"FOM 17.7.3 Dispatch Release Example and Explanation (MEL CODES DISTINGUISH A NUMBER OR LOCATION NO EFFECT ON MEL)",refs:[]},
  {cat:"FOM",title:"FOM TABLE 22.1 (LOG BOOK ENTRY REQUIRED)",refs:[]},
  {cat:"FQM",title:"FQM 06.03 Fueling with Inoperative Quantity Indicating System",refs:["MAX MEL SP #28 Fuel Measuring Stick Readings"]},
  {cat:"FRM",title:"UNABLE SELECT OAT N1 LIMIT PAGE (TAT)",refs:["MAX FRM 11.8.3.12 N1 LIMIT Page- Preflight", "AOM 4.9.3.8 N1 LIMIT Page (N1 LIMIT)"]},
  {cat:"GOM",title:"GOM Tire Changes While Deplaning",refs:[]},
  {cat:"GOM",title:"GOM RON Aircraft Procedures During Winter Operations",refs:["GOM Draining During Winter Operations", "GOM Winterization Checklist for Originating Aircraft"]},
  {cat:"GOM",title:"GOM Cleanup Procedures",refs:[]},
  {cat:"GOM",title:"CAPTAIN MAKES FINAL DETERMINATION OF MX REQUIRED",refs:[]},
  {cat:"IFOM",title:"IFOM 8.1.4 HF Radio (In-Flight Single Failure can continue ETOPS)",refs:["IFOM 9.4.4 SATCOM Datalink Failure", "HILLMAN SATCOM GUIDE", "SATCOM TASK CARD OPS CK", "HF ARINC JEPP CHARTS / COMPANY FREQ"]},
  {cat:"IFOM",title:"IFOM 6.4.2 ETOPS AREAS OF OPERATION",refs:["IFOM 6.4.1 ADEQUATE AIRPORT"]},
  {cat:"IFOM",title:"IFOM 2.1.2 International Equipment Operating Table",refs:[]},
  {cat:"IPC",title:"OVERHEAD BIN INTERIOR BLACK PLASTIC CORNER COVER",refs:[]},
  {cat:"MEL",title:"MPM 9.2.3 Aircraft Fault Deferral Types (MEL CATEGORY)",refs:[]},
  {cat:"MEL",title:"MPM 9.7.2 MEL Correction Deadline Extension Procedure",refs:[]},
  {cat:"MEL",title:"NG 27-7-04 PERFORMANCE PENALTY",refs:[]},
  {cat:"MEL",title:"MOC READ & SIGN MEL 38-2-03, 30-3-04 & 38-30-01C (PICTURES OF C/B'S & CONNECTORS)",refs:[]},
  {cat:"MISC",title:"PAINT COLORS",refs:["Specialty Paint Search in MXI", "Swalife Specialty AC"]},
  {cat:"MPM",title:"MPM 46.7.2 ETOPS Component/Part Swapping Policy",refs:[]},
  {cat:"MPM",title:"MPM 46.2 ETOPS PDSC Faults found during or after PDSC/gate return",refs:["MPM 46.2.4 ETOPS Flight Continuation Policy", "MPM 46.2.5 ETOPS Flight Continuation Procedure", "MPM 46.2.3 AC Reposition Post PDSC Walk Around", "IFOM 6.10 PDSC/CONT/DUAL MX/MX NOTE"]},
  {cat:"MPM",title:"MPM 46.8.2 ETOPS Significant Event Reporting Procedure",refs:[]},
  {cat:"MPM",title:"MPM 46.1.1 ETOPS Significant Systems Policy",refs:[]},
  {cat:"MPM",title:"MPM 46.5.2 Request for Access to ETOPS Task Cards in Toolbox Procedure",refs:[]},
  {cat:"MPM",title:"MPM 46.6.7 ETOPS Alert Creation Procedure",refs:["MPM 46.6.8 Alert Removal Procedure"]},
  {cat:"MPM",title:"MPM 46.10.2 ETOPS ECM Procedure (After 5 days of lapsed ECM data, Apply ETOPS Restriction)(LVL 1 & 2 CNR Apply Restriction)",refs:["KBF URGENT CNR LEVELS", "CFM POWERPOINT"]},
  {cat:"MPM",title:"TOOL",refs:[]},
  {cat:"MPM",title:"MPM 46.4.8 ETOPS Verification Flight (EVF) Policy",refs:["MPM 46.4.11 ETOPS SSOR Flight", "IFOM 6.10.1 ETOPS EVF SSOR PEEP"]},
  {cat:"MPM",title:"MPM 46.4.1 ETOPS Verification Program Policy",refs:["FAULT EXAMPLE"]},
  {cat:"MPM",title:"MPM 46 NEW OIL PROCEDURES DRAFT",refs:["MPM 46.11.1 Oil Consumption Monitoring Current Policy", "MPM Table 23.3.6(1): Southwest Airlines Oil Consumption Rates"]},
  {cat:"MPM",title:"MPM 45.8 OEM Letter Check Equivalence (AWR EVERY 8 DAYS)",refs:[]},
  {cat:"MPM",title:"FERRY, FCF, GEAR DOWN WRITE UPS",refs:["47.3.2 Aircraft Logbook Documentation", "AOM 16.2.8 Reduced PSI Differential Operations", "MPM 47.2.3 Landing Gear Down Ferry Flights", "FCF READ &SIGN"]},
  {cat:"MPM",title:"MPM 6.14.3 Pest Problem Aircraft",refs:[]},
  {cat:"MPM",title:"MPM 7.2 Lost or Damaged Certificate of Aircraft Registration or Standard Airworthiness Certificate",refs:[]},
  {cat:"MPM",title:"MPM 52.6.8.3 Missing Airworthiness Release Procedure",refs:["AIRVAULT AWR LOG PAGE SEARCH"]},
  {cat:"MPM",title:"MPM 9.2.1 MEL/CDL/MX Note/DEF/TLD Deferred Maintenance Items Policy (MX Note in liew of TLD)",refs:[]},
  {cat:"MPM",title:"MPM 9.2.3 Aircraft Fault Deferral Types (MX note list)",refs:[]},
  {cat:"MPM",title:"MPM 6.9.2 On-Call Maintenance Provider (OCMP) Procedure",refs:[]},
  {cat:"MPM",title:"MPM 28.7.1 Requests to Aircraft Records for Corrections/Updates Procedure",refs:["MPM 52.3 Maintenix Corrections Procedure"]},
  {cat:"MPM",title:"MPM 21.5.1 Loading Software Parts Procedure (PMAT/UMD TO VERIFY SOFTWARE)",refs:[]},
  {cat:"MPM",title:"MPM 53.5.9.2 Installation of Metallic Speed Tape Procedure",refs:[]},
  {cat:"MPM",title:"MPM 22.6.1 Aircraft Tire/Wheel/Brake Storage Policy",refs:[]},
  {cat:"MPM",title:"MPM 52.8.1.4 Hard Copy Task Card Generated from Maintenix Instructions for Use",refs:[]},
  {cat:"MPM",title:"MPM 53.4.4.3 Engine Start, Taxi, and Run-Up Procedure (high power fuel requirements)",refs:[]},
  {cat:"MPM",title:"MPM52.2.2 Documenting Faults in Maintenix Procedure (BATCH PARTS EFFECTIVITY VERIFIED THROUGH IPC)",refs:[]},
  {cat:"MPM",title:"52.02.01 Documenting Faults in Maintenix Policy (COMBINE 10 DEFECTS ON 1 FAULT)",refs:[]},
  {cat:"MPM",title:"MXI OUTAGE",refs:["TABL/CALC", "MPM 52.10 Maintenix Outage Backup Manual Documentation", "MPM 9.5.2 Alternate MEL, CDL, MX Note, and Repair Ref Entry"]},
  {cat:"MPM",title:"MPM 22.5.4 Aircraft Tire Wear/Cut Limits",refs:[]},
  {cat:"MPM",title:"MPM 46.6.1 ETOPS Operational Status Control Policy",refs:["MPM 46.6.10 Removal of ETOPS Restricted Status Procedure"]},
  {cat:"MPM",title:"MPM 46.4.1 ETOPS Verification Program Policy - MEL BYPASS CH 46",refs:[]},
  {cat:"MPM",title:"MPM 6.6.7.5 Borrowed Parts in Maintenix Procedure",refs:[]},
  {cat:"MPM",title:"MPM 9.6.4 DMI to Continue on Deferral Procedure",refs:[]},
  {cat:"MPM",title:"MPM 9.6.5 MEL, CDL, MX Note, or DEF/TLD Repetitive Inspection or Repetitive Maintenance Action (LOG BOOK ONLY)",refs:[]},
  {cat:"MPM",title:"MPM 6.7.3 Cancelation Entry Procedure",refs:[]},
  {cat:"MPM",title:"MPM 6.3.6.2 Excessive Rudder or Aileron Trim Report Procedure",refs:[]},
  {cat:"MPM",title:"MPM 6.17.3 Installation and Use of Experimental Airworthiness Certificate Application",refs:[]},
  {cat:"MPM",title:"MPM 53.5.8 Flexible Hose for Interim Repair",refs:[]},
  {cat:"MPM",title:"MPM 52.6.11.1 Missing Aircraft Logbook or Logpage Procedure",refs:["FOM 19.2.5 MISSING AIRCRAFT LOGBOOK"]},
  {cat:"MPM",title:"MPM 9.8.1 NEF Decision Flowchart",refs:[]},
  {cat:"MPM",title:"MPM 6.17.5 Non-Standard Operations for Public Relations/Marketing/Media Events (LIMIT 19 PASSENGERS)",refs:[]},
  {cat:"MPM",title:"MPM 6.7.2 Delay Entry Procedure",refs:[]},
  {cat:"MPM",title:"MPM 28.5.3 Install/Remove Tag and Aircraft Logbook Hard Copy Correction Procedures After an Aircraft Records Audit (Pilot Corrections)",refs:[]},
  {cat:"MPM",title:"MPM 6.3.4.1 Pressurization Event Report and In-Service Bleed System Performance Policy",refs:[]},
  {cat:"MPM",title:"MPM 6.5.3 Communications During Aircraft Operations Procedure (ACARS-SATCOM)",refs:[]},
  {cat:"MPM",title:"MPM 10.3.4 Designation of Required Inspection Items RII LIST",refs:[]},
  {cat:"MPM",title:"MPM 9.4.1 Application of MEL SP #2, MEL SP #2A, MEL SP #3, or MEL SP #3A Policy",refs:[]},
  {cat:"MPM",title:"MPM 52.2.2 Documenting Faults in Maintenix Procedure (TPC W/O LOG PAGE) (DAY OF OPS - LOG PAGE ONLY)",refs:[]},
  {cat:"MPM",title:"MPM 26.18 Tool, Precision Measuring Device, and Precision Test Equipment Periodic Inspection, Control, and Calibration",refs:[]},
  {cat:"MPM",title:"MPM 54.6 Tool Effectivity (CALIBRATED TOOLS)",refs:["MXI ADDING CALIBRATED TOOLING (JOB STOP)"]},
  {cat:"MPM",title:"MPM 24.9.1 Aircraft Maintenance Planning Potable Water System Disinfect Three-Day Exceedance Monitoring Procedure",refs:["MPM 33.4.2 EPA Potable Water Quality Policy"]},
  {cat:"MPM",title:"MPM 52.6.7.1 Aircraft Logbook CDCS Entry and Review",refs:[]},
  {cat:"MPM",title:"MPM 54.1.6.1 Removed Serviceable (Robbed Parts) Policy (TEAM LEAD) - non maintenance location for MEL",refs:[]},
  {cat:"MXI",title:"MPM 9.2.1 MEL/CDL/MX Note/DEF/TLD Deferred Maintenance (FLT MEL CREW NO JOB STOP)",refs:[]},
  {cat:"MXI",title:"MPM 52.2.2 Documenting Faults in Maintenix Procedure (LOG PAGE TO MXI)",refs:[]},
  {cat:"MXI",title:"RECORDS (MXI PART CODES)",refs:[]},
  {cat:"MXI",title:"MXI SEARCH",refs:["ALL EA SEARCH HELP", "MXI SEARCH PART NAME __%NAME__%"]},
  {cat:"MXI",title:"CARRY OVER CODES MXI",refs:[]},
  {cat:"MXI",title:"MAX CONIG 05-20 (805-PRD-15 (VCK - RODENT TREATMENT PROGRAM)",refs:["NG CONFIG SLOT 25-20 (725-SWA-110 RODENT)"]},
  {cat:"SA-M",title:"SA-M 988 Aircraft Publications Checklist",refs:[]},
  {cat:"SRM",title:"MISSING SCREW MAX SRM 51-10-05-0G-0",refs:["MISSING SCREW NG AMM 20-60-11", "MAX HORIZ STAB L/E PANELS AMM 55-10-00-200-802", "TTG8Q00HBUGD (MAX EA REQ EXAMPLE)"]},
  {cat:"TOSM",title:"TOSM 11.6 Remain Overnight (RON) Aircraft at International Locations (SECURITY SEAL)",refs:[]},
  {cat:"MXI",title:"TLD RED DEATH BAR",refs:[]},
  {cat:"MAX",title:"DOWNLOADING SOFTWARE TO UMD",refs:[]},
  {cat:"MISC",title:"1. MAX SPREADHSEET",refs:[]},
  {cat:"MISC",title:"2. 800 SPREADSHEET",refs:[]},
  {cat:"MISC",title:"3. NG SPREADSHEET",refs:[]},
  {cat:"MISC",title:"4. AUGUST 800 PARTS LIST",refs:[]},
  {cat:"MISC",title:"5. DESK PC/AVTEC",refs:[]},
  {cat:"MISC",title:"6. FLEET INTERIOR/EXTERIOR",refs:[]},
  {cat:"MISC",title:"7. Aircraft Liverys / Photos",refs:[]},
  {cat:"MISC",title:"Aircraft 8721 has completed the SA-M 1149 approval process for ELR.",refs:[]},
  {cat:"MISC",title:"AIRVAULT LOG PAGE & 8130 (MISC TAB)",refs:[]},
  {cat:"MISC",title:"AUDIT U:\\MOC\\Int'l-Dom Contract MX Database\\",refs:[]},
  {cat:"MISC",title:"CONFIG CONTROL 214-904-4360",refs:[]},
  {cat:"MISC",title:"CONUS",refs:[]},
  {cat:"MISC",title:"DocuNet Viewer",refs:[]},
  {cat:"MISC",title:"FDAP REPORT VERBIAGE",refs:[]},
  {cat:"MISC",title:"HERMES Log In",refs:[]},
  {cat:"MISC",title:"MAX PLAYBOOK",refs:[]},
  {cat:"MISC",title:"MPM CAT III MAX",refs:[]},
  {cat:"MISC",title:"MPM CAT III NG",refs:[]},
  {cat:"MISC",title:"MPM CAT III REQ SYSTEMS",refs:[]},
  {cat:"MISC",title:"Percentage  CALC",refs:[]},
  {cat:"MISC",title:"RECORDS CONTACT INFO",refs:[]},
  {cat:"MISC",title:"SA-M 1065A DOMESTIC",refs:[]},
  {cat:"MISC",title:"SA-M 1065E ETOPS STA",refs:[]},
  {cat:"MISC",title:"SATCOM QUICK REF",refs:[]},
  {cat:"MISC",title:"Service Engineering 214-792-3600 OPT 1",refs:[]},
  {cat:"MISC",title:"TAPE OUTSTATION (NON MX KIT) P/N 25400006-01",refs:[]},
  {cat:"MISC",title:"ICAO CALC (24 BIT DIP SWITCH)",refs:[]},
  {cat:"MISC",title:"ADSB ICAO T/S TIP",refs:[]},
  {cat:"MISC",title:"DAL PHONE LIST",refs:[]}
        ];

        // ---- CORE ELEMENTS ----
        const searchInput = document.getElementById('searchInput');
        const resultsArea = document.getElementById('resultsArea');
        const filterChips = document.querySelectorAll('.filter-chip');
        let activeFilter = 'ALL';

        filterChips.forEach(chip => {
            chip.addEventListener('click', () => {
                filterChips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                activeFilter = chip.dataset.filter;
                render();
            });
        });

        searchInput.addEventListener('input', () => {
            updateAutocomplete();
            if (!searchInput.value.trim()) render();
        });

        // ---- AUTOCOMPLETE ----
        const acDropdown = document.getElementById('acDropdown');
        let acIndex = -1;

        function updateAutocomplete() {
            const q = searchInput.value.trim().toLowerCase();
            if (q.length < 2) {
                acHideDropdown();
                return;
            }

            const words = q.split(/\s+/);

            // Search QRH entries
            let qrhMatches = DATA.filter(d => {
                const hay = (d.cat + ' ' + d.title + ' ' + d.refs.join(' ') + ' ' + (d.note || '')).toLowerCase();
                return words.every(w => hay.includes(w));
            }).slice(0, 5).map(d => ({...d, _type:'qrh'}));

            // Search TSI Fix Rate
            let fixMatches = TSI_ENTRIES.filter(d => {
                const hay = [d.faultCode||'', d.effect||'', d.tail||'', d.ata||'', d.fleet||'', d.notes||''].join(' ').toLowerCase();
                return words.every(w => hay.includes(w));
            }).slice(0, 3).map(d => ({...d, _type:'fix'}));

            // Search apps
            let appMatches = APPS.filter(a => {
                const hay = (a.title + ' ' + a.description + ' ' + a.keywords).toLowerCase();
                return words.every(w => hay.includes(w));
            }).map(a => ({...a, _type:'app'}));

            // Search Quick Links
            let qlMatches = QUICK_LINKS.filter(ql => {
                if (ql.section) return false;
                const hay = ((ql.abbr || '') + ' ' + (ql.name || '') + ' ' + (ql.key || '')).toLowerCase();
                return words.every(w => hay.includes(w));
            }).slice(0, 4).map(ql => ({...ql, title: ql.name, _type:'link'}));

            let allMatches = [...qrhMatches, ...fixMatches, ...appMatches, ...qlMatches];

            if (allMatches.length === 0) {
                acHideDropdown();
                return;
            }

            let html = '';
            allMatches.forEach((d, i) => {
                const titleHl = highlight(d.title, words);
                if (d._type === 'qrh') {
                    const style = tagStyle(d.cat);
                    html += `<div class="ac-item${i === acIndex ? ' selected' : ''}" data-index="${i}" data-type="qrh" onmousedown="acSelect(${i})">
                        <span class="ac-type-badge ac-type-qrh">QRH</span>
                        <span class="ac-item-tag" style="${style}">${esc(d.cat)}</span>
                        <span class="ac-item-title">${titleHl}</span>
                    </div>`;
                } else if (d._type === 'fix') {
                    html += `<div class="ac-item${i === acIndex ? ' selected' : ''}" data-index="${i}" data-type="fix" onmousedown="acSelect(${i})">
                        <span class="ac-type-badge ac-type-defect">TSI</span>
                        <span class="fix-tag fix-tag-ata" style="font-size:9px">ATA ${esc(d.ata||'')}</span>
                        <span class="ac-item-title">${highlight((d.tail||'') + ' ' + (d.faultCode||'') + ' - ' + (d.effect||''), words)}</span>
                    </div>`;
                } else if (d._type === 'app') {
                    html += `<div class="ac-item${i === acIndex ? ' selected' : ''}" data-index="${i}" data-type="app" onmousedown="acSelect(${i})">
                        <span class="ac-type-badge ac-type-app">APP</span>
                        <span class="ac-item-title">${titleHl}</span>
                    </div>`;
                } else if (d._type === 'link') {
                    html += `<div class="ac-item${i === acIndex ? ' selected' : ''}" data-index="${i}" data-type="link" onmousedown="acSelect(${i})">
                        <span class="ac-type-badge ac-type-link">LINK</span>
                        <span class="ac-item-tag korry ${d.kc || ''}">${esc(d.abbr)}</span>
                        <span class="ac-item-title">${titleHl}</span>
                    </div>`;
                }
            });

            acDropdown.innerHTML = html;
            acDropdown.classList.add('visible');
            acDropdown._matches = allMatches;
            resultsArea.style.opacity = '0.15';
            resultsArea.style.pointerEvents = 'none';
        }

        function acHideDropdown() {
            acDropdown.classList.remove('visible');
            acIndex = -1;
            resultsArea.style.opacity = '';
            resultsArea.style.pointerEvents = '';
        }

        function acSelect(i) {
            const allMatches = acDropdown._matches || [];
            if (!allMatches[i]) return;

            const match = allMatches[i];
            acHideDropdown();

            if (match._type === 'app') {
                window.location.href = match.url;
            } else if (match._type === 'link') {
                if (match.custom && match.url) {
                    window.open(match.url, 'docunet');
                } else if (match.key && MANUAL_LINKS[match.key]) {
                    openManual(match.key);
                }
            } else if (match._type === 'fix') {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('[data-tab="fixrate"]').classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('fixrate').classList.add('active');
                fixSearchInput.value = match.faultCode;
                renderFixRate();
            } else {
                searchInput.value = match.title;
                renderSingleResult(match);
            }
        }

        function renderSingleResult(d) {
            const q = searchInput.value.trim().toLowerCase();
            const words = q ? q.split(/\s+/) : [];
            const style = tagStyle(d.cat);
            const titleKey = findManualKey(d.title);
            const titleText = highlight(d.title, words);
            const titleHtml = titleKey
                ? `<span class="result-title result-title-link" onclick="openManual('${titleKey}')" title="Open ${MANUAL_LINKS[titleKey].name}">${titleText}</span>`
                : `<span class="result-title">${titleText}</span>`;

            const copyText = d.refs.length ? d.refs[0] : d.title;
            const hasNote = d.note && d.note.trim();
            const hasFile = d.file && d.file.trim();
            let indicators = '';
            if (hasNote) indicators += `<span class="card-indicator note-indicator" onclick="event.stopPropagation();toggleNote('note-single')" title="Controller Note">NOTE</span>`;
            if (hasFile) indicators += `<span class="card-indicator file-indicator" onclick="event.stopPropagation();openFile('${(d.file||'').replace(/'/g,"\\'")}')" title="Open file">FILE</span>`;

            const typeBadge = d.type || 'qrh';
            const typeLabel = {qrh:'QRH', defect:'DEFECT', template:'TEMPLATE', app:'APP'}[typeBadge] || 'QRH';
            const typeClass = 'ac-type-' + typeBadge;

            let html = `<div class="result-count">1 result</div>`;
            html += `<div class="result-card"><div class="result-card-header">
                <span class="ac-type-badge ${typeClass}">${typeLabel}</span>
                <span class="result-tag" style="${style}">${highlight(d.cat, words)}</span>
                ${titleHtml}
                ${indicators}
                <button class="copy-btn" onclick="event.stopPropagation();copyRef('${copyText.replace(/'/g,"\\'")}', this)" title="Copy reference">COPY</button>
            </div>`;
            if (d.refs.length) {
                html += '<div class="result-refs">';
                d.refs.forEach(r => { html += renderRef(r, words); });
                html += '</div>';
            }
            if (hasNote) {
                html += `<div class="card-note" id="note-single"><div class="card-note-label">CONTROLLER NOTE</div><div class="card-note-text">${highlight(d.note, words)}</div></div>`;
            }
            html += '</div>';
            resultsArea.innerHTML = html;
        }

        searchInput.addEventListener('keydown', (e) => {
            if (!acDropdown.classList.contains('visible')) return;
            const items = acDropdown.querySelectorAll('.ac-item');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                acIndex = Math.min(acIndex + 1, items.length - 1);
                items.forEach((el, i) => el.classList.toggle('selected', i === acIndex));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                acIndex = Math.max(acIndex - 1, -1);
                items.forEach((el, i) => el.classList.toggle('selected', i === acIndex));
            } else if (e.key === 'Enter' && acIndex >= 0) {
                e.preventDefault();
                acSelect(acIndex);
            } else if (e.key === 'Escape') {
                acHideDropdown();
            }
        });

        searchInput.addEventListener('blur', () => {
            setTimeout(() => {
                acHideDropdown();
                if (!searchInput.value) document.getElementById('searchHint').style.display = '';
            }, 150);
        });

        // ---- CATEGORY COLORS ----
        const CAT_COLORS = {
            'ATA': {color:'#93c5fd', glow:'147,197,253'},
            'AOM': {color:'#86efac', glow:'134,239,172'},
            'MPM': {color:'#fdba74', glow:'253,186,116'},
            'FOM': {color:'#c4b5fd', glow:'196,181,253'},
            'MEL': {color:'#fca5a5', glow:'252,165,165'},
            'MXI': {color:'#67e8f9', glow:'103,232,249'},
            'IFOM': {color:'#f9a8d4', glow:'249,168,212'},
            'FRM': {color:'#fdba74', glow:'253,186,116'},
            'GOM': {color:'#5eead4', glow:'94,234,212'},
            'FAM': {color:'#c4b5fd', glow:'196,181,253'},
            'MISC': {color:'#cbd5e1', glow:'203,213,225'},
        };

        function getCatColor(cat) {
            const c = cat.toUpperCase();
            for (const key of Object.keys(CAT_COLORS)) {
                if (c.startsWith(key)) return CAT_COLORS[key];
            }
            return {color:'#cbd5e1', glow:'203,213,225'};
        }

        function tagStyle(cat) {
            const c = getCatColor(cat);
            return `color:${c.color};text-shadow:0 0 6px rgba(${c.glow},0.5);box-shadow:inset 0 1px 3px rgba(0,0,0,0.5),0 0 4px rgba(${c.glow},0.25)`;
        }

        // ---- SEARCH HIGHLIGHTING ----
        function highlight(text, words) {
            if (!words.length) return esc(text);
            const escaped = esc(text);
            let result = escaped;
            words.forEach(w => {
                if (w.length < 2) return;
                const regex = new RegExp('(' + w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                result = result.replace(regex, '<mark>$1</mark>');
            });
            return result;
        }

        // ---- COPY TO CLIPBOARD ----
        function copyRef(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'COPIED';
                btn.classList.add('copied');
                setTimeout(() => { btn.textContent = 'COPY'; btn.classList.remove('copied'); }, 1500);
            });
        }

        // ---- KEYBOARD SHORTCUT ----
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && document.activeElement !== searchInput) {
                e.preventDefault();
                searchInput.focus();
                // Switch to quick ref tab if not active
                const qrTab = document.querySelector('[data-tab="quickref"]');
                if (qrTab && !qrTab.classList.contains('active')) qrTab.click();
            }
            if (e.key === 'Escape' && document.activeElement === searchInput) {
                searchInput.blur();
            }
        });

        // Hide / hint when search focused
        searchInput.addEventListener('focus', () => { document.getElementById('searchHint').style.display = 'none'; });

        // ---- SCROLL TO TOP ----
        window.addEventListener('scroll', () => {
            document.getElementById('scrollTop').classList.toggle('visible', window.scrollY > 400);
        });

        // ---- FILTER BADGES ----
        function updateBadges() {
            filterChips.forEach(chip => {
                const f = chip.dataset.filter;
                let count;
                if (f === 'ALL') count = DATA.length + TSI_ENTRIES.length + APPS.length;
                else if (f === 'FIX') count = TSI_ENTRIES.length;
                else if (f === 'APP') count = APPS.length;
                else count = DATA.filter(d => d.cat.toUpperCase().startsWith(f)).length;
                const existing = chip.querySelector('.badge');
                if (existing) existing.textContent = count;
                else chip.innerHTML += ` <span class="badge">${count}</span>`;
            });
        }
        // ---- APPS DATA (for super search) ----
        const APPS = [
            {
                title:"MAX 737-8 Flap/Slat Overspeed",
                description:"Decision tool for flap/slat overspeed inspection requirements. Phase I/II limits, Nz assessment, deferral windows.",
                url:"flap-overspeed.html",
                keywords:"flap slat overspeed speed exceedance inspection phase deferral nz 737 max boeing flight controls ata 27"
            },
            {
                title:"Rejected Takeoff (RTO) / Brake Cooling",
                description:"Decision tool for RTO inspection requirements. High-energy stop determination, brake cooling module guidance, MQTW, reporting chain.",
                url:"rto.html",
                keywords:"rejected takeoff rto brake cooling energy high speed stop 30 million ft lb mqtw quick turnaround fuse plug melt conditional inspection ata 05 aom 5.18.7 fom 22.1.2 frm 2.4.2.1 conference call"
            },
            {
                title:"LEAP-1B Inlet Cowl / Fan Module Reference",
                description:"Visual identification guide for LEAP-1B engine components. Inlet cowl, fan case, fan blade, abradable, acoustic panels, OGV platforms with inspection criteria and parts.",
                url:"leap-1b.html",
                keywords:"leap 1b engine inlet cowl fan module blade abradable acoustic shroud panel ogv platform vane cfm ata 72 amm 72-21 72-22 72-23 srm 54-10 fan case perforated facesheet seal composite carbon plies honeycomb dovetail wearstrip fan booster inspection 72-22-00-200-808 spinner cup platform front shroud fan disk lpc shaft compressor cover slotted nut balance weight silicone o-ring booster spool flowpath fairing shroud segment cracks dents nicks scratches limits permitted etops"
            }
        ];

        // ---- TSI FIX RATE (Firestore-backed) ----
        var TSI_ENTRIES = [];
        var fixStatusFilter = 'IN WORK';

        const fixSearchInput = document.getElementById('fixSearchInput');
        const fixResults = document.getElementById('fixResults');
        const fixFilterChips = document.querySelectorAll('[data-fix-filter]');
        let activeFixFilter = 'ALL';

        fixFilterChips.forEach(function(chip) {
            chip.addEventListener('click', function() {
                fixFilterChips.forEach(function(c) { c.classList.remove('active'); });
                chip.classList.add('active');
                activeFixFilter = chip.dataset.fixFilter;
                renderFixRate();
            });
        });

        fixSearchInput.addEventListener('input', renderFixRate);

        document.querySelectorAll('[data-status-filter]').forEach(function(chip) {
            chip.addEventListener('click', function() {
                if (chip.classList.contains('active')) {
                    // Toggle off - show all
                    chip.classList.remove('active');
                    fixStatusFilter = 'ALL';
                } else {
                    // Select this one, deselect others
                    document.querySelectorAll('[data-status-filter]').forEach(function(c) { c.classList.remove('active'); });
                    chip.classList.add('active');
                    fixStatusFilter = chip.dataset.statusFilter;
                }
                renderFixRate();
            });
        });

        function loadTsiEntries() {
            if (typeof db === 'undefined') return;
            db.collection('tsi_entries').orderBy('created', 'desc').get().then(function(snap) {
                TSI_ENTRIES = [];
                snap.forEach(function(doc) { var d = doc.data(); d.id = doc.id; TSI_ENTRIES.push(d); });
                updateFixStatusBar();
                renderFixRate();
            }).catch(function(err) { console.error('TSI load error:', err); });
        }

        function updateFixStatusBar() {
            var inWork = TSI_ENTRIES.filter(function(e) { return e.status === 'in_work'; }).length;
            var closed = TSI_ENTRIES.filter(function(e) { return e.status === 'closed_eff' || e.status === 'closed_ineff'; }).length;
            var repeat = TSI_ENTRIES.filter(function(e) { return e.repeat === true; }).length;
            var cw = document.getElementById('fhCountWork');
            var cc = document.getElementById('fhCountClosed');
            var cr = document.getElementById('fhCountRepeat');
            if (cw) cw.textContent = inWork;
            if (cc) cc.textContent = closed;
            if (cr) cr.textContent = repeat;
        }

        function normalizeFaultCode(fc) {
            if (!fc) return '';
            var raw = fc.replace(/[^0-9]/g, '');
            if (raw.length <= 2) return raw;
            var ata = raw.substring(0, 2);
            var item = raw.substring(2).padStart(5, '0');
            return ata + '-' + item;
        }

        function getDueState(dueDateStr) {
            if (!dueDateStr) return { label: '', cls: '' };
            var today = new Date();
            today.setHours(0,0,0,0);
            var parts = dueDateStr.split('-');
            var due = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            due.setHours(0,0,0,0);
            var diff = due.getTime() - today.getTime();
            if (diff < 0) return { label: 'OVERDUE', cls: 'fec-due-overdue' };
            if (diff === 0) return { label: 'Due Today', cls: 'fec-due-today' };
            return { label: 'Due ' + formatTsiDateShort(dueDateStr), cls: 'fec-due-normal' };
        }

        function fhExpandAll() {
            document.querySelectorAll('.fix-entry-card').forEach(function(c) { c.classList.add('open'); });
        }
        function fhCollapseAll() {
            document.querySelectorAll('.fix-entry-card').forEach(function(c) { c.classList.remove('open'); });
        }
        function fhToggleCard(el) {
            el.closest('.fix-entry-card').classList.toggle('open');
        }

        function renderFixRate() {
            var q = fixSearchInput.value.trim().toLowerCase();
            var words = q ? q.split(/\s+/) : [];

            var results = TSI_ENTRIES;

            // Fleet filter
            if (activeFixFilter !== 'ALL') {
                results = results.filter(function(e) {
                    return e.fleet && e.fleet.toUpperCase() === activeFixFilter;
                });
            }

            // Status filter
            if (fixStatusFilter === 'IN WORK') {
                results = results.filter(function(e) { return e.status === 'in_work'; });
            } else if (fixStatusFilter === 'CLOSED') {
                results = results.filter(function(e) { return e.status === 'closed_eff' || e.status === 'closed_ineff'; });
            } else if (fixStatusFilter === 'REPEAT') {
                results = results.filter(function(e) { return e.repeat === true; });
            }

            // Text search
            if (q) {
                results = results.filter(function(e) {
                    var hay = [e.faultCode||'', e.effect||'', e.ata||'', e.fleet||'', e.tail||'', e.notes||'', e.workOrder||'', e.ref||'', e.actionType||'', e.correctiveAction||''].join(' ').toLowerCase();
                    return words.every(function(w) { return hay.indexOf(w) !== -1; });
                });
            }

            if (results.length === 0 && TSI_ENTRIES.length === 0) {
                fixResults.innerHTML = '<div class="fix-empty-state"><p>No TSI entries yet</p><p class="hint">Click + ADD TSI to create your first entry</p></div>';
                return;
            }

            if (results.length === 0 && fixStatusFilter === 'IN WORK') {
                fixResults.innerHTML = '<div class="fix-empty-state"><p>No entries in work</p><p class="hint">All caught up - or click CLOSED to see history</p></div>';
                return;
            }

            if (results.length === 0) {
                fixResults.innerHTML = '<div class="fix-empty-state"><p>No matching entries</p><p class="hint">Try a different search, fleet, or status filter</p></div>';
                return;
            }

            var canEdit = window.mocCanEdit && window.mocCanEdit();
            var html = '';

            results.forEach(function(e) {
                var statusLabel, statusClass;
                if (e.status === 'in_work') { statusLabel = 'IN WORK'; statusClass = 'fts-work'; }
                else { statusLabel = 'CLOSED'; statusClass = 'fts-closed'; }

                var fc = normalizeFaultCode(e.faultCode);
                var dueState = (e.status === 'in_work') ? getDueState(e.dueDate) : { label: '', cls: '' };

                // Card wrapper
                html += '<div class="fix-entry-card" id="fec-' + e.id + '">';

                // Collapsed 2-line view
                html += '<div class="fec-collapsed" onclick="fhToggleCard(this)">';
                html += '<div class="fec-line1">';
                html += '<span class="fec-status ' + statusClass + '">' + statusLabel + '</span>';
                html += '<span class="fec-tail">' + esc(e.tail||'') + '</span>';
                html += '<span class="fec-sep">&bull;</span>';
                html += '<span class="fec-fleet">' + esc(e.fleet||'') + '</span>';
                html += '<span class="fec-sep">&bull;</span>';
                html += '<span class="fec-fc">' + esc(fc) + '</span>';
                if (dueState.label) {
                    html += '<span class="fec-sep">&bull;</span>';
                    html += '<span class="fec-due ' + dueState.cls + '">' + dueState.label + '</span>';
                }
                html += '</div>';
                if (e.effect) {
                    html += '<div class="fec-line2">' + esc(e.effect) + '</div>';
                }
                html += '</div>';

                // Expanded detail
                html += '<div class="fec-expanded">';

                // Full effect text
                if (e.effect) {
                    html += '<div class="fec-effect-full">' + esc(e.effect) + '</div>';
                }

                // Detail fields
                html += '<div class="fec-details">';
                html += '<div class="fec-field"><span class="fec-label">FAULT CODE</span><span class="fec-val">' + esc(fc) + '</span></div>';
                if (e.workOrder) html += '<div class="fec-field"><span class="fec-label">WORK ORDER</span><span class="fec-val">' + esc(e.workOrder) + '</span></div>';
                html += '<div class="fec-field"><span class="fec-label">ATA</span><span class="fec-val">' + esc(e.ata||'') + '</span></div>';
                if (e.ref) html += '<div class="fec-field"><span class="fec-label">AMM/FIM</span><span class="fec-val">' + esc(e.ref) + '</span></div>';
                html += '</div>';

                // TSI Details / Notes
                if (e.notes) {
                    html += '<div class="fec-notes"><span class="fec-label" style="display:block;margin-bottom:4px;">TSI DETAILS</span>' + esc(e.notes) + '</div>';
                }

                // Corrective action (shown when closed)
                if (e.correctiveAction) {
                    html += '<div class="fec-corrective"><span class="fec-label" style="margin-bottom:2px;color:var(--green-text);">CORRECTIVE ACTION</span><div>' + esc(e.correctiveAction) + '</div></div>';
                }

                // Audit line
                html += '<div class="fec-audit">';
                html += 'Created ' + formatTsiDate(e.created) + (e.createdByName ? ' by ' + esc(e.createdByName) : '');
                if (e.updatedAt) {
                    html += '<br>Last Updated ' + formatTsiDate(e.updatedAt) + (e.updatedByName ? ' by ' + esc(e.updatedByName) : '');
                }
                html += '</div>';

                // Action buttons
                if (canEdit) {
                    html += '<div class="fec-actions">';
                    if (e.status === 'in_work') {
                        html += '<button class="fec-btn fec-btn-update" onclick="event.stopPropagation();fixUpdate(\'' + e.id + '\')">UPDATE</button>';
                        html += '<button class="fec-btn fec-btn-close" onclick="event.stopPropagation();fixClose(\'' + e.id + '\')">CLOSE</button>';
                    } else {
                        html += '<button class="fec-btn fec-btn-reopen" onclick="event.stopPropagation();fixReopen(\'' + e.id + '\')">REOPEN</button>';
                    }
                    html += '<button class="fec-btn fec-btn-del" onclick="event.stopPropagation();fixDelete(\'' + e.id + '\')">DELETE</button>';
                    html += '</div>';
                }

                html += '</div>'; // end fec-expanded
                html += '</div>'; // end fix-entry-card
            });

            fixResults.innerHTML = html;
        }

        // Close from Fix Rate tab
        var fixCloseoutId = null;

        function fixClose(id) {
            fixCloseoutId = id;
            document.querySelectorAll('.fco-chip').forEach(function(c) { c.classList.remove('selected'); });
            document.getElementById('fcoNotes').value = '';
            var today = new Date();
            var yyyy = today.getFullYear();
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('fcoDate').value = yyyy + '-' + mm + '-' + dd;
            document.getElementById('fixCoOverlay').classList.add('open');
        }

        function fixUpdate(id) {
            openTsiModal(id);
        }

        function fixCoCancel() {
            document.getElementById('fixCoOverlay').classList.remove('open');
            fixCloseoutId = null;
        }

        function fcoPickAction(el) {
            document.querySelectorAll('.fco-chip').forEach(function(c) { c.classList.remove('selected'); });
            el.classList.add('selected');
        }

        function fixCoConfirm() {
            if (!fixCloseoutId) return;
            var chip = document.querySelector('.fco-chip.selected');
            if (!chip) { tsiToast('Select an action taken'); return; }
            var notes = document.getElementById('fcoNotes').value.trim().toUpperCase();
            if (!notes) { tsiToast('Enter corrective action notes'); document.getElementById('fcoNotes').focus(); return; }
            var closeDate = document.getElementById('fcoDate').value;
            if (!closeDate) { tsiToast('Enter a close date'); return; }
            db.collection('tsi_entries').doc(fixCloseoutId).update({
                status: 'closed_eff',
                closedDate: closeDate + 'T' + new Date().toTimeString().slice(0,8),
                actionType: chip.textContent.trim(),
                correctiveAction: notes
            }).then(function() {
                fixCoCancel();
                loadTsiEntries();
                tsiToast('TSI closed');
            }).catch(function(err) { tsiToast('Error: ' + err.message); });
        }

        function fixReopen(id) {
            if (!confirm('Reopen this entry?')) return;
            db.collection('tsi_entries').doc(id).update({
                status: 'in_work',
                closedDate: null,
                actionType: ''
            }).then(function() {
                loadTsiEntries();
                tsiToast('Reopened');
            }).catch(function(err) { tsiToast('Error: ' + err.message); });
        }

        function fixDelete(id) {
            if (!confirm('Delete this TSI entry? Cannot be undone.')) return;
            db.collection('tsi_entries').doc(id).delete().then(function() {
                loadTsiEntries();
                tsiToast('Deleted');
            }).catch(function(err) { tsiToast('Error: ' + err.message); });
        }

        function formatTsiDate(iso) {
            if (!iso) return '';
            var d = new Date(iso);
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            var day = d.getDate();
            var h = d.getHours();
            var m = d.getMinutes();
            return (day < 10 ? '0' : '') + day + '-' + months[d.getMonth()] + '-' + d.getFullYear() + ' ' + (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
        }

        function formatTsiDateShort(dateStr) {
            if (!dateStr) return '';
            var parts = dateStr.split('-');
            if (parts.length < 3) return dateStr;
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return parseInt(parts[2]) + '-' + months[parseInt(parts[1]) - 1] + '-' + parts[0];
        }

        // ---- QUICK LINKS ----
        const QL_SECTIONS = [
          {id:"programs",t:"Work Tools",bl:"PRG",kc:"k-prg",l:[
            {n:"SWAMOC",d:"Overtime Login",u:"https://swamoc.com/Login/notlogin.php"},
            {n:"MXI",d:"Maintenix",u:"https://maintenix.acmx.prod.swacorp.com/maintenix"},
            {n:"WOLF Flowsheet",d:"Ops Suite Schedule",u:"https://opssuitemain.swacorp.com/schedule"},
            {n:"EVA",d:"Fleet Summary",u:"https://eva.acmx.prod.swacorp.com/v3/mx_eva_webapp/#/summary/lists/fleet"},
            {n:"FlightKeys",d:"5D Visual Dispatch",u:"https://globalui.fpflightkeys.prod.aws.swacorp.com/auth/signIn?rd=https://globalui.fpflightkeys.prod.aws.swacorp.com/5d-visual-angular/"},
            {n:"AirlineTechs",d:"MAX Flight Deck",u:"http://www.airlinetechs.com/flightdeckzoom/MAXflightdeck.php"},
            {n:"Hermes",d:"Maintenance Login",u:"https://hwm.swacorp.com/MaintUser/Account/LogOn?ReturnUrl=%2fMaintUser%2f"},
            {n:"DocuNet",d:"Manuals SSO",u:"https://docunet-online-us.vistair.com/"},
            {n:"TSR",d:"Salesforce Lightning",u:"https://techopsappportal.lightning.force.com/lightning/app/06mKZ000000gkicYAA"},
            {n:"PARAPP",d:"Salesforce Tech Ops",u:"https://techopsappportal.lightning.force.com/lightning/app/06m410000002ZCIAA2"},
            {n:"Comply365",d:"Document Access",u:"https://swa.comply365.net/"},
            {n:"Toolbox Backup",d:"Remote Access",u:"http://w11pcwtbr1ap001:8080/ToolboxRemote.html"},
            {n:"Wheel & Brake",d:"Search Q & S/N",u:"https://prod.wb-acmx.swalife.com/#/tag-list"},
            {n:"Airvault",d:"Records Archive",u:"https://airvault.criticaltech.com/zfp/?whr=https://sso.fed.prod.aws.swalife.com/idp/prp.wsf"},
            {n:"Ops Dashboard",d:"Operational Suite",u:"https://opssuitemain.swacorp.com/operational-dashboard"},
          ]},
          {id:"manuals",t:"Manuals",bl:"",kc:"",l:[
            {n:"AOM",d:"Aircraft Operating Manual",b:"AOM",kc:"k-aom",mk:"AOM"},
            {n:"FOM",d:"Flight Operations Manual",b:"FOM",kc:"k-fom",mk:"FOM"},
            {n:"MPM",d:"Maintenance Procedures",b:"MPM",kc:"k-mpm",mk:"MPM"},
            {n:"DOM",d:"Dispatch Operations",b:"DOM",kc:"k-dom",mk:"DOM"},
            {n:"GOM",d:"Ground Operations",b:"GOM",kc:"k-gom",mk:"GOM"},
            {n:"IFOM",d:"Intl Flight Ops",b:"IFOM",kc:"k-ifom",mk:"IFOM"},
            {n:"TOH",d:"Tech Ops Handbook",b:"TOH",kc:"k-toh",mk:"TOH"},
            {n:"MEL - MAX",d:"B737 MAX MEL",b:"MEL",kc:"k-mel",mk:"MEL MAX"},
            {n:"MEL - NG",d:"B737 NG MEL",b:"MEL",kc:"k-mel",mk:"MEL NG"},
            {n:"FRM - MAX",d:"Fault Reporting MAX",b:"FRM",kc:"k-frm",mk:"FRM MAX"},
            {n:"FRM - -7/800",d:"Fault Reporting -7/800",b:"FRM",kc:"k-frm",mk:"FRM 78"},
            {n:"FRM - GIP",d:"General Inspection",b:"FRM",kc:"k-frm",mk:"FRM GIP"},
          ]},
          {id:"quickbase",t:"QuickBase",bl:"QB",kc:"k-qb",l:[
            {n:"CESE",d:"CESE Database",u:"https://southwest.quickbase.com/db/bqmgu82c8"},
            {n:"W/O",d:"Work Orders",u:"https://southwest.quickbase.com/db/bmxb4hwm5?a=nwr"},
            {n:"HRON Request",d:"HRON Parts",u:"https://southwest.quickbase.com/db/bp2ra8s7e?a=nwr"},
            {n:"CATIII",d:"Category III",u:"https://southwest.quickbase.com/db/bmxb4mp6b?a=nwr"},
            {n:"AOG",d:"Aircraft on Ground",u:"https://southwest.quickbase.com/db/bmq3qfu94"},
            {n:"NRFO",d:"Non-Routine Flight Ops",u:"https://southwest.quickbase.com/db/bpux4n44k"},
            {n:"WWI",d:"Work Without Items",u:"https://southwest.quickbase.com/db/btdkqvnze"},
            {n:"INTL Checklist",d:"MOC Downline",u:"https://southwest.quickbase.com/db/bmc2jq3ms"},
            {n:"INTL STA Mgr",d:"Must Email List",u:"https://southwest.quickbase.com/db/bn77k9b4c/tablereport?a=td"},
            {n:"INTL Badge/Travel",d:"Dress Code",u:"https://southwest.quickbase.com/db/bn9xycn7x?a=td"},
          ]},
          {id:"swalife",t:"SWALife / SharePoint",bl:"SP",kc:"k-sp",l:[
            {n:"MOC Schedule",d:"2026 Schedule",u:"https://wnco-my.sharepoint.com/:x:/r/personal/kevin_gales_wnco_com/_layouts/15/Doc.aspx?sourcedoc=%7B1ABE7E53-D9D6-4A3F-A7A4-D5233C0BF1D6%7D&file=2026%20MOC%20Schedule.xlsx&action=default&mobileredirect=true"},
            {n:"VAC/SICK Track",d:"TechOps Workforce",u:"https://techopsworkforce.swalife.com/"},
            {n:"F/T Schedule",d:"2026 Calendar",u:"https://wnco.sharepoint.com/:x:/r/sites/FieldTechs/_layouts/15/Doc.aspx?sourcedoc=%7B45BB5508-CB41-4CFE-A775-A9CD98EB6E90%7D&file=2026%20Field%20Tech%20Calendar.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1"},
            {n:"Turnover",d:"Short Tails Turnover",u:"https://wnco-my.sharepoint.com/:x:/r/personal/elvy_tavarez_wnco_com/_layouts/15/Doc.aspx?sourcedoc=%7B2AAE5886-2744-4475-A3E5-192329269704%7D&file=SHORT%20TAILS%20TURNOVER.xlsx&action=default&mobileredirect=true"},
            {n:"All Manuals",d:"SWALife Manuals Page",u:"https://wnco.sharepoint.com/sites/SWALife-Manuals"},
            {n:"NOC Manuals",d:"Manuals & Regs",u:"https://wnco.sharepoint.com/sites/SWALife-NOC-Secure/SitePages/Manuals-Regs.aspx"},
            {n:"SA-M Forms",d:"DocuNet TOF Forms",u:"https://sso.fed.prod.aws.swalife.com/idp/startSSO.ping?PartnerSpId=SWA.usernet.vistair.com&TARGET=https://docunet-online-us.vistair.com/?manualCode=SWA-CPUBS-TOF-HTML"},
            {n:"M-EA Library",d:"M-EA Library OCT2025",u:"https://wnco.sharepoint.com/sites/ServiceEngineering-AOG/MEA%20Library/Forms/AllItems.aspx?viewid=8868442c%2Ddb52%2D42bc%2Dafb4%2Da5bb36f0579a&id=%2Fsites%2FServiceEngineering%2DAOG%2FMEA%20Library%2FM%2DEA%20Library%2FM%2DEA%20Library%20OCT2025%2Epdf&parent=%2Fsites%2FServiceEngineering%2DAOG%2FMEA%20Library%2FM%2DEA%20Library&CT=1771957645134&OR=OWA%2DNT%2DMail&CID=d5480132%2Dd843%2D8531%2D42d2%2Ddb7edf24be1d"},
            {n:"Know Before Fix",d:"Tech Ops News",u:"https://wnco.sharepoint.com/sites/SWALife-TechOps-Secure/_layouts/15/news.aspx?title=Know%20Before%20Fix&newsSource=1&instanceId=661b4ac4-5eba-48f9-bb71-c88329fe9303&webPartId=8c88f208-6c77-4bdb-86a0-0c47b4316588&serverRelativeUrl=%2Fsites%2FSWALife-TechOps-Secure%2FSitePages%2FKnow-Before-Fix.aspx&pagesListId=17ba2016-b85b-4d0a-b2b3-4fb4340e0ff9"},
            {n:"FDR/CVR Request",d:"Flight Data Recorder",u:"https://wnco.sharepoint.com/sites/SWALife-Departments/SitePages/FDR-CVR-Request-Form.aspx"},
            {n:"Parts - August",d:"800 + MAX Parts",u:"https://wnco-my.sharepoint.com/:x:/r/personal/august_stefkovich_wnco_com/_layouts/15/Doc.aspx?sourcedoc=%7B85042E4A-67F8-4806-9B5B-94413A8CD9D4%7D&file=New%20800%20%2B%20MAX%20Parts%20List.xlsx&action=default&mobileredirect=true"},
            {n:"Parts - MAX",d:"Whittington MAX",u:"https://wnco-my.sharepoint.com/:x:/r/personal/michael_whittington_wnco_com/_layouts/15/Doc.aspx?sourcedoc=%7B993277FB-ADE7-4AF9-8683-0FE5A3D2999E%7D&file=Max%20Spreadsheet.xlsx&wdOrigin=OFFICECOM-WEB.START.REC&ct=1648416000257&action=default&mobileredirect=true"},
            {n:"Parts - 800",d:"Whittington 800",u:"https://wnco-my.sharepoint.com/:x:/r/personal/michael_whittington_wnco_com/_layouts/15/Doc.aspx?sourcedoc=%7BB5425EC5-FC51-47FC-AE31-DE711C4BA4BB%7D&file=800%20Spreadsheet.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1&ct=1649979558093&wdOrigin=OFFICECOM-WEB.MAIN.EDGEWORTH&cid=7d691ba0-24b7-4512-b074-209a32ab1071"},
            {n:"Parts - NG",d:"Whittington NG",u:"https://wnco-my.sharepoint.com/:x:/r/personal/michael_whittington_wnco_com/_layouts/15/Doc.aspx?sourcedoc=%7B4605EAA3-DC1C-4639-BA97-D7B3C57835E1%7D&file=NG%20Spreadsheet.xlsx&wdOrigin=OFFICECOM-WEB.START.REC&ct=1648416039990&action=default&mobileredirect=true"},
            {n:"Parts - MISC",d:"Whittington Misc",u:"https://wnco-my.sharepoint.com/:x:/r/personal/michael_whittington_wnco_com/_layouts/15/Doc.aspx?sourcedoc=%7B25DEE148-0B92-4C0B-83D0-903E128D1E31%7D&file=Misc%20Spreadsheet.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1&ct=1649979571309&wdOrigin=OFFICECOM-WEB.MAIN.EDGEWORTH&cid=fe0faa20-d85c-430d-9254-fcf3838d2907"},
            {n:"Shadow Board",d:"Digital MX Links",u:"https://wnco.sharepoint.com/sites/SWALife-MXLinks/Lists/Digital%20Shadow%20Board/AllItems.aspx?env=WebViewList"},
            {n:"Specialty Aircraft",d:"Stock Images",u:"https://wnco.sharepoint.com/sites/SouthwestStockImages/SitePages/Aircraft.aspx"},
            {n:"Campus Resources",d:"Getting to TOPS",u:"https://wnco.sharepoint.com/sites/SWALife-Training/SitePages/Resources.aspx#getting-to-tops"},
            {n:"ALL CBA's",d:"Collective Bargaining",u:"https://wnco.sharepoint.com/sites/SWALife-Labor-Negotiations/SitePages/Collective-Bargaining-Agreements.aspx"},
            {n:"DASH Chat",d:"ServiceNow Virtual Agent",u:"https://southwest.service-now.com/swa?id=swa_virtual_agent"},
            {n:"SWA Password",d:"Password Manager",u:"https://passwordmgr.swalife.com/"},
            {n:"Flight Schedules",d:"Network Planning Reports",u:"https://wnco.sharepoint.com/sites/SWALife-Flight-Schedules/SitePages/Network-Planning-Reports.aspx"},
          ]},
          {id:"boeing",t:"Boeing Toolbox",bl:"MBF",kc:"k-mbf",edge:true,l:[
            {n:"MBF Login 1st",d:"My Boeing Fleet Home",u:"https://sso.fed.prod.aws.swalife.com/idp/startSSO.ping?PartnerSpId=urn%3Aexostar%3Adaf&TargetResource=https://sso.aviationid.com/idprov/pages/home/dispatch.jsp%3FSpName=MBF"},
            {n:"MAX Req Placards",d:"Task Cards",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F70D27DDB73/MAX_taskcards.html?mimeType=text/html"},
            {n:"Emergency Equip",d:"Equipment Drawing",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F70A50AD549/emergency_equip_install.html?mimeType=text/html"},
            {n:"Ext Markings",d:"Placards Drawing",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F6B2564D285/exterior_markings.html?mimeType=text/html"},
            {n:"Tamper Strips",d:"Strip Drawings",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F6BD7D82575/antitamperstrips.html?mimeType=text/html"},
            {n:"Carpet Layout",d:"Layout Drawings",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F6E1FC70D9E/carpetlayouts.html?mimeType=text/html"},
            {n:"PMA List",d:"Parts Approval",u:"https://myboeingfleet.boeing.com/toolbox/library/html/library/openAirlineDoc.htm?queryString=/toolbox/library/ViewAirlineDoc/89893F6BE50A7A10.pdf?mimeType=application/pdf"},
            {n:"Life Limited Parts",d:"NG Parts List",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F6DED09AE65/parentng.html?mimeType=text/html"},
            {n:"HAZMAT Search",d:"MAXCOM SDS",u:"https://app.maxcomsc.com/maxcomsc/index.jsp?ju=Southwest&jp=msds"},
            {n:"MAX Task",d:"MAX Task Cards",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F6E71BADF98/MAX_taskcards.html?mimeType=text/html"},
            {n:"MAX ETOPS Task",d:"MAX ETOPS Cards",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F6B6B7DC239/MAX_ETOPS_taskcards.html?mimeType=text/html"},
            {n:"NG Task",d:"NG Task Cards",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F706F832878/NG_Task_Cards.html?mimeType=text/html"},
            {n:"NG ETOPS Task",d:"NG ETOPS Cards",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F6E4B55EED6/ETOPS_taskcards.html?mimeType=text/html"},
            {n:"Interior Placards",d:"Placard Drawings",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F70DED9F7B8/interior_placards.html?mimeType=text/html"},
            {n:"Recaro DWG",d:"Seat 25-22-40",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F6F91E6D874/25-22-40.html?mimeType=text/html"},
            {n:"Exterior Paint",d:"Paint Scheme Drawings",u:"https://myboeingfleet.boeing.com/toolbox/library/ViewAirlineDoc/linked_doc/89893F70E5B8EA1F/exteriorpaint.html?mimeType=text/html"},
          ]},
          {id:"tableau",t:"Tableau",bl:"TAB",kc:"k-tab",l:[
            {n:"Heavy Mx Lines",d:"MX Lines 90 Days",u:"https://tableau.swacorp.com/#/views/MXLines-90Days/MXLines-90Days?:display_count=n&:iid=4&:origin=viz_share_link&:showAppBanner=false&:showVizHome=n"},
            {n:"MTX DMI",d:"Daily Scheduled W/O",u:"https://tableau.swacorp.com/#/views/RevisedDailyScheduledWorkOrders/MTXDMI?:iid=1"},
            {n:"Fault Search",d:"Reliability Discrepancies",u:"https://tableau.swacorp.com/#/views/ReliabilityDiscrepanciesSearch/LightTheme?:iid=1"},
            {n:"Load Factors",d:"Projected System LF",u:"https://tableau.swacorp.com/#/views/ProjectedLoadFactors/ProjectedSystemLF?:iid=3"},
            {n:"Seat Tool",d:"ACN Seat Mapping",u:"https://tableau.swacorp.com/#/views/SeatMappingTool_15949973582980/ACNSeatMappingTool?:iid=2"},
            {n:"Aircraft Config",d:"Cabin Modernization",u:"https://tableau.swacorp.com/#/views/CabinModernizationDashboard/CabinModernizationNon-SeatEffortsDashboard?:iid=5"},
            {n:"Line Ron Hours",d:"Line RON Labor",u:"https://tableau.swacorp.com/#/views/RevisedDailyScheduledWorkOrders/LineRONLabor?:iid=2"},
          ]},
          {id:"comply365",t:"Comply365",bl:"C365",kc:"k-c365",l:[
            {n:"Station SIPs",d:"Station Info Pages",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=47"},
            {n:"Door Codes",d:"Station Door Codes",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=47"},
            {n:"Ops Binder",d:"Flight Ops Publications",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=1004"},
            {n:"Wiring Practices",d:"Wiring Standard Practices",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=981"},
            {n:"Wire Connector",d:"Electrical Connectors Guide",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=981"},
            {n:"Circuit Breakers",d:"CircuitBreakers-ALL",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=981"},
            {n:"Station Charts",d:"Station Reference Charts",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=981"},
            {n:"CAT III Ref",d:"CAT III Systems & Equip Card",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=981"},
            {n:"CAT III-HGS Tips",d:"HGS Maintenance Tips",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=981"},
            {n:"RYNGLOK Fittings",d:"Fittings Design Guide",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=981"},
            {n:"NG Software Config",d:"NG Config Sheet",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=1341"},
            {n:"MAX Software Config",d:"MAX Config Matrix",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=1341"},
            {n:"UMD Passwords",d:"Current & Past UMD",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=1341"},
            {n:"FD Panels",d:"Flight Deck Panel Layouts",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=978"},
            {n:"RBFs",d:"Required Bulletins",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=1517"},
            {n:"LOTO Video",d:"Lockout/Tagout AMM 27-51",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=987"},
            {n:"Inflate Shelter",d:"Engine/Fuselage/Nose",u:"https://swa.comply365.net/DCM/Libraries.aspx?Id=987"},
          ]},
          {id:"weather",t:"Weather / Ops",bl:"WX",kc:"k-wx",l:[
            {n:"Windy",d:"Wind & Weather Map",u:"https://www.windy.com/-Menu/menu?31.579,-98.361,6"},
            {n:"Icing",d:"Aviation Weather GFA",u:"https://aviationweather.gov/gfa/#ice"},
            {n:"Winds Aloft",d:"Aviation Weather GFA",u:"https://aviationweather.gov/gfa/#winds"},
            {n:"GPSJAM",d:"GPS/GNSS Interference",u:"https://gpsjam.org/?lat=34.40449&lon=-97.18424&z=7.1&date=2024-10-10"},
            {n:"Defense NOTAMS",d:"GPS & Center Select",u:"https://www.notams.faa.gov/dinsQueryWeb/"},
            {n:"BirdCast",d:"Live Bird Migration",u:"https://birdcast.info/migration-tools/live-migration-maps/"},
          ]},
          {id:"training",t:"Training / Reference",bl:"TRN",kc:"k-trn",l:[
            {n:"Lightning CBT",d:"TechOps Training",u:"https://techopstraining.swalife.com/"},
            {n:"LMS",d:"SumTotal Training",u:"https://southwest.sumtotal.host/rcore/c/pillarRedirect?relyingParty=AdvancedReport&url=https%3A%2F%2Fsouthwest.sumtotal.host%2Fjasperserver-pro%2F&nodeKey=Advanced_Reporting&nodeUrl=https%3A%2F%2Fsouthwest.sumtotal.host%2Fjasperserver-pro"},
            {n:"NG ETOPS Auth",d:"LMS Authorization",u:"https://southwest.sumtotal.host/jasperserver-pro/flow.html?_flowId=viewReportFlow&reportUnit=%2FCustom%2FReports%2FSub_Reports%2FTOD_Authorization_Reports%2FTech_Ops_Authorization_Report_06&Activity=236571&reportLocale=en"},
            {n:"MAX ETOPS Auth",d:"LMS Authorization",u:"https://southwest.sumtotal.host/jasperserver-pro/flow.html?_flowId=viewReportFlow&reportUnit=%2FCustom%2FReports%2FSub_Reports%2FTOD_Authorization_Reports%2FTech_Ops_Authorization_Report_06&Activity=237216&reportLocale=en"},
            {n:"FAA MEL Search",d:"DRS Search",u:"https://drs.faa.gov/search"},
            {n:"Nav Data Cycle",d:"Jeppesen Effective Dates",u:"https://ww2.jeppesen.com/update-cycle-and-effective-dates-schedule/"},
            {n:"MAX YouTube",d:"Video Library",u:"https://www.youtube.com/playlist?list=PLoYyKExFyTLvbOPiBn5IkOSBx2RNVRpwt"},
            {n:"MAX OMF",d:"Web Version",u:"http://www.airlinetechs.com/PDF/Boeing%20MAX/MAX%20Display%20System/07.html"},
            {n:"FAR 121.374",d:"ETOPS CAMP",u:"https://www.ecfr.gov/current/title-14/chapter-I/subchapter-G/part-121/subpart-L/section-121.374"},
            {n:"AC 120-42B",d:"ETOPS & Polar Ops",u:"https://www.faa.gov/regulations_policies/advisory_circulars/index.cfm/go/document.information/documentid/73587"},
          ]}
        ];

        // Flatten for backward-compatible search integration
        const QUICK_LINKS = [];
        QL_SECTIONS.forEach(sec => {
            sec.l.forEach(lk => {
                QUICK_LINKS.push({
                    abbr: lk.b || sec.bl,
                    name: lk.n + (lk.d ? ' - ' + lk.d : ''),
                    key: lk.mk || null,
                    custom: !lk.mk,
                    url: lk.u || '#',
                    kc: lk.kc || sec.kc || '',
                    _type: 'link'
                });
            });
        });

        // One place to update if DocuNet URLs ever change
        const defined = "https://sso.fed.prod.aws.swalife.com/idp/startSSO.ping?PartnerSpId=SWA.usernet.vistair.com&TARGET=https://docunet-online-us.vistair.com";
        const MANUAL_LINKS = {
            "AOM":     {name:"B737 Aircraft Operating Manual", url:defined+"/SWA?manualCode%3DSWA-CPUBS-B737AOM-HTML"},
            "FOM":     {name:"Flight Operations Manual", url:defined+"/SWA?manualCode%3DSWA-CPUBS-FOM-HTML"},
            "MPM":     {name:"Maintenance Procedures Manual", url:defined+"/?manualCode=SWA-CPUBS-MPM-HTML"},
            "MEL MAX": {name:"B737 MAX MEL", url:defined+"/?manualCode=SWA-CPUBS-B737MAXMEL-HTML"},
            "MEL NG":  {name:"B737 NG MEL", url:defined+"/?manualCode=SWA-CPUBS-B737NGMEL-HTML"},
            "GOM":     {name:"Ground Operations Manual", url:defined+"/?manualCode=SWA-CPUBS-GOM-HTML"},
            "IFOM":    {name:"International Flight Operations Manual", url:defined+"/SWA?manualCode%3DSWA-CPUBS-IFOM-HTML"},
            "FRM MAX": {name:"FRM MAX", url:defined+"/?manualCode%3DSWA-CPUBS-FRMMAX-HTML"},
            "FRM 78":  {name:"FRM -7/-800", url:defined+"/?manualCode%3DSWA-CPUBS-FRM78-HTML"},
            "FRM GIP": {name:"FRM General Inspection Program", url:defined+"/SWA?manualCode%3DSWA-CPUBS-FRMGIP-HTML"},
            "FAM":     {name:"Flight Attendant Manual", url:defined+"/?manualCode=SWA-CPUBS-FAM-HTML"},
            "FAH":     {name:"Flight Attendant Handbook", url:defined+"/?manualCode=SWA-CPUBS-FAH-HTML"},
            "FQM":     {name:"Fuel Quality Manual", url:defined+"/?manualCode=SWA-CPUBS-FQM-HTML"},
            "DOM":     {name:"Dispatch Operations Manual", url:defined+"/SWA?manualCode%3DSWA-CPUBS-DOM-HTML"},
            "TOH":     {name:"Technical Operations Handbook", url:defined+"/SWA?manualCode=SWA-CPUBS-TOH-HTML"},
            "FRMP":    {name:"Fuel Resource Management Program", url:defined+"/?manualCode=SWA-CPUBS-FRMP-HTML"},
            "ESP":     {name:"Emergency & Security Procedures", url:defined+"/?manualCode=SWA-CPUBS-ESP-HTML"},
            "EFBM":    {name:"Electronic Flight Bag Manual", url:defined+"/?manualCode=SWA-CPUBS-EFBM-HTML"},
            "ESPM":    {name:"Engine Shop Procedures Manual", url:defined+"/?manualCode=SWA-CPUBS-ESPM-HTML"},
            "CAG":     {name:"Cabin Appearance Guide", url:defined+"/?manualCode=SWA-CPUBS-CAG-HTML"},
            "SMM":     {name:"Safety Management Manual", url:defined+"/?manualCode=SWA-CPUBS-SMM-HTML"},
            "WBM":     {name:"Weight & Balance Manual", url:defined+"/?manualCode=SWA-CPUBS-WBM-HTML"},
            "STORM":   {name:"STORM Manual", url:defined+"/?manualCode=SWA-CPUBS-STORM-HTML"},
            "AQPM":    {name:"Advanced Qualification Program Manual", url:defined+"/?manualCode=SWA-CPUBS-AQPM-HTML"},
            "APOEM":   {name:"Aircraft Performance & Operations Engineering Manual", url:defined+"/?manualCode=SWA-CPUBS-APOEM-HTML"},
            "GOEH":    {name:"Ground Operations Employee Handbook", url:defined+"/?manualCode=SWA-CPUBS-GOEH-HTML"},
            "GOTM":    {name:"Ground Operations Training Manual", url:defined+"/?manualCode=SWA-CPUBS-GOTM-HTML"},
            "NSOM":    {name:"Network & Station Operations Manual", url:defined+"/?manualCode=SWA-CPUBS-NSOM-HTML"},
            "OPSM":    {name:"Operations Manual", url:defined+"/?manualCode=SWA-CPUBS-OPSM-HTML"},
            "PBNPM":   {name:"PBN Program Manual", url:defined+"/?manualCode=SWA-CPUBS-PBNPM-HTML"},
            "SWOM":    {name:"SWA Operations Manual", url:defined+"/?manualCode=SWA-CPUBS-SWOM-HTML"},
            "SAMPM":   {name:"SWA Asset Management Procedures Manual", url:defined+"/?manualCode=SWA-CPUBS-SAMPM-HTML"},
            "TOSM":    {name:"Tech Ops Security Manual", url:defined+"/?manualCode=SWA-CPUBS-TOSM-PDF"},
            "GOSM":    {name:"Ground Ops Security Manual", url:defined+"/?manualCode%3DSWA-CPUBS-GOSM-PDF"},
            "TOF":     {name:"Technical Operations Forms", url:defined+"/?manualCode=SWA-CPUBS-TOF-HTML"},
            "ODA":     {name:"ODA Manual", url:defined+"/?manualCode=SWA-CPUBS-ODA-HTML"},
            "ISG":     {name:"Inflight Service Guide", url:defined+"/?manualCode=SWA-CPUBS-ISG-HTML"},
            "IFRMP":   {name:"International Fuel Resource Management Program", url:defined+"/?manualCode=SWA-CPUBS-IFRMP-HTML"},
            "FODPM":   {name:"FOD Prevention Manual", url:defined+"/?manualCode=SWA-CPUBS-FODPM-HTML"},
        };

        // Match a ref string to a manual link key
        function findManualKey(ref) {
            const r = ref.toUpperCase();
            // Try exact prefix matches (longest first to avoid false matches)
            const keys = Object.keys(MANUAL_LINKS).sort((a,b) => b.length - a.length);
            for (const k of keys) {
                if (r.startsWith(k + " ") || r.startsWith(k + ".") || r === k) return k;
            }
            // Special cases
            if (r.startsWith("MEL ")) return null; // handled separately
            if (r.includes("FOM ") || r.startsWith("FOM")) return "FOM";
            if (r.includes("AOM ") || r.startsWith("AOM")) return "AOM";
            if (r.includes("MPM ") || r.startsWith("MPM")) return "MPM";
            if (r.includes("GOM ") || r.startsWith("GOM")) return "GOM";
            if (r.includes("IFOM ") || r.startsWith("IFOM")) return "IFOM";
            return null;
        }

        // Render a ref as clickable link or plain text
        function renderRef(ref, words) {
            const r = ref.toUpperCase();
            const escaped = highlight(ref, words || []);

            // MEL special case - show both MAX and NG
            if (r.startsWith("MEL ") || r === "MEL") {
                return `<span class="result-ref result-ref-link" onclick="showMelChoice()">${escaped}</span>`;
            }

            // FRM special case - show MAX and 78 options
            if (r.startsWith("FRM ") && !r.startsWith("FRM MAX") && !r.startsWith("FRM 78") && !r.startsWith("FRM GIP")) {
                return `<span class="result-ref result-ref-link" onclick="showFrmChoice()">${escaped}</span>`;
            }

            const key = findManualKey(ref);
            if (key && MANUAL_LINKS[key]) {
                const url = MANUAL_LINKS[key].url;
                return `<span class="result-ref result-ref-link" onclick="openManual('${key}')" title="Open ${MANUAL_LINKS[key].name}">${escaped}</span>`;
            }
            return `<span class="result-ref">${escaped}</span>`;
        }

        function openManual(key) {
            const link = MANUAL_LINKS[key];
            if (link) window.open(link.url, 'docunet');
        }

        function showMelChoice() {
            const choice = document.createElement('div');
            choice.className = 'manual-choice-overlay';
            choice.innerHTML = `
                <div class="manual-choice-box">
                    <div class="manual-choice-title">Which MEL?</div>
                    <button onclick="openManual('MEL MAX');this.closest('.manual-choice-overlay').remove()">MAX MEL</button>
                    <button onclick="openManual('MEL NG');this.closest('.manual-choice-overlay').remove()">NG MEL</button>
                    <button class="manual-choice-cancel" onclick="this.closest('.manual-choice-overlay').remove()">Cancel</button>
                </div>`;
            document.body.appendChild(choice);
        }

        function showFrmChoice() {
            const choice = document.createElement('div');
            choice.className = 'manual-choice-overlay';
            choice.innerHTML = `
                <div class="manual-choice-box">
                    <div class="manual-choice-title">Which FRM?</div>
                    <button onclick="openManual('FRM MAX');this.closest('.manual-choice-overlay').remove()">FRM MAX</button>
                    <button onclick="openManual('FRM 78');this.closest('.manual-choice-overlay').remove()">FRM -7/-800</button>
                    <button onclick="openManual('FRM GIP');this.closest('.manual-choice-overlay').remove()">FRM GIP</button>
                    <button class="manual-choice-cancel" onclick="this.closest('.manual-choice-overlay').remove()">Cancel</button>
                </div>`;
            document.body.appendChild(choice);
        }

        // ---- RENDER ----

        function render() {
            const q = searchInput.value.trim().toLowerCase();
            const words = q ? q.split(/\s+/) : [];

            if (!q && activeFilter === 'ALL') {
                resultsArea.innerHTML = `
                    <div class="results-empty">
                        <p class="qrh-tagline">All references. All manuals. All apps. One search.</p>
                        <p class="hint">Type to search or select a category filter</p>
                        <div class="stats-line"><span>${DATA.length}</span> entries &middot; <span>${TSI_ENTRIES.length}</span> TSI records &middot; <span>${Object.keys(MANUAL_LINKS).length}</span> manuals linked &middot; <span>${APPS.length}</span> app${APPS.length !== 1 ? 's' : ''}</div>
                    </div>`;
                return;
            }

            // Determine what to show based on filter
            const showQRH = activeFilter !== 'FIX' && activeFilter !== 'APP';
            const showFixes = activeFilter === 'ALL' || activeFilter === 'FIX';
            const showApps = activeFilter === 'ALL' || activeFilter === 'APP';

            // QRH results
            let qrhResults = [];
            if (showQRH) {
                qrhResults = DATA;
                if (activeFilter !== 'ALL') {
                    qrhResults = qrhResults.filter(d => d.cat.toUpperCase().startsWith(activeFilter));
                }
                if (q) {
                    qrhResults = qrhResults.filter(d => {
                        const hay = (d.cat + ' ' + d.title + ' ' + d.refs.join(' ') + ' ' + (d.note || '')).toLowerCase();
                        return words.every(w => hay.includes(w));
                    });
                }
            }

            // Fix Rate results
            let fixResultsList = [];
            if (showFixes) {
                fixResultsList = TSI_ENTRIES;
                if (q) {
                    fixResultsList = fixResultsList.filter(d => {
                        const hay = [d.faultCode||'', d.effect||'', d.tail||'', d.ata||'', d.fleet||'', d.notes||''].join(' ').toLowerCase();
                        return words.every(w => hay.includes(w));
                    });
                }
            }

            // App results
            let appResults = [];
            if (showApps) {
                appResults = APPS;
                if (q) {
                    appResults = appResults.filter(a => {
                        const hay = (a.title + ' ' + a.description + ' ' + a.keywords).toLowerCase();
                        return words.every(w => hay.includes(w));
                    });
                }
            }

            // Quick Link results
            let qlResults = [];
            if (q && (activeFilter === 'ALL' || activeFilter === 'APP')) {
                qlResults = QUICK_LINKS.filter(ql => {
                    if (ql.section) return false;
                    const hay = ((ql.abbr || '') + ' ' + (ql.name || '') + ' ' + (ql.key || '')).toLowerCase();
                    return words.every(w => hay.includes(w));
                });
            }

            const totalResults = qrhResults.length + fixResultsList.length + appResults.length + qlResults.length;

            if (totalResults === 0) {
                resultsArea.innerHTML = '<div class="results-empty"><p>No results found</p></div>';
                return;
            }

            let html = `<div class="result-count">${totalResults} result${totalResults !== 1 ? 's' : ''}</div>`;

            // Render QRH cards
            qrhResults.forEach((d, idx) => {
                const style = tagStyle(d.cat);
                const titleKey = findManualKey(d.title);
                const titleText = highlight(d.title, words);
                const titleHtml = titleKey
                    ? `<span class="result-title result-title-link" onclick="openManual('${titleKey}')" title="Open ${MANUAL_LINKS[titleKey].name}">${titleText}</span>`
                    : `<span class="result-title">${titleText}</span>`;

                const copyText = d.refs.length ? d.refs[0] : d.title;
                const hasNote = d.note && d.note.trim();
                const hasFile = d.file && d.file.trim();
                let indicators = '';
                if (hasNote) indicators += `<span class="card-indicator note-indicator" onclick="event.stopPropagation();toggleNote('note-${idx}')" title="Controller Note">NOTE</span>`;
                if (hasFile) indicators += `<span class="card-indicator file-indicator" onclick="event.stopPropagation();openFile('${(d.file||'').replace(/'/g,"\\'")}')" title="Open file">FILE</span>`;

                const typeBadge = d.type || 'qrh';
                const typeLabel = {qrh:'QRH', defect:'DEFECT', template:'TEMPLATE', app:'APP'}[typeBadge] || 'QRH';
                const typeClass = 'ac-type-' + typeBadge;

                html += `<div class="result-card"><div class="result-card-header">
                    <span class="ac-type-badge ${typeClass}">${typeLabel}</span>
                    <span class="result-tag" style="${style}">${highlight(d.cat, words)}</span>
                    ${titleHtml}
                    ${indicators}
                    <button class="copy-btn" onclick="event.stopPropagation();copyRef('${copyText.replace(/'/g,"\\'")}', this)" title="Copy reference">COPY</button>
                </div>`;
                if (d.refs.length) {
                    html += '<div class="result-refs">';
                    d.refs.forEach(r => { html += renderRef(r, words); });
                    html += '</div>';
                }
                if (hasNote) {
                    html += `<div class="card-note" id="note-${idx}"><div class="card-note-label">CONTROLLER NOTE</div><div class="card-note-text">${highlight(d.note, words)}</div></div>`;
                }
                html += '</div>';
            });

            // Render fix rate cards inline
            fixResultsList.forEach(function(d) {
                var statusLabel = d.status === 'in_work' ? 'IN WORK' : d.status === 'closed_eff' ? 'EFFECTIVE' : 'INEFFECTIVE';
                var statusClass = d.status === 'in_work' ? 'fts-work' : d.status === 'closed_eff' ? 'fts-eff' : 'fts-ineff';
                html += `<div class="fix-entry-card" style="cursor:pointer" onclick="document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab=fixrate]').classList.add('active');document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));document.getElementById('fixrate').classList.add('active');fixSearchInput.value='${esc(d.faultCode||'')}';renderFixRate();">
                    <div class="fec-header">
                        <span class="fec-status ${statusClass}">${statusLabel}</span>
                        <span class="fec-tail">${esc(d.tail||'')}</span>
                        <span class="fec-fleet">${esc(d.fleet||'')}</span>
                        <span class="fec-fc">${esc(d.faultCode||'')}</span>
                        <span class="fec-effect">${highlight(d.effect||'', words)}</span>
                    </div>
                </div>`;
            });

            // Render app cards inline
            appResults.forEach(a => {
                html += `<div class="app-result-card" onclick="window.location.href='${a.url}'">
                    <div class="app-result-header">
                        <span class="ac-type-badge ac-type-app">APP</span>
                        <span class="app-result-title">${highlight(a.title, words)}</span>
                    </div>
                    <div class="app-result-desc">${highlight(a.description, words)}</div>
                    <div class="app-result-launch">LAUNCH APP &rarr;</div>
                </div>`;
            });

            // Render Quick Link cards inline
            qlResults.forEach(ql => {
                const onclick = ql.custom
                    ? (ql.url ? `window.open('${ql.url}','docunet')` : '')
                    : (ql.key && MANUAL_LINKS[ql.key] ? `openManual('${ql.key}')` : '');
                html += `<div class="app-result-card" onclick="${onclick}" style="cursor:pointer">
                    <div class="app-result-header">
                        <span class="ac-type-badge ac-type-link">LINK</span>
                        <span class="app-result-title">${highlight(ql.name, words)}</span>
                        <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);margin-left:auto">${ql.abbr}</span>
                    </div>
                    <div class="app-result-launch">OPEN MANUAL &rarr;</div>
                </div>`;
            });

            resultsArea.innerHTML = html;
        }

        function toggleNote(id) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('visible');
        }

        function openFile(path) {
            if (path) window.open(path, 'swamx_file', 'width=900,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=yes');
        }

        function esc(s) {
            const el = document.createElement('span');
            el.textContent = s;
            return el.innerHTML;
        }

        // ---- INIT ----
        updateBadges();

        // ---- QUICK LINKS v2: Masonry + Korry ----
        var qlFavs = JSON.parse(localStorage.getItem('qlFavs') || '[]');
        var qlCollapsed = JSON.parse(localStorage.getItem('qlCollapsed') || '[]');

        function qlFk(s, n) { return s + '::' + n; }
        function qlIsF(s, n) { return qlFavs.indexOf(qlFk(s, n)) !== -1; }
        function qlFindL(s, n) {
            for (var i = 0; i < QL_SECTIONS.length; i++) {
                if (QL_SECTIONS[i].id === s)
                    for (var j = 0; j < QL_SECTIONS[i].l.length; j++)
                        if (QL_SECTIONS[i].l[j].n === n) return { sec: QL_SECTIONS[i], lk: QL_SECTIONS[i].l[j] };
            }
            return null;
        }

        function qlToggleFav(sid, nm, e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            var k = qlFk(sid, nm), i = qlFavs.indexOf(k);
            if (i === -1) qlFavs.push(k); else qlFavs.splice(i, 1);
            localStorage.setItem('qlFavs', JSON.stringify(qlFavs));
            qlRenderAll();
        }

        function qlToggleSec(sid) {
            var i = qlCollapsed.indexOf(sid);
            if (i === -1) qlCollapsed.push(sid); else qlCollapsed.splice(i, 1);
            localStorage.setItem('qlCollapsed', JSON.stringify(qlCollapsed));
            qlRenderMasonry();
        }

        var isEdge = /Edg\//.test(navigator.userAgent);

        function qlOpenLink(lk, sec) {
            if (lk.mk && MANUAL_LINKS[lk.mk]) {
                openManual(lk.mk);
            } else if (lk.u && lk.u !== '#') {
                if (sec && sec.edge && !isEdge) {
                    navigator.clipboard.writeText(lk.u).then(function() {
                        qlToast('URL copied - open in Edge browser');
                    });
                } else {
                    window.open(lk.u, '_blank');
                }
            }
        }

        function qlToast(msg) {
            var t = document.createElement('div');
            t.textContent = msg;
            t.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:10px 20px;border-radius:8px;font-size:13px;font-family:DM Sans,sans-serif;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:opacity 0.3s;';
            document.body.appendChild(t);
            setTimeout(function() { t.style.opacity = '0'; setTimeout(function() { t.remove(); }, 300); }, 2500);
        }

        function qlTileH(sec, lk, fv) {
            var si = QL_SECTIONS.indexOf(sec);
            var li = sec.l.indexOf(lk);
            var e = lk.n.replace(/'/g, "\\'");
            var bl = lk.b || sec.bl;
            var kc = lk.kc || sec.kc;
            var sc = fv ? 'ql-star fv' : 'ql-star';
            var ch = fv ? '&#9733;' : '&#9734;';
            return '<a class="ql-tile" href="#" data-n="' + lk.n.toLowerCase() + '" data-d="' + (lk.d || '').toLowerCase() + '" title="' + (lk.d || '') + '" onclick="event.preventDefault();qlOpenLink(QL_SECTIONS[' + si + '].l[' + li + '],QL_SECTIONS[' + si + '])">' +
                '<span class="korry ' + kc + '">' + bl + '</span>' +
                '<span class="ql-name">' + lk.n + '</span>' +
                '<button class="' + sc + '" onclick="qlToggleFav(\'' + sec.id + '\',\'' + e + '\',event)">' + ch + '</button>' +
                '</a>';
        }

        function qlRenderFavs() {
            var r = document.getElementById('qlFavRow');
            if (!r) return;
            if (qlFavs.length === 0) { r.innerHTML = ''; document.getElementById('qlFavSec').style.display = 'none'; return; }
            document.getElementById('qlFavSec').style.display = 'flex';
            var h = '';
            for (var i = 0; i < qlFavs.length; i++) {
                var p = qlFavs[i].split('::'), found = qlFindL(p[0], p[1]);
                if (!found) continue;
                var lk = found.lk, sec = found.sec, e = lk.n.replace(/'/g, "\\'");
                var bl = lk.b || sec.bl, kc = lk.kc || sec.kc;
                var si = QL_SECTIONS.indexOf(sec), li = sec.l.indexOf(lk);
                h += '<div class="ql-fav-chip" onclick="qlOpenLink(QL_SECTIONS[' + si + '].l[' + li + '],QL_SECTIONS[' + si + '])">';
                h += '<span class="korry ' + kc + '" style="font-size:8px;padding:2px 4px;">' + bl + '</span>';
                h += '<span class="qfc-n">' + lk.n + '</span>';
                h += '<span class="qfc-x" onclick="event.stopPropagation();qlToggleFav(\'' + sec.id + '\',\'' + e + '\',event)">&#10005;</span>';
                h += '</div>';
            }
            r.innerHTML = h;
        }

        function qlRenderMasonry() {
            var m = document.getElementById('qlMasonry');
            if (!m) return;
            // Build section HTML strings and estimate heights
            var sections = [];
            for (var s = 0; s < QL_SECTIONS.length; s++) {
                var sec = QL_SECTIONS[s], col = qlCollapsed.indexOf(sec.id) !== -1;
                var sh = '<div class="ql-sec-card" data-s="' + sec.id + '">';
                sh += '<div class="ql-sec-hdr ' + (col ? 'collapsed' : '') + '" onclick="qlToggleSec(\'' + sec.id + '\')">';
                sh += '<div style="display:flex;align-items:center"><h3>' + sec.t + '</h3>' + (sec.edge && !isEdge ? '<span style="font-size:9px;color:#ffffff;margin-left:8px;font-family:JetBrains Mono,monospace;">EDGE ONLY</span>' : '') + '<span class="ql-cnt">' + sec.l.length + '</span></div>';
                sh += '<span class="ql-arr">&#9660;</span></div>';
                sh += '<div class="ql-sec-list ' + (col ? 'hidden' : '') + '">';
                for (var j = 0; j < sec.l.length; j++) sh += qlTileH(sec, sec.l[j], qlIsF(sec.id, sec.l[j].n));
                sh += '</div></div>';
                var estH = col ? 36 : 36 + sec.l.length * 37;
                sections.push({html: sh, height: estH});
            }
            // Determine column count based on container width
            var cw = m.clientWidth || 800;
            var numCols = Math.max(2, Math.min(sections.length, Math.floor(cw / 200)));
            // Create columns
            var colHtml = [];
            var colHeights = [];
            for (var c = 0; c < numCols; c++) { colHtml.push(''); colHeights.push(0); }
            // Pack sections into shortest column
            sections.forEach(function(sec) {
                var minIdx = 0, minH = colHeights[0];
                for (var c = 1; c < numCols; c++) {
                    if (colHeights[c] < minH) { minH = colHeights[c]; minIdx = c; }
                }
                colHtml[minIdx] += sec.html;
                colHeights[minIdx] += sec.height;
            });
            // Build final HTML
            var h = '';
            for (var c = 0; c < numCols; c++) {
                h += '<div class="ql-col">' + colHtml[c] + '</div>';
            }
            m.innerHTML = h;
        }

        function qlRenderAll() { qlRenderFavs(); qlRenderMasonry(); }

        function qlFilter() {
            var q = document.getElementById('qlSearchInput').value.toLowerCase().trim();
            var cb = document.getElementById('qlClear');
            var hint = document.getElementById('qlHint');
            if (cb) cb.classList.toggle('show', q.length > 0);
            if (hint) hint.classList.toggle('show', q.length > 0);
            var tiles = document.querySelectorAll('.ql-tile');
            var cards = document.querySelectorAll('.ql-sec-card');
            var nr = document.getElementById('qlNoResults');
            var fs = document.getElementById('qlFavSec');
            if (!q) {
                tiles.forEach(function(t) { t.classList.remove('ql-sh', 'ql-sm', 'ql-sm-first'); });
                cards.forEach(function(c) { c.classList.remove('ql-sh'); });
                if (nr) nr.classList.remove('show');
                if (fs) fs.style.display = '';
                qlRenderMasonry();
                return;
            }
            if (fs) fs.style.display = 'none';
            cards.forEach(function(c) {
                var g = c.querySelector('.ql-sec-list'); if (g) g.classList.remove('hidden');
                var hd = c.querySelector('.ql-sec-hdr'); if (hd) hd.classList.remove('collapsed');
            });
            var any = false, first = true;
            qlSelIdx = 0;
            tiles.forEach(function(t) {
                t.classList.remove('ql-sm-first');
                var n = t.getAttribute('data-n') || '', d = t.getAttribute('data-d') || '';
                if (n.indexOf(q) !== -1 || d.indexOf(q) !== -1) {
                    t.classList.remove('ql-sh'); t.classList.add('ql-sm'); any = true;
                    if (first) { t.classList.add('ql-sm-first'); first = false; }
                } else { t.classList.add('ql-sh'); t.classList.remove('ql-sm'); }
            });
            cards.forEach(function(c) {
                var v = c.querySelectorAll('.ql-tile:not(.ql-sh)');
                c.classList.toggle('ql-sh', v.length === 0);
            });
            if (nr) nr.classList.toggle('show', !any);
        }

        var qlSelIdx = 0;

        function qlKeyNav(e) {
            var visible = Array.from(document.querySelectorAll('.ql-tile.ql-sm'));
            if (!visible.length) return;
            if (e.key === 'Tab') {
                e.preventDefault();
                visible.forEach(function(t) { t.classList.remove('ql-sm-first'); });
                if (e.shiftKey) {
                    qlSelIdx = qlSelIdx > 0 ? qlSelIdx - 1 : visible.length - 1;
                } else {
                    qlSelIdx = qlSelIdx < visible.length - 1 ? qlSelIdx + 1 : 0;
                }
                visible[qlSelIdx].classList.add('ql-sm-first');
                visible[qlSelIdx].scrollIntoView({block:'nearest'});
            } else if (e.key === 'Enter') {
                e.preventDefault();
                var sel = document.querySelector('.ql-tile.ql-sm-first');
                if (sel) sel.click();
                else if (visible[0]) visible[0].click();
            } else if (e.key === 'Escape') {
                qlClearSearch();
                document.getElementById('qlSearchInput').blur();
            }
        }

        function qlLaunchFirst() {
            var f = document.querySelector('.ql-tile.ql-sm-first');
            if (f) f.click();
        }

        function qlClearSearch() {
            var inp = document.getElementById('qlSearchInput');
            if (inp) { inp.value = ''; qlFilter(); }
        }

        qlRenderAll();
        var qlResizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(qlResizeTimer);
            qlResizeTimer = setTimeout(qlRenderMasonry, 50);
        });
    </script>

    </div><!-- /container -->
</div><!-- /mainApp -->

<!-- TSI Entry Modal -->
<div class="tsi-modal-overlay" id="tsiModalOverlay">
  <div class="tsi-modal">
    <div class="tsi-modal-header">
      <h2 id="tsiModalTitle">New TSI Entry</h2>
      <button class="tsi-modal-close" onclick="closeTsiModal()">&times;</button>
    </div>
    <div class="tsi-modal-body">
      <div class="tsi-form-row">
        <div class="tsi-form-group tsi-tail-wrap" style="flex:0 0 55%;">
          <label class="tsi-form-label">TAIL NUMBER <span class="req">*</span></label>
          <input type="text" class="tsi-form-input" id="tFail" placeholder="Start typing tail..." autocomplete="off" oninput="tsiFilterTails()" onfocus="tsiFilterTails()" onkeydown="tsiTailKeyNav(event)">
          <div class="tsi-tail-dd" id="tsiTailDD"></div>
        </div>
        <div class="tsi-form-group">
          <label class="tsi-form-label">FLEET</label>
          <div class="tsi-form-display" id="tFleet">-</div>
          <input type="hidden" id="tFleetVal">
        </div>
      </div>

      <div class="tsi-form-row">
        <div class="tsi-form-group tsi-fc-wrap" style="flex:0 0 55%;">
          <label class="tsi-form-label">FAULT CODE <span class="req">*</span></label>
          <input type="text" class="tsi-form-input" id="tFaultCode" placeholder="e.g. 36-12020 or FAMV" autocomplete="off" oninput="tsiFilterFC()" onfocus="tsiFilterFC()" onkeydown="tsiFcKeyNav(event)">
          <div class="tsi-fc-dd" id="tsiFcDD"></div>
        </div>
        <div class="tsi-form-group">
          <label class="tsi-form-label">ATA</label>
          <div class="tsi-form-display" id="tAta">-</div>
        </div>
      </div>

      <div class="tsi-form-group">
        <label class="tsi-form-label">FLIGHT DECK EFFECT / DESCRIPTION <span class="req">*</span></label>
        <input type="text" class="tsi-form-input" id="tEffect" placeholder="e.g. BLEED FAMV L - Status Message">
      </div>

      <div class="tsi-form-group">
        <label class="tsi-form-label">WORK ORDER / TSI BARCODE</label>
        <input type="text" class="tsi-form-input" id="tWorkOrder" placeholder="e.g. TTG8Q01AL9VS">
      </div>

      <div class="tsi-form-group">
        <label class="tsi-form-label">AMM/FIM REFERENCE</label>
        <input type="text" class="tsi-form-input" id="tRef" placeholder="e.g. AMM 36-12-03">
      </div>

      <div class="tsi-form-group">
        <label class="tsi-form-label">TSI DETAILS / NOTES</label>
        <textarea class="tsi-form-textarea" id="tNotes" placeholder="Paste TSI verbiage or describe what was done..."></textarea>
      </div>

      <div class="tsi-form-group" id="tDueDateGroup">
        <label class="tsi-form-label">DUE DATE</label>
        <input type="date" class="tsi-form-input" id="tDueDate">
      </div>

      <div class="tsi-form-group" style="margin-top:4px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--text-secondary);">
          <input type="checkbox" id="tClosedHist" onchange="tsiToggleClosed()">
          Add as Closed (Historical Entry)
        </label>
      </div>

      <div id="tClosedFields" style="display:none;">
        <div class="tsi-form-group">
          <label class="tsi-form-label">ACTION TAKEN <span class="req">*</span></label>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <span class="fco-chip" onclick="tsiPickHistAction(this)">REMOVE/REPLACE</span>
            <span class="fco-chip" onclick="tsiPickHistAction(this)">REPAIR</span>
            <span class="fco-chip" onclick="tsiPickHistAction(this)">RESET/OPS CK</span>
            <span class="fco-chip" onclick="tsiPickHistAction(this)">NFF</span>
          </div>
          <input type="hidden" id="tHistAction">
        </div>
        <div class="tsi-form-group">
          <label class="tsi-form-label">CORRECTIVE ACTION <span class="req">*</span></label>
          <textarea class="tsi-form-textarea" id="tHistCorrective" placeholder="R/R #1 IASC P/N 1234, OPS CK SAT..."></textarea>
        </div>
      </div>

    </div>
    <div class="tsi-modal-footer">
      <button class="tsi-save-btn" onclick="closeTsiModal()">CANCEL</button>
      <button class="tsi-save-btn primary" id="tsiSaveBtn" onclick="saveTsiEntry()">SAVE</button>
    </div>
  </div>
</div>

<script>
// ---- TSI MODAL: AIRCRAFT + FAULT CODE DATA ----
var TSI_AIRCRAFT = [];
var TSI_FAULT_CODES = [];
var tsiTailHL = -1;
var tsiFcHL = -1;

function tsiParseCSVRow(line) {
  var result = [], cur = '', inQ = false;
  for (var i = 0; i < line.length; i++) {
    var c = line[i];
    if (inQ) {
      if (c === '"' && line[i+1] === '"') { cur += '"'; i++; }
      else if (c === '"') { inQ = false; }
      else { cur += c; }
    } else {
      if (c === '"') { inQ = true; }
      else if (c === ',') { result.push(cur); cur = ''; }
      else { cur += c; }
    }
  }
  result.push(cur);
  return result;
}

fetch('AircraftData.csv').then(function(r) { return r.ok ? r.text() : ''; }).then(function(text) {
  if (!text) return;
  var lines = text.split('\n');
  for (var i = 1; i < lines.length; i++) {
    var row = tsiParseCSVRow(lines[i]);
    if (row.length >= 2 && row[0].trim()) TSI_AIRCRAFT.push([row[0].trim(), row[1].trim()]);
  }
}).catch(function(){});

fetch('FaultCodes.csv').then(function(r) { return r.ok ? r.text() : ''; }).then(function(text) {
  if (!text) return;
  var lines = text.split('\n');
  for (var i = 1; i < lines.length; i++) {
    var row = tsiParseCSVRow(lines[i]);
    if (row.length >= 5 && row[0]) {
      TSI_FAULT_CODES.push({ code: row[0].trim(), fimTask: row[1].trim(), title: row[2].trim(), message: row[3].trim(), ata: row[4].trim() });
    }
  }
}).catch(function(){});

// ---- TSI MODAL: OPEN/CLOSE ----
var tsiEditId = null;

function openTsiModal(editId) {
  tsiClearForm();
  tsiEditId = editId || null;
  document.getElementById('tsiModalTitle').textContent = tsiEditId ? 'Edit TSI Entry' : 'New TSI Entry';
  document.getElementById('tsiSaveBtn').textContent = tsiEditId ? 'UPDATE' : 'SAVE';
  if (tsiEditId) {
    var entry = TSI_ENTRIES.find(function(e) { return e.id === tsiEditId; });
    if (entry) {
      document.getElementById('tFail').value = entry.tail || '';
      document.getElementById('tFleet').textContent = entry.fleet || '-';
      document.getElementById('tFleetVal').value = entry.fleet || '';
      document.getElementById('tFaultCode').value = entry.faultCode || '';
      document.getElementById('tAta').textContent = entry.ata || '-';
      document.getElementById('tEffect').value = entry.effect || '';
      document.getElementById('tWorkOrder').value = entry.workOrder || '';
      document.getElementById('tRef').value = entry.ref || '';
      document.getElementById('tNotes').value = entry.notes || '';
      document.getElementById('tDueDate').value = entry.dueDate || '';
      // If editing a closed entry, check the box and populate fields
      var isClosed = entry.status === 'closed_eff' || entry.status === 'closed_ineff';
      var cb = document.getElementById('tClosedHist');
      if (cb) { cb.checked = isClosed; tsiToggleClosed(); }
      if (isClosed && entry.actionType) {
        document.getElementById('tHistAction').value = entry.actionType;
        document.querySelectorAll('#tClosedFields .fco-chip').forEach(function(c) {
          if (c.textContent.trim() === entry.actionType) c.classList.add('selected');
        });
      }
      if (isClosed && entry.correctiveAction) {
        document.getElementById('tHistCorrective').value = entry.correctiveAction;
      }
    }
  }
  document.getElementById('tsiModalOverlay').classList.add('open');
  setTimeout(function() { document.getElementById('tFail').focus(); }, 100);
}

function closeTsiModal() {
  document.getElementById('tsiModalOverlay').classList.remove('open');
  document.getElementById('tsiTailDD').classList.remove('open');
  document.getElementById('tsiFcDD').classList.remove('open');
}

function tsiClearForm() {
  ['tFail','tFaultCode','tEffect','tWorkOrder','tNotes','tDueDate','tRef'].forEach(function(id) {
    document.getElementById(id).value = '';
  });
  document.getElementById('tFleet').textContent = '-';
  document.getElementById('tFleetVal').value = '';
  document.getElementById('tAta').textContent = '-';
  document.getElementById('tsiTailDD').classList.remove('open');
  document.getElementById('tsiFcDD').classList.remove('open');
  // Reset closed historical fields
  var cb = document.getElementById('tClosedHist');
  if (cb) cb.checked = false;
  tsiToggleClosed();
}

function tsiToggleClosed() {
  var checked = document.getElementById('tClosedHist').checked;
  document.getElementById('tClosedFields').style.display = checked ? 'block' : 'none';
  document.getElementById('tDueDateGroup').style.display = checked ? 'none' : 'block';
  if (!checked) {
    document.getElementById('tHistAction').value = '';
    var ta = document.getElementById('tHistCorrective');
    if (ta) ta.value = '';
    document.querySelectorAll('#tClosedFields .fco-chip').forEach(function(c) { c.classList.remove('selected'); });
  }
}

function tsiPickHistAction(el) {
  el.parentElement.querySelectorAll('.fco-chip').forEach(function(c) { c.classList.remove('selected'); });
  el.classList.add('selected');
  document.getElementById('tHistAction').value = el.textContent.trim();
}

// ---- TSI MODAL: TAIL AUTOCOMPLETE ----
function tsiFilterTails() {
  var q = document.getElementById('tFail').value.toUpperCase().trim();
  var dd = document.getElementById('tsiTailDD');
  if (!q) { dd.classList.remove('open'); return; }
  var matches = TSI_AIRCRAFT.filter(function(a) { return a[0].indexOf(q) !== -1; }).slice(0, 50);
  if (matches.length === 0) { dd.classList.remove('open'); return; }
  tsiTailHL = 0;
  var html = '';
  matches.forEach(function(a, i) {
    html += '<div class="tsi-tail-opt' + (i === 0 ? ' highlighted' : '') + '" onclick="tsiSelectTail(\'' + a[0] + '\',\'' + a[1] + '\')">';
    html += '<span class="tt-tail">' + a[0] + '</span><span class="tt-fleet">' + a[1] + '</span></div>';
  });
  dd.innerHTML = html;
  dd.classList.add('open');
}

function tsiSelectTail(tail, fleet) {
  document.getElementById('tFail').value = tail;
  document.getElementById('tFleet').textContent = fleet;
  document.getElementById('tFleetVal').value = fleet;
  document.getElementById('tsiTailDD').classList.remove('open');
  document.getElementById('tFaultCode').focus();
}

function tsiTailKeyNav(e) {
  var dd = document.getElementById('tsiTailDD');
  if (!dd.classList.contains('open')) return;
  var opts = dd.querySelectorAll('.tsi-tail-opt');
  if (!opts.length) return;
  if (e.key === 'ArrowDown') { e.preventDefault(); tsiTailHL = Math.min(tsiTailHL+1, opts.length-1); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); tsiTailHL = Math.max(tsiTailHL-1, 0); }
  else if (e.key === 'Enter') { e.preventDefault(); opts[tsiTailHL].click(); return; }
  else if (e.key === 'Escape') { dd.classList.remove('open'); return; }
  else return;
  opts.forEach(function(o, i) { o.classList.toggle('highlighted', i === tsiTailHL); });
  opts[tsiTailHL].scrollIntoView({block:'nearest'});
}

// ---- TSI MODAL: FAULT CODE AUTOCOMPLETE ----
function tsiFilterFC() {
  var q = document.getElementById('tFaultCode').value.trim().toUpperCase();
  var dd = document.getElementById('tsiFcDD');
  if (!q || q.length < 2 || TSI_FAULT_CODES.length === 0) { dd.classList.remove('open'); return; }
  var matches = TSI_FAULT_CODES.filter(function(f) {
    if (f.code.indexOf(q) === 0) return true;
    if (q.length >= 3 && (f.message.toUpperCase().indexOf(q) !== -1 || f.title.toUpperCase().indexOf(q) !== -1)) return true;
    return false;
  }).slice(0, 50);
  if (matches.length === 0) { dd.classList.remove('open'); return; }
  tsiFcHL = 0;
  var html = '';
  matches.forEach(function(f, i) {
    html += '<div class="tsi-fc-opt' + (i === 0 ? ' highlighted' : '') + '" data-idx="' + i + '" onclick="tsiSelectFC(' + i + ')">';
    html += '<span class="tfc-code">' + f.code + '</span>';
    if (f.message) html += '<span class="tfc-msg">' + f.message + '</span>';
    if (f.fimTask) html += '<span class="tfc-task">FIM: ' + f.fimTask + '</span>';
    html += '</div>';
  });
  dd.innerHTML = html;
  dd._matches = matches;
  dd.classList.add('open');
  tsiAutoFillATA();
}

function tsiSelectFC(idx) {
  var dd = document.getElementById('tsiFcDD');
  var f = dd._matches[idx];
  document.getElementById('tFaultCode').value = f.code;
  if (f.message || f.title) {
    var ef = document.getElementById('tEffect');
    ef.value = f.message || f.title;
    ef.setSelectionRange(0, 0);
    ef.scrollLeft = 0;
  }
  if (f.fimTask) document.getElementById('tRef').value = f.fimTask;
  tsiAutoFillATA();
  dd.classList.remove('open');
  document.getElementById('tEffect').focus();
  setTimeout(function() { document.getElementById('tEffect').setSelectionRange(0, 0); document.getElementById('tEffect').scrollLeft = 0; }, 0);
}

function tsiAutoFillATA() {
  var code = document.getElementById('tFaultCode').value.trim();
  var ataDiv = document.getElementById('tAta');
  var match = code.match(/^(\d{2})-/);
  ataDiv.textContent = match ? match[1] : '-';
}

function tsiFcKeyNav(e) {
  var dd = document.getElementById('tsiFcDD');
  if (!dd.classList.contains('open')) return;
  var opts = dd.querySelectorAll('.tsi-fc-opt');
  if (!opts.length) return;
  if (e.key === 'ArrowDown') { e.preventDefault(); tsiFcHL = Math.min(tsiFcHL+1, opts.length-1); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); tsiFcHL = Math.max(tsiFcHL-1, 0); }
  else if (e.key === 'Enter') { e.preventDefault(); tsiSelectFC(tsiFcHL); return; }
  else if (e.key === 'Escape') { dd.classList.remove('open'); return; }
  else return;
  opts.forEach(function(o, i) { o.classList.toggle('highlighted', i === tsiFcHL); });
  opts[tsiFcHL].scrollIntoView({block:'nearest'});
}

// ---- TSI MODAL: SAVE ----
function saveTsiEntry() {
  var tail = document.getElementById('tFail').value.trim().toUpperCase();
  var fleet = document.getElementById('tFleetVal').value.trim();
  var faultCode = document.getElementById('tFaultCode').value.trim().toUpperCase();
  var effect = document.getElementById('tEffect').value.trim().toUpperCase();
  var isClosed = document.getElementById('tClosedHist').checked;

  if (!tail) { tsiToast('Tail number is required'); document.getElementById('tFail').focus(); return; }
  if (!faultCode) { tsiToast('Fault code is required'); document.getElementById('tFaultCode').focus(); return; }
  if (!effect) { tsiToast('Flight deck effect is required'); document.getElementById('tEffect').focus(); return; }

  if (isClosed) {
    var histAction = document.getElementById('tHistAction').value;
    var histCorr = document.getElementById('tHistCorrective').value.trim().toUpperCase();
    if (!histAction) { tsiToast('Action taken is required for closed entries'); return; }
    if (!histCorr) { tsiToast('Corrective action is required for closed entries'); return; }
  }

  // Auto-fill fleet from aircraft data
  if (!fleet) {
    var match = TSI_AIRCRAFT.find(function(a) { return a[0] === tail; });
    if (match) fleet = match[1];
  }
  if (!fleet) { tsiToast('Fleet could not be determined - select a valid tail'); return; }

  // Normalize fault code for storage
  var fcNorm = normalizeFaultCode(faultCode);
  var ataMatch = faultCode.match(/^(\d{2})/);
  var ata = ataMatch ? ataMatch[1] : '';

  var entry = {
    tail: tail,
    fleet: fleet,
    ata: ata,
    faultCode: fcNorm || faultCode,
    effect: effect,
    workOrder: document.getElementById('tWorkOrder').value.trim().toUpperCase(),
    actionType: isClosed ? document.getElementById('tHistAction').value : '',
    correctiveAction: isClosed ? document.getElementById('tHistCorrective').value.trim().toUpperCase() : '',
    notes: document.getElementById('tNotes').value.trim().toUpperCase(),
    dueDate: isClosed ? '' : document.getElementById('tDueDate').value,
    ref: document.getElementById('tRef').value.trim().toUpperCase(),
    status: isClosed ? 'closed_eff' : 'in_work',
    created: new Date().toISOString(),
    closedDate: isClosed ? new Date().toISOString() : null,
    createdBy: CURRENT_USER ? CURRENT_USER.enumVal : '',
    createdByName: CURRENT_USER ? CURRENT_USER.name : ''
  };

  // Save to Firestore
  if (tsiEditId) {
    // Edit mode - update existing entry
    db.collection('tsi_entries').doc(tsiEditId).update({
      tail: tail, fleet: fleet, ata: ata, faultCode: fcNorm || faultCode, effect: effect,
      workOrder: document.getElementById('tWorkOrder').value.trim().toUpperCase(),
      notes: document.getElementById('tNotes').value.trim().toUpperCase(),
      dueDate: isClosed ? '' : document.getElementById('tDueDate').value,
      ref: document.getElementById('tRef').value.trim().toUpperCase(),
      updatedAt: new Date().toISOString(),
      updatedByName: CURRENT_USER ? CURRENT_USER.name : ''
    }).then(function() {
      closeTsiModal();
      loadTsiEntries();
      tsiToast('TSI entry updated');
    }).catch(function(err) {
      tsiToast('Error updating entry. Try again.');
    });
  } else {
    // Create mode - new entry
    db.collection('tsi_entries').add(entry).then(function() {
      closeTsiModal();
      loadTsiEntries();
      tsiToast(isClosed ? 'TSI added as closed' : 'TSI entry added - IN WORK');
    }).catch(function(err) {
      tsiToast('Error saving entry. Try again.');
    });
  }
}

function tsiToast(msg) {
  var t = document.createElement('div');
  t.className = 'tsi-toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(function() { t.style.opacity = '0'; setTimeout(function() { t.remove(); }, 300); }, 2500);
}

// Close dropdowns on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.tsi-tail-wrap')) document.getElementById('tsiTailDD').classList.remove('open');
  if (!e.target.closest('.tsi-fc-wrap')) document.getElementById('tsiFcDD').classList.remove('open');
});
</script>

<script>
/* ---- LIVE CLOCK (UTC/CST with analog toggle) ---- */
function _cp(n) { return n < 10 ? '0' + n : n; }

function toggleUtcClock() {
  var el = document.getElementById('utcBlock');
  if (!el) return;
  el.classList.toggle('analog-mode');
  try { localStorage.setItem('moc_clock_analog', el.classList.contains('analog-mode') ? '1' : '0'); } catch(e) {}
}

// Restore preference
try { if (localStorage.getItem('moc_clock_analog') === '1') { document.getElementById('utcBlock').classList.add('analog-mode'); } } catch(e) {}

var SWA_ORANGE = '#e8600a';
var SWA_RED = '#c8102e';

function _drawSwordHand(ctx, cx, cy, angle, length, baseWidth, tipWidth, tailLen) {
  var rad = (angle - 90) * Math.PI / 180;
  var perpRad = rad + Math.PI / 2;
  var tipX = cx + Math.cos(rad) * length;
  var tipY = cy + Math.sin(rad) * length;
  var bx1 = cx + Math.cos(perpRad) * baseWidth;
  var by1 = cy + Math.sin(perpRad) * baseWidth;
  var bx2 = cx - Math.cos(perpRad) * baseWidth;
  var by2 = cy - Math.sin(perpRad) * baseWidth;
  var shoulderDist = length * 0.65;
  var shoulderWidth = baseWidth * 0.8;
  var sx1 = cx + Math.cos(rad) * shoulderDist + Math.cos(perpRad) * shoulderWidth;
  var sy1 = cy + Math.sin(rad) * shoulderDist + Math.sin(perpRad) * shoulderWidth;
  var sx2 = cx + Math.cos(rad) * shoulderDist - Math.cos(perpRad) * shoulderWidth;
  var sy2 = cy + Math.sin(rad) * shoulderDist - Math.sin(perpRad) * shoulderWidth;
  var tailX = cx - Math.cos(rad) * tailLen;
  var tailY = cy - Math.sin(rad) * tailLen;
  var tx1 = tailX + Math.cos(perpRad) * (baseWidth * 0.6);
  var ty1 = tailY + Math.sin(perpRad) * (baseWidth * 0.6);
  var tx2 = tailX - Math.cos(perpRad) * (baseWidth * 0.6);
  var ty2 = tailY - Math.sin(perpRad) * (baseWidth * 0.6);
  ctx.beginPath();
  ctx.moveTo(tx1, ty1); ctx.lineTo(bx1, by1); ctx.lineTo(sx1, sy1);
  ctx.lineTo(tipX, tipY); ctx.lineTo(sx2, sy2); ctx.lineTo(bx2, by2);
  ctx.lineTo(tx2, ty2); ctx.closePath();
  ctx.fillStyle = '#d0d8e8'; ctx.fill();
  ctx.strokeStyle = '#8899aa'; ctx.lineWidth = 0.8; ctx.stroke();
  var sw = baseWidth * 0.4; var ssw = sw * 0.7;
  var csb1x = cx + Math.cos(perpRad) * sw, csb1y = cy + Math.sin(perpRad) * sw;
  var csb2x = cx - Math.cos(perpRad) * sw, csb2y = cy - Math.sin(perpRad) * sw;
  var css1x = cx + Math.cos(rad) * shoulderDist + Math.cos(perpRad) * ssw;
  var css1y = cy + Math.sin(rad) * shoulderDist + Math.sin(perpRad) * ssw;
  var css2x = cx + Math.cos(rad) * shoulderDist - Math.cos(perpRad) * ssw;
  var css2y = cy + Math.sin(rad) * shoulderDist - Math.sin(perpRad) * ssw;
  var stD = length * 0.92;
  var stX = cx + Math.cos(rad) * stD, stY = cy + Math.sin(rad) * stD;
  ctx.beginPath();
  ctx.moveTo(csb1x, csb1y); ctx.lineTo(css1x, css1y); ctx.lineTo(stX, stY);
  ctx.lineTo(css2x, css2y); ctx.lineTo(csb2x, csb2y); ctx.closePath();
  ctx.fillStyle = '#ffffff'; ctx.fill();
}

function _drawUtcClock(pxSize) {
  var canvas = document.getElementById('utcCanvas');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var s = pxSize, r = s / 2;
  var now = new Date();
  var utcH = now.getUTCHours(), utcM = now.getUTCMinutes(), utcS = now.getUTCSeconds(), utcMs = now.getUTCMilliseconds();
  var secFrac = utcS + utcMs / 1000;
  ctx.clearRect(0, 0, s, s);
  // Face
  ctx.beginPath(); ctx.arc(r, r, r - 2, 0, Math.PI * 2);
  ctx.fillStyle = '#141f33'; ctx.fill();
  ctx.strokeStyle = SWA_ORANGE; ctx.lineWidth = 3.5; ctx.stroke();
  // Triangle at 00
  var triOuter = r - 7, triInner = r - 28, triHW = 7;
  ctx.beginPath();
  ctx.moveTo(r, r - triInner); ctx.lineTo(r - triHW, r - triOuter); ctx.lineTo(r + triHW, r - triOuter);
  ctx.closePath(); ctx.fillStyle = '#ffffff'; ctx.fill();
  // 24 ticks (skip 0)
  for (var i = 1; i < 24; i++) {
    var a = (i * 15 - 90) * Math.PI / 180;
    var isMaj = (i % 3 === 0);
    var oR = r - 9, iR = isMaj ? r - 26 : r - 18;
    ctx.beginPath();
    ctx.moveTo(r + Math.cos(a) * iR, r + Math.sin(a) * iR);
    ctx.lineTo(r + Math.cos(a) * oR, r + Math.sin(a) * oR);
    ctx.strokeStyle = '#ffffff'; ctx.lineWidth = isMaj ? 2.5 : 1.5; ctx.stroke();
  }
  // Lume dots on major ticks (skip 0)
  for (var ld = 3; ld < 24; ld += 3) {
    var la = (ld * 15 - 90) * Math.PI / 180;
    var lr = r - 9;
    ctx.beginPath(); ctx.arc(r + Math.cos(la) * lr, r + Math.sin(la) * lr, 3, 0, Math.PI * 2);
    ctx.fillStyle = '#e8edf5'; ctx.fill();
    ctx.strokeStyle = '#8899aa'; ctx.lineWidth = 0.5; ctx.stroke();
  }
  // Numbers every 3hrs
  var fs = Math.max(Math.round(s * 0.065), 14);
  ctx.font = '700 ' + fs + 'px "JetBrains Mono", monospace';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#ffffff';
  for (var h = 0; h < 24; h += 3) {
    var ha = (h * 15 - 90) * Math.PI / 180;
    var lr2 = r - 42;
    ctx.fillText(_cp(h), r + Math.cos(ha) * lr2, r + Math.sin(ha) * lr2);
  }
  // Hour hand
  _drawSwordHand(ctx, r, r, (utcH + utcM / 60) * 15, r * 0.38, 6, 2, 10);
  // Minute hand
  _drawSwordHand(ctx, r, r, (utcM + secFrac / 60) * 6, r * 0.58, 4.5, 1.5, 10);
  // Second hand - smooth sweep
  var sDeg = secFrac * 6 - 90;
  var sRad = sDeg * Math.PI / 180;
  ctx.beginPath();
  ctx.moveTo(r - Math.cos(sRad) * 14, r - Math.sin(sRad) * 14);
  ctx.lineTo(r + Math.cos(sRad) * (r * 0.65), r + Math.sin(sRad) * (r * 0.65));
  ctx.strokeStyle = SWA_RED; ctx.lineWidth = 1.5; ctx.lineCap = 'round'; ctx.stroke();
  // Center cap
  ctx.beginPath(); ctx.arc(r, r, 6, 0, Math.PI * 2);
  ctx.fillStyle = '#2a3a55'; ctx.fill(); ctx.strokeStyle = '#8899aa'; ctx.lineWidth = 1; ctx.stroke();
  ctx.beginPath(); ctx.arc(r, r, 3, 0, Math.PI * 2); ctx.fillStyle = SWA_RED; ctx.fill();
}

var _clockDigLast = 0;
function _clockTick() {
  _drawUtcClock(280);
  var now = Date.now();
  if (now - _clockDigLast >= 1000) {
    _clockDigLast = now;
    var d = new Date();
    var utcH = d.getUTCHours(), utcM = d.getUTCMinutes();
    var cstH = (utcH - 6 + 24) % 24;
    var cst = _cp(cstH) + ':' + _cp(utcM);
    var utc = _cp(utcH) + ':' + _cp(utcM);
    var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    document.getElementById('cstTime').textContent = cst;
    document.getElementById('utcDigital').textContent = utc;
    document.getElementById('cstDay').textContent = days[d.getUTCDay()];
    document.getElementById('cstDate').textContent = _cp(d.getUTCDate()) + '-' + months[d.getUTCMonth()] + '-' + d.getUTCFullYear();
    document.getElementById('utcAnalog').textContent = utc + 'Z';
  }
  requestAnimationFrame(_clockTick);
}
_clockTick();
</script>
</body>
</html>
